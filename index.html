<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOCALIZADOR - NOTIFICACIONES Y CORREOS</title>
    
    <!-- Leaflet CSS y JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Leaflet Geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f172a; color: white; }
        
        /* HEADER */
        .header { 
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            color: white; padding: 25px 20px; text-align: center;
            border-bottom: 4px solid #3b82f6;
        }
        .logo { font-size: 3.5rem; margin-bottom: 15px; }
        h1 { font-size: 2rem; margin-bottom: 10px; font-weight: 800; }
        
        /* NOTIFICACIONES FLOTANTES */
        .notification-bell {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc2626;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            animation: bell-ring 2s infinite;
        }
        @keyframes bell-ring {
            0%, 100% { transform: rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
            20%, 40%, 60%, 80% { transform: rotate(10deg); }
        }
        
        .notification-panel {
            position: fixed;
            top: 90px;
            right: 20px;
            width: 350px;
            background: white;
            color: #1f2937;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 9999;
            display: none;
            max-height: 500px;
            overflow-y: auto;
        }
        .notification-panel h3 {
            background: #1e40af;
            color: white;
            padding: 15px;
            margin: 0;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s;
        }
        .notification-item:hover {
            background: #f8fafc;
        }
        .notification-item.unread {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        .notification-time {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 5px;
        }
        
        /* NOTIFICACI√ìN EMERGENTE (TOAST) */
        .toast-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(220, 38, 38, 0.4);
            z-index: 10001;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 400px;
            opacity: 0;
            transition: all 0.5s ease;
        }
        .toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast-notification .bell-icon {
            font-size: 1.8rem;
            animation: ring 0.5s ease-in-out;
        }
        @keyframes ring {
            0%, 100% { transform: rotate(0); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }
        
        /* CONFIGURACI√ìN DE NOTIFICACIONES */
        .notification-settings {
            background: white;
            color: #1f2937;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .settings-group {
            margin-bottom: 20px;
        }
        .settings-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #1e40af;
        }
        .settings-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }
        .settings-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        /* M√ÅS ESTILOS... (mant√©n los mismos estilos anteriores) */
        .tabs {
            display: flex; background: white; overflow-x: auto;
            border-bottom: 3px solid #e2e8f0; position: sticky; top: 0; z-index: 1000;
        }
        .tab {
            flex: 1; padding: 20px 15px; border: none; background: white;
            color: #4a5568; font-weight: bold; text-align: center;
            min-width: 120px; cursor: pointer; transition: all 0.3s ease;
        }
        .tab.active {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white; border-bottom: 3px solid #fbbf24;
        }
        
        #mapa-leaflet {
            height: 600px; width: 100%; border-radius: 12px;
            margin: 20px 0; border: 3px solid #e5e7eb;
            z-index: 1;
        }
        
        .content { padding: 25px; max-width: 1400px; margin: 0 auto; }
        .card {
            background: white; color: #1f2937; border-radius: 16px;
            padding: 30px; margin-bottom: 25px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }
        
        .robo-alert {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 6px solid #dc2626; padding: 25px; margin-bottom: 20px;
            border-radius: 12px; transition: all 0.3s; cursor: pointer;
        }
        
        .map-controls {
            display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap;
        }
        .control-btn {
            padding: 14px 25px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white; border: none; border-radius: 10px; cursor: pointer;
            font-weight: bold; transition: all 0.3s; display: flex; align-items: center; gap: 10px;
        }
        
        .search-box { display: flex; gap: 15px; margin-bottom: 20px; }
        .search-input { flex: 1; padding: 16px 20px; border: 2px solid #e5e7eb; border-radius: 10px; }
        
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px; margin: 30px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white; padding: 30px; border-radius: 16px; text-align: center;
        }
        
        /* SONIDO VISUAL */
        .sound-wave {
            position: fixed;
            bottom: 20px;
            right: 100px;
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        .wave-bar {
            width: 4px;
            background: #3b82f6;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 20px; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 25px; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 20px; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; height: 15px; }
        @keyframes wave {
            0%, 100% { height: 15px; }
            50% { height: 25px; }
        }
        
        @media (max-width: 768px) {
            .notification-panel { width: 90%; right: 5%; }
            .toast-notification { min-width: 90%; }
        }
    </style>
</head>
<body>
    <!-- CAMPANA DE NOTIFICACIONES -->
    <div class="notification-bell" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span class="notification-count" id="notificationCount" style="
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        ">0</span>
    </div>
    
    <!-- PANEL DE NOTIFICACIONES -->
    <div class="notification-panel" id="notificationPanel">
        <h3>
            <span>üîî Notificaciones</span>
            <button onclick="clearAllNotifications()" style="
                background: #ef4444;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.8rem;
            ">
                Limpiar todas
            </button>
        </h3>
        <div id="notificationsList">
            <!-- Notificaciones aparecer√°n aqu√≠ -->
        </div>
    </div>
    
    <!-- NOTIFICACI√ìN TOAST -->
    <div class="toast-notification" id="toastNotification">
        <div class="bell-icon">
            <i class="fas fa-bell"></i>
        </div>
        <div>
            <h4 style="margin: 0 0 5px 0;" id="toastTitle">Nuevo robo reportado</h4>
            <p style="margin: 0;" id="toastMessage">Se ha reportado un nuevo incidente</p>
        </div>
        <button onclick="closeToast()" style="
            background: transparent;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: auto;
        ">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- VISUALIZADOR DE SONIDO -->
    <div class="sound-wave" id="soundWave" style="display: none;">
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <span style="font-size: 0.9rem; margin-left: 5px;">üîî Sonando...</span>
    </div>

    <!-- APP CONTAINER -->
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo">üö®üîî</div>
            <h1>LOCALIZADOR CON NOTIFICACIONES</h1>
            <p class="subtitle">Alertas con sonido + Correos autom√°ticos + Avisos en pantalla</p>
            <div style="margin-top: 20px; font-size: 1rem;">
                <span id="estado-conexion">‚úÖ Conectado</span> | 
                <span id="hora-actual">--:--</span> |
                <span id="notificaciones-activas">üîî 0 activas</span>
            </div>
        </div>
        
        <!-- NAVEGACI√ìN -->
        <div class="tabs">
            <button class="tab active" onclick="mostrarSeccion('inicio')">üè† Inicio</button>
            <button class="tab" onclick="mostrarSeccion('mapa')">üó∫Ô∏è Mapa</button>
            <button class="tab" onclick="mostrarSeccion('robos')">üö® Robos</button>
            <button class="tab" onclick="mostrarSeccion('notificaciones')">üîî Configurar</button>
            <button class="tab" onclick="mostrarSeccion('agenda')">üìÖ Agenda</button>
        </div>
        
        <!-- CONTENIDO -->
        <div class="content">
            <!-- SECCI√ìN INICIO -->
            <div id="inicio" class="seccion">
                <div class="card">
                    <h2 class="card-title">üö®üîî SISTEMA DE NOTIFICACIONES</h2>
                    <p>Recibe alertas con sonido de campana, avisos en pantalla y correos autom√°ticos</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-notificaciones">0</div>
                            <div class="stat-label">Notificaciones hoy</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);">
                            <div class="stat-number" id="robos-hoy">0</div>
                            <div class="stat-label">Robos reportados</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                            <div class="stat-number" id="correos-enviados">0</div>
                            <div class="stat-label">Correos enviados</div>
                        </div>
                    </div>
                    
                    <div class="map-controls">
                        <button class="control-btn" onclick="testNotification()">
                            <span>üîî</span> Probar Notificaci√≥n
                        </button>
                        <button class="control-btn secondary" onclick="testEmail()">
                            <span>üìß</span> Probar Correo
                        </button>
                        <button class="control-btn warning" onclick="simularNuevoRobo()">
                            <span>üö®</span> Simular Robo
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN MAPA -->
            <div id="mapa" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üó∫Ô∏è MAPA EN TIEMPO REAL</h2>
                    
                    <div id="mapa-leaflet"></div>
                    
                    <div class="map-controls">
                        <button class="control-btn" onclick="obtenerUbicacionActual()">
                            <span>üìç</span> Mi Ubicaci√≥n
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN ROBOS -->
            <div id="robos" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üö® REPORTAR NUEVO ROBO</h2>
                    <p>Al reportar un robo se enviar√°n notificaciones autom√°ticas</p>
                    
                    <div class="search-box">
                        <input type="text" id="direccion-robo" placeholder="Direcci√≥n exacta del robo..." class="search-input">
                        <select id="tipo-robo" class="search-input" style="max-width: 200px;">
                            <option value="robo">Robo</option>
                            <option value="intento">Intento de robo</option>
                            <option value="allanamiento">Allanamiento</option>
                            <option value="vandalismo">Vandalismo</option>
                        </select>
                    </div>
                    
                    <textarea id="detalles-robo" placeholder="Detalles del incidente..." rows="4" class="search-input" style="margin-bottom: 20px;"></textarea>
                    
                    <div class="map-controls">
                        <button class="control-btn danger" onclick="reportarRoboConNotificacion()">
                            <span>üö®üîî</span> Reportar con Notificaciones
                        </button>
                    </div>
                    
                    <!-- HISTORIAL DE ROBOS -->
                    <div style="margin-top: 40px;">
                        <h3 style="color: #dc2626; margin-bottom: 20px;">üìã Historial de Robos</h3>
                        <div id="historial-robos">
                            <!-- Los robos aparecer√°n aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CONFIGURACI√ìN DE NOTIFICACIONES -->
            <div id="notificaciones" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üîî CONFIGURAR NOTIFICACIONES</h2>
                    
                    <div class="notification-settings">
                        <h3 style="color: #1e40af; margin-bottom: 25px;">üìß Configuraci√≥n de Correos</h3>
                        
                        <div class="settings-group">
                            <label for="email-destino">
                                <i class="fas fa-envelope"></i> Correo de destino
                            </label>
                            <input type="email" id="email-destino" value="avisosderobos@gmail.com" placeholder="correo@ejemplo.com">
                        </div>
                        
                        <div class="settings-group">
                            <label for="email-asunto">
                                <i class="fas fa-tag"></i> Asunto del correo
                            </label>
                            <input type="text" id="email-asunto" value="üö® NUEVO ROBO REPORTADO - Sistema de Alarmas">
                        </div>
                        
                        <div class="settings-group">
                            <label>
                                <i class="fas fa-bell"></i> Sonido de notificaci√≥n
                            </label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="sonido" value="campana" checked> 
                                    <span>üîî Campana</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="sonido" value="alerta"> 
                                    <span>üö® Alerta</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="sonido" value="ninguno"> 
                                    <span>üîá Sin sonido</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="settings-group">
                            <label>
                                <i class="fas fa-eye"></i> Mostrar notificaciones
                            </label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="mostrar-toast" checked> 
                                    <span>üì± Toast en pantalla</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="mostrar-panel" checked> 
                                    <span>üìã Panel de notificaciones</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="enviar-email" checked> 
                                    <span>üìß Enviar correo</span>
                                </label>
                            </div>
                        </div>
                        
                        <button class="control-btn" onclick="guardarConfiguracion()" style="width: 100%; margin-top: 20px;">
                            <span>üíæ</span> Guardar Configuraci√≥n
                        </button>
                    </div>
                    
                    <!-- ESTADO DEL SISTEMA -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 30px;">
                        <h3 style="color: #1e40af; margin-bottom: 15px;">üìä Estado del Sistema</h3>
                        <div id="estado-sistema">
                            <p><strong>üîî Notificaciones:</strong> <span id="estado-notificaciones">‚úÖ Activadas</span></p>
                            <p><strong>üìß Correo configurado:</strong> <span id="estado-correo">avisosderobos@gmail.com</span></p>
                            <p><strong>üîä Sonido:</strong> <span id="estado-sonido">üîî Campana</span></p>
                            <p><strong>üì± Toast:</strong> <span id="estado-toast">‚úÖ Activado</span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN AGENDA -->
            <div id="agenda" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üìÖ AGENDA Y VISITAS</h2>
                    <p>Las visitas tambi√©n pueden generar notificaciones</p>
                    
                    <div id="lista-agenda">
                        <!-- Agenda aparecer√° aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FOOTER -->
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: #cbd5e1; padding: 30px; text-align: center; margin-top: 40px;">
            <p>Sistema de notificaciones con sonido y correos | avisosderobos@gmail.com</p>
        </div>
    </div>

    <!-- JAVASCRIPT COMPLETO -->
    <script>
        // ===== VARIABLES GLOBALES =====
        let mapaLeaflet;
        let notificaciones = [];
        let robos = [];
        let configuracion = {
            emailDestino: 'avisosderobos@gmail.com',
            emailAsunto: 'üö® NUEVO ROBO REPORTADO - Sistema de Alarmas',
            sonido: 'campana',
            mostrarToast: true,
            mostrarPanel: true,
            enviarEmail: true
        };
        
        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            inicializarSistema();
            cargarConfiguracion();
            cargarNotificaciones();
            actualizarContadorNotificaciones();
            mostrarEstadoSistema();
            
            // Simular primer robo de prueba despu√©s de 3 segundos
            setTimeout(() => {
                if (robos.length === 0) {
                    simularNuevoRoboAutomatico();
                }
            }, 3000);
        });
        
        function inicializarSistema() {
            actualizarHora();
            
            // Cargar robos desde localStorage
            try {
                const robosGuardados = localStorage.getItem('localizador_robos');
                if (robosGuardados) {
                    robos = JSON.parse(robosGuardados);
                    cargarHistorialRobos();
                }
            } catch (e) {
                console.error('Error cargando robos:', e);
            }
            
            // Actualizar estad√≠sticas
            actualizarEstadisticas();
        }
        
        // ===== NOTIFICACIONES =====
        function mostrarNotificacion(titulo, mensaje, tipo = 'info') {
            const id = Date.now();
            const notificacion = {
                id: id,
                titulo: titulo,
                mensaje: mensaje,
                tipo: tipo,
                fecha: new Date(),
                leida: false
            };
            
            // A√±adir a la lista
            notificaciones.unshift(notificacion);
            
            // Guardar en localStorage
            guardarNotificaciones();
            
            // Actualizar contador
            actualizarContadorNotificaciones();
            
            // Mostrar seg√∫n configuraci√≥n
            if (configuracion.mostrarToast) {
                mostrarToastNotificacion(titulo, mensaje);
            }
            
            if (configuracion.mostrarPanel) {
                actualizarPanelNotificaciones();
            }
            
            // Reproducir sonido
            reproducirSonidoNotificacion();
            
            // Enviar correo si est√° configurado
            if (configuracion.enviarEmail && tipo === 'robo') {
                enviarCorreoNotificacion(titulo, mensaje);
            }
            
            // Vibrar si est√° disponible
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
            
            return id;
        }
        
        function mostrarToastNotificacion(titulo, mensaje) {
            const toast = document.getElementById('toastNotification');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            toastTitle.textContent = titulo;
            toastMessage.textContent = mensaje;
            
            // Mostrar toast
            toast.classList.add('show');
            
            // Ocultar autom√°ticamente despu√©s de 5 segundos
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }
        
        function closeToast() {
            document.getElementById('toastNotification').classList.remove('show');
        }
        
        function actualizarPanelNotificaciones() {
            const lista = document.getElementById('notificationsList');
            if (!lista) return;
            
            let html = '';
            const notificacionesMostrar = notificaciones.slice(0, 10); // Mostrar solo las 10 m√°s recientes
            
            if (notificacionesMostrar.length === 0) {
                html = '<div style="padding: 20px; text-align: center; color: #6b7280;">No hay notificaciones</div>';
            } else {
                notificacionesMostrar.forEach(notif => {
                    const color = notif.tipo === 'robo' ? '#dc2626' : 
                                 notif.tipo === 'alerta' ? '#f59e0b' : '#3b82f6';
                    
                    html += `
                        <div class="notification-item ${notif.leida ? '' : 'unread'}" 
                             onclick="marcarNotificacionLeida(${notif.id})" 
                             style="border-left: 4px solid ${color};">
                            <div style="font-weight: bold; color: ${color};">
                                ${notif.tipo === 'robo' ? 'üö®' : 'üîî'} ${notif.titulo}
                            </div>
                            <div style="margin: 5px 0;">${notif.mensaje}</div>
                            <div class="notification-time">
                                ${formatearTiempoRelativo(notif.fecha)}
                            </div>
                        </div>
                    `;
                });
            }
            
            lista.innerHTML = html;
        }
        
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
                actualizarPanelNotificaciones();
            }
        }
        
        function marcarNotificacionLeida(id) {
            const notificacion = notificaciones.find(n => n.id === id);
            if (notificacion) {
                notificacion.leida = true;
                guardarNotificaciones();
                actualizarContadorNotificaciones();
                actualizarPanelNotificaciones();
            }
        }
        
        function clearAllNotifications() {
            if (confirm('¬øEst√°s seguro de eliminar todas las notificaciones?')) {
                notificaciones = [];
                guardarNotificaciones();
                actualizarContadorNotificaciones();
                actualizarPanelNotificaciones();
                mostrarNotificacion('üóëÔ∏è Notificaciones limpiadas', 'Todas las notificaciones han sido eliminadas');
            }
        }
        
        function actualizarContadorNotificaciones() {
            const count = notificaciones.filter(n => !n.leida).length;
            document.getElementById('notificationCount').textContent = count;
            
            // Actualizar en header
            document.getElementById('notificaciones-activas').textContent = `üîî ${count} activas`;
            document.getElementById('total-notificaciones').textContent = notificaciones.length;
        }
        
        function guardarNotificaciones() {
            try {
                localStorage.setItem('localizador_notificaciones', JSON.stringify(notificaciones));
            } catch (e) {
                console.error('Error guardando notificaciones:', e);
            }
        }
        
        function cargarNotificaciones() {
            try {
                const notificacionesGuardadas = localStorage.getItem('localizador_notificaciones');
                if (notificacionesGuardadas) {
                    notificaciones = JSON.parse(notificacionesGuardadas);
                    notificaciones.forEach(n => n.fecha = new Date(n.fecha));
                }
            } catch (e) {
                console.error('Error cargando notificaciones:', e);
            }
        }
        
        // ===== SONIDOS =====
        function reproducirSonidoNotificacion() {
            if (configuracion.sonido === 'ninguno') return;
            
            // Mostrar visualizador de sonido
            const soundWave = document.getElementById('soundWave');
            soundWave.style.display = 'flex';
            
            // Crear audio
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            if (configuracion.sonido === 'campana') {
                // Sonido de campana
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                // Envolvente ADSR para sonido de campana
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.5);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 1.5);
                
            } else if (configuracion.sonido === 'alerta') {
                // Sonido de alerta
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 1000;
                oscillator.type = 'sawtooth';
                
                // Tres pulsos r√°pidos
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + 0.3);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + 0.6);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.8);
            }
            
            // Ocultar visualizador despu√©s del sonido
            setTimeout(() => {
                soundWave.style.display = 'none';
            }, 2000);
        }
        
        // ===== CORREOS =====
        function enviarCorreoNotificacion(titulo, mensaje) {
            const email = configuracion.emailDestino;
            const asunto = encodeURIComponent(configuracion.emailAsunto);
            const cuerpo = encodeURIComponent(
                `üö® NUEVA NOTIFICACI√ìN DEL SISTEMA DE ALARMAS\n\n` +
                `üìã ${titulo}\n\n` +
                `üìù Detalles:\n${mensaje}\n\n` +
                `üìç Fecha: ${new Date().toLocaleString('es-ES')}\n` +
                `üîó Sistema: Localizador de Ventas de Alarmas\n\n` +
                `---\n` +
                `Este es un correo autom√°tico. No responder.`
            );
            
            // Usar mailto para enviar correo
            const mailtoLink = `mailto:${email}?subject=${asunto}&body=${cuerpo}`;
            
            // Intentar abrir el cliente de correo
            try {
                window.open(mailtoLink, '_blank');
                
                // Incrementar contador
                const contador = parseInt(document.getElementById('correos-enviados').textContent) || 0;
                document.getElementById('correos-enviados').textContent = contador + 1;
                
                // Guardar en estad√≠sticas
                guardarEstadistica('correos_enviados', contador + 1);
                
                // Mostrar notificaci√≥n de √©xito
                mostrarNotificacion('üìß Correo preparado', 'Se abrir√° tu cliente de correo para enviar la alerta', 'info');
                
            } catch (e) {
                console.error('Error abriendo cliente de correo:', e);
                mostrarNotificacion('‚ùå Error correo', 'No se pudo abrir el cliente de correo', 'alerta');
            }
        }
        
        // ===== GESTI√ìN DE ROBOS =====
        function reportarRoboConNotificacion() {
            const direccion = document.getElementById('direccion-robo').value;
            const tipo = document.getElementById('tipo-robo').value;
            const detalles = document.getElementById('detalles-robo').value;
            
            if (!direccion.trim()) {
                mostrarNotificacion('‚ö†Ô∏è Campo vac√≠o', 'Escribe una direcci√≥n v√°lida', 'alerta');
                return;
            }
            
            // Crear nuevo robo
            const nuevoRobo = {
                id: Date.now(),
                direccion: direccion,
                tipo: tipo,
                detalles: detalles,
                fecha: new Date(),
                prioridad: 'alta',
                coordenadas: [37.8882 + (Math.random() - 0.5) * 0.1, -4.7794 + (Math.random() - 0.5) * 0.1]
            };
            
            // A√±adir a la lista
            robos.unshift(nuevoRobo);
            
            // Guardar en localStorage
            guardarRobos();
            
            // Actualizar interfaz
            cargarHistorialRobos();
            actualizarEstadisticas();
            
            // Crear mensaje para notificaci√≥n
            const mensajeNotificacion = `${direccion}\nTipo: ${tipo}\n${detalles}`;
            
            // Mostrar notificaci√≥n completa
            const notificacionId = mostrarNotificacion(
                `üö® NUEVO ${tipo.toUpperCase()} REPORTADO`,
                mensajeNotificacion,
                'robo'
            );
            
            // Limpiar formulario
            document.getElementById('direccion-robo').value = '';
            document.getElementById('detalles-robo').value = '';
            
            // Mostrar en mapa si est√° inicializado
            if (mapaLeaflet) {
                agregarRoboAlMapa(nuevoRobo);
            }
            
            // Reproducir sonido especial para robos
            reproducirSonidoAlertaRobo();
            
            return notificacionId;
        }
        
        function reproducirSonidoAlertaRobo() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Sonido de alarma de robo
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.5);
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 1);
        }
        
        function cargarHistorialRobos() {
            const contenedor = document.getElementById('historial-robos');
            if (!contenedor) return;
            
            if (robos.length === 0) {
                contenedor.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No hay robos reportados</div>';
                return;
            }
            
            let html = '';
            robos.slice(0, 10).forEach(robo => {
                const tiempo = formatearTiempoRelativo(robo.fecha);
                
                html += `
                    <div class="robo-alert" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #dc2626;">üö® ${robo.tipo.toUpperCase()}</h4>
                            <span style="color: #6b7280; font-size: 0.9rem;">${tiempo}</span>
                        </div>
                        <p><strong>üìç ${robo.direccion}</strong></p>
                        <p>${robo.detalles}</p>
                        <button onclick="reenviarNotificacionRobo(${robo.id})" style="
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: bold;
                            margin-top: 10px;
                        ">
                            üîî Reenviar notificaci√≥n
                        </button>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function reenviarNotificacionRobo(id) {
            const robo = robos.find(r => r.id === id);
            if (robo) {
                mostrarNotificacion(
                    `üîÑ REENV√çO: ${robo.tipo.toUpperCase()}`,
                    `${robo.direccion}\n${robo.detalles}\nFecha original: ${new Date(robo.fecha).toLocaleString()}`,
                    'robo'
                );
            }
        }
        
        function guardarRobos() {
            try {
                localStorage.setItem('localizador_robos', JSON.stringify(robos));
            } catch (e) {
                console.error('Error guardando robos:', e);
            }
        }
        
        // ===== CONFIGURACI√ìN =====
        function cargarConfiguracion() {
            try {
                const configGuardada = localStorage.getItem('localizador_config');
                if (configGuardada) {
                    configuracion = JSON.parse(configGuardada);
                }
            } catch (e) {
                console.error('Error cargando configuraci√≥n:', e);
            }
        }
        
        function guardarConfiguracion() {
            configuracion.emailDestino = document.getElementById('email-destino').value;
            configuracion.emailAsunto = document.getElementById('email-asunto').value;
            configuracion.sonido = document.querySelector('input[name="sonido"]:checked').value;
            configuracion.mostrarToast = document.getElementById('mostrar-toast').checked;
            configuracion.mostrarPanel = document.getElementById('mostrar-panel').checked;
            configuracion.enviarEmail = document.getElementById('enviar-email').checked;
            
            try {
                localStorage.setItem('localizador_config', JSON.stringify(configuracion));
                mostrarNotificacion('‚úÖ Configuraci√≥n guardada', 'Tus preferencias se han guardado correctamente');
                mostrarEstadoSistema();
            } catch (e) {
                console.error('Error guardando configuraci√≥n:', e);
                mostrarNotificacion('‚ùå Error', 'No se pudo guardar la configuraci√≥n', 'alerta');
            }
        }
        
        function mostrarEstadoSistema() {
            document.getElementById('estado-correo').textContent = configuracion.emailDestino;
            document.getElementById('estado-sonido').textContent = 
                configuracion.sonido === 'campana' ? 'üîî Campana' : 
                configuracion.sonido === 'alerta' ? 'üö® Alerta' : 'üîá Sin sonido';
            document.getElementById('estado-toast').textContent = configuracion.mostrarToast ? '‚úÖ Activado' : '‚ùå Desactivado';
        }
        
        // ===== FUNCIONES DE PRUEBA =====
        function testNotification() {
            mostrarNotificacion(
                'üîî PRUEBA DE NOTIFICACI√ìN',
                'Esta es una notificaci√≥n de prueba del sistema de alarmas.\nTodo funciona correctamente.',
                'info'
            );
        }
        
        function testEmail() {
            enviarCorreoNotificacion(
                'üìß PRUEBA DE CORREO',
                'Este es un correo de prueba del sistema de notificaciones.\nSi recibes este correo, el sistema est√° funcionando correctamente.'
            );
        }
        
        function simularNuevoRobo() {
            const direcciones = [
                "Calle Principal, 123, C√≥rdoba",
                "Avenida de la Libertad, 45, Lucena",
                "Plaza Mayor, 8, Puente Genil",
                "Calle Nueva, 32, Montilla"
            ];
            
            const tipos = ["robo", "intento", "allanamiento", "vandalismo"];
            const detalles = [
                "Robo con fuerza en vivienda unifamiliar",
                "Intento de robo frustrado por alarma",
                "Allanamiento de morada en horario nocturno",
                "Vandalismo en comercio del centro"
            ];
            
            const direccion = direcciones[Math.floor(Math.random() * direcciones.length)];
            const tipo = tipos[Math.floor(Math.random() * tipos.length)];
            const detalle = detalles[Math.floor(Math.random() * detalles.length)];
            
            // Establecer valores en formulario
            document.getElementById('direccion-robo').value = direccion;
            document.getElementById('tipo-robo').value = tipo;
            document.getElementById('detalles-robo').value = detalle;
            
            // Reportar autom√°ticamente
            reportarRoboConNotificacion();
        }
        
        function simularNuevoRoboAutomatico() {
            mostrarNotificacion(
                'üö® SIMULACI√ìN AUTOM√ÅTICA',
                'Se ha simulado un robo en Calle Demo, 1 para probar el sistema.\nPuedes reportar robos reales en la secci√≥n correspondiente.',
                'robo'
            );
        }
        
        // ===== FUNCIONES UTILITARIAS =====
        function formatearTiempoRelativo(fecha) {
            const ahora = new Date();
            const diferencia = ahora - new Date(fecha);
            
            const segundos = Math.floor(diferencia / 1000);
            const minutos = Math.floor(segundos / 60);
            const horas = Math.floor(minutos / 60);
            const dias = Math.floor(horas / 24);
            
            if (dias > 0) return `Hace ${dias} d√≠a${dias === 1 ? '' : 's'}`;
            if (horas > 0) return `Hace ${horas} hora${horas === 1 ? '' : 's'}`;
            if (minutos > 0) return `Hace ${minutos} minuto${minutos === 1 ? '' : 's'}`;
            return 'Ahora mismo';
        }
        
        function actualizarHora() {
            const ahora = new Date();
            const hora = ahora.getHours().toString().padStart(2, '0');
            const minutos = ahora.getMinutes().toString().padStart(2, '0');
            document.getElementById('hora-actual').textContent = `${hora}:${minutos}`;
            setTimeout(actualizarHora, 60000);
        }
        
        function actualizarEstadisticas() {
            document.getElementById('robos-hoy').textContent = robos.length;
            
            // Contar robos de hoy
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const robosHoy = robos.filter(r => new Date(r.fecha) >= hoy).length;
            document.getElementById('robos-hoy').textContent = robosHoy;
        }
        
        function guardarEstadistica(clave, valor) {
            try {
                localStorage.setItem(`estadistica_${clave}`, valor);
            } catch (e) {
                console.error('Error guardando estad√≠stica:', e);
            }
        }
        
        // ===== NAVEGACI√ìN =====
        function mostrarSeccion(seccion) {
            // Ocultar todas las secciones
            document.querySelectorAll('.seccion').forEach(s => {
                s.style.display = 'none';
            });
            
            // Remover active de todas las pesta√±as
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
            });
            
            // Mostrar secci√≥n seleccionada
            document.getElementById(seccion).style.display = 'block';
            
            // Marcar pesta√±a como activa
            event.target.classList.add('active');
            
            // Actualizar datos espec√≠ficos
            if (seccion === 'robos') {
                cargarHistorialRobos();
            } else if (seccion === 'notificaciones') {
                mostrarEstadoSistema();
            }
        }
        
        // Cerrar panel de notificaciones al hacer clic fuera
        document.addEventListener('click', function(event) {
            const panel = document.getElementById('notificationPanel');
            const bell = document.querySelector('.notification-bell');
            
            if (panel && panel.style.display === 'block' && 
                !panel.contains(event.target) && 
                !bell.contains(event.target)) {
                panel.style.display = 'none';
            }
        });
    </script>
</body>
</html>
