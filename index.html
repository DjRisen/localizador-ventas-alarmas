<!DOCTYPE html>
<html lang="es">
<head>
    <!-- TODO el CSS va aqu√≠ (desde <style> hasta </style>) -->
</head>
<body>
    <!-- TODO el HTML va aqu√≠ (desde <div class="notification-bell"> hasta </div> del footer) -->
    
    <!-- AQU√ç VA EL JAVASCRIPT - JUSTO ANTES DE </body> -->
    <script>
        // ===== TODO EL JAVASCRIPT VA AQU√ç =====
        // Configuraci√≥n de EmailJS (REEMPLAZA CON TUS DATOS)
        const EMAILJS_CONFIG = {
            PUBLIC_KEY: 'user_xxxxxxxxxxxx', // TU Public Key de EmailJS
            SERVICE_ID: 'service_xxxxxxxx',  // TU Service ID de EmailJS
            TEMPLATE_ID: 'template_xxxxxxx'  // TU Template ID de EmailJS
        };

        // Variables globales
        let mapa;
        let marcadores = [];
        let robos = [];
        let agenda = [];
        let notas = [];
        let notificaciones = [];
        let alertasEnviadas = [];
        let miUbicacionMarker;
        let watchId;

        // Configuraci√≥n de alertas (TUS DATOS YA PUESTOS)
        let configAlertas = {
            correo: "avisosderobos@gmail.com",
            whatsapp: "621284357",
            alertaRobo: true,
            alertaVisita: false,
            alertaOportunidad: true,
            alertaRecordatorio: false
        };

        // ===== INICIALIZAR EMAILJS =====
        function inicializarEmailJS() {
            // Verificar si EmailJS est√° cargado
            if (typeof emailjs === 'undefined') {
                console.error('‚ùå EmailJS no est√° cargado');
                return false;
            }
            
            if (EMAILJS_CONFIG.PUBLIC_KEY && EMAILJS_CONFIG.PUBLIC_KEY !== 'user_xxxxxxxxxxxx') {
                emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
                console.log("‚úÖ EmailJS inicializado");
                return true;
            }
            console.log("‚ö†Ô∏è EmailJS no configurado");
            return false;
        }

        // ===== FUNCI√ìN PARA ENVIAR CORREOS =====
        async function enviarAlertaCorreo(robo) {
            try {
                console.log("üìß Preparando env√≠o de correo...");
                
                // Verificar configuraci√≥n
                if (!EMAILJS_CONFIG.PUBLIC_KEY || EMAILJS_CONFIG.PUBLIC_KEY === 'user_xxxxxxxxxxxx') {
                    console.log("‚ö†Ô∏è Usando m√©todo alternativo (mailto)");
                    enviarCorreoAlternativo(robo);
                    return false;
                }

                // Preparar datos para el correo
                const templateParams = {
                    to_email: configAlertas.correo,
                    direccion: robo.direccion,
                    municipio: robo.municipio,
                    prioridad: robo.prioridad.toUpperCase(),
                    fecha: new Date(robo.fecha).toLocaleString('es-ES'),
                    coordenadas: `${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}`,
                    lat: robo.coordenadas.lat,
                    lng: robo.coordenadas.lng,
                    detalles: robo.detalles,
                    tipo: robo.tipo,
                    zona: robo.zona,
                    codigo_postal: robo.codigoPostal || "14000"
                };

                console.log("Datos del correo:", templateParams);

                // Enviar el correo
                const response = await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID,
                    EMAILJS_CONFIG.TEMPLATE_ID,
                    templateParams
                );

                if (response.status === 200) {
                    console.log('‚úÖ Correo enviado exitosamente');
                    
                    // Registrar en historial
                    registrarAlertaEnviada({
                        tipo: 'correo',
                        destinatario: configAlertas.correo,
                        titulo: `üö® Alerta: ${robo.municipio}`,
                        mensaje: robo.detalles,
                        fecha: new Date(),
                        estado: 'enviado'
                    });

                    mostrarNotificacion('üìß Correo enviado', 'La alerta llegar√° a tu bandeja de entrada');
                    return true;
                }

            } catch (error) {
                console.error('‚ùå Error al enviar correo:', error);
                
                // M√©todo alternativo si falla EmailJS
                enviarCorreoAlternativo(robo);
                return false;
            }
        }

        // ===== M√âTODO ALTERNATIVO (SI NO TIENES EMAILJS) =====
        function enviarCorreoAlternativo(robo) {
            const asunto = `üö® ALERTA DE ROBO: ${robo.municipio} - ${new Date().toLocaleTimeString()}`;
            
            const cuerpo = `
ALERTA DE SISTEMA DE SEGURIDAD
===============================

üìç DIRECCI√ìN: ${robo.direccion}
üèòÔ∏è MUNICIPIO: ${robo.municipio}
üéØ ZONA: ${robo.zona}
üî¥ PRIORIDAD: ${robo.prioridad.toUpperCase()}
üö® TIPO: ${robo.tipo}
üïí FECHA/HORA: ${new Date(robo.fecha).toLocaleString('es-ES')}
üìù DETALLES: ${robo.detalles}
üéØ COORDENADAS: ${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}
üìÆ C√ìDIGO POSTAL: ${robo.codigoPostal || "14000"}

üó∫Ô∏è VER EN GOOGLE MAPS:
https://www.google.com/maps?q=${robo.coordenadas.lat},${robo.coordenadas.lng}

üì± WHATSAPP INMEDIATO:
https://wa.me/621284357?text=Alerta%20de%20robo%20en%20${encodeURIComponent(robo.municipio)}

===============================
Sistema Autom√°tico de Alertas
avisosderobos@gmail.com | 621284357
`;

            const mailtoLink = `mailto:${configAlertas.correo}?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
            
            // Abrir Gmail directamente
            window.open('https://mail.google.com/mail/?view=cm&fs=1&to=' + configAlertas.correo + 
                       '&su=' + encodeURIComponent(asunto) + 
                       '&body=' + encodeURIComponent(cuerpo), '_blank');
            
            mostrarNotificacion('üìß Gmail abierto', 'Haz clic en "Enviar" para recibir la alerta');
        }

        // ===== FUNCI√ìN PARA ENVIAR WHATSAPP =====
        function enviarAlertaWhatsApp(robo) {
            const numero = configAlertas.whatsapp.replace(/\D/g, '');
            
            const mensaje = `üö® *ALERTA DE ROBO* üö®

üìç *Direcci√≥n:* ${robo.direccion}
üèòÔ∏è *Municipio:* ${robo.municipio}
üéØ *Zona:* ${robo.zona}
üî¥ *Prioridad:* ${robo.prioridad.toUpperCase()}
üö® *Tipo:* ${robo.tipo}
üïí *Fecha/Hora:* ${new Date(robo.fecha).toLocaleString('es-ES')}
üìù *Detalles:* ${robo.detalles}
üéØ *Coordenadas:* ${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}
üìÆ *C√≥digo Postal:* ${robo.codigoPostal || "14000"}

üó∫Ô∏è *Google Maps:*
https://maps.google.com/?q=${robo.coordenadas.lat},${robo.coordenadas.lng}`;

            const mensajeCodificado = encodeURIComponent(mensaje);
            const whatsappLink = `https://wa.me/${numero}?text=${mensajeCodificado}`;
            
            window.open(whatsappLink, '_blank');
            
            registrarAlertaEnviada({
                tipo: 'whatsapp',
                destinatario: configAlertas.whatsapp,
                titulo: 'Alerta WhatsApp',
                mensaje: robo.direccion,
                fecha: new Date(),
                estado: 'enviado'
            });
        }

        // ===== FUNCI√ìN COMPLETA DE ALERTA =====
        async function enviarAlertaCompleta() {
            const roboId = document.getElementById('quick-alert-panel').dataset.roboId;
            const robo = robos.find(r => r.id == roboId);
            
            if (!robo) {
                mostrarNotificacion('‚ùå Error', 'No se encontr√≥ el robo');
                return;
            }

            // Enviar correo
            await enviarAlertaCorreo(robo);
            
            // Enviar WhatsApp
            enviarAlertaWhatsApp(robo);
            
            // Marcar como notificado
            robo.notificado = true;
            
            // Cerrar panel
            cerrarQuickAlert();
            
            mostrarNotificacion('‚úÖ Alertas enviadas', 'Correo y WhatsApp enviados');
        }

        // ===== DATOS INICIALES DE ROBOS =====
        const robosIniciales = [
            {
                id: 1,
                direccion: "Calle Claudio Marcelo, 25",
                municipio: "C√ìRDOBA",
                zona: "Centro Hist√≥rico",
                tipo: "Robo en vivienda",
                detalles: "Robo con fuerza. Se llevaron electr√≥nica y joyas.",
                fecha: new Date(Date.now() - 2 * 60 * 60 * 1000),
                prioridad: "alta",
                coordenadas: { lat: 37.8882, lng: -4.7794 },
                codigoPostal: "14001",
                notificado: true
            },
            {
                id: 2,
                direccion: "Calle Industria, 12",
                municipio: "LUCENA",
                zona: "Pol√≠gono Industrial",
                tipo: "Intento de robo",
                detalles: "Intento fallido. Detectado por sistema de seguridad.",
                fecha: new Date(Date.now() - 4 * 60 * 60 * 1000),
                prioridad: "media",
                coordenadas: { lat: 37.4088, lng: -4.4854 },
                codigoPostal: "14900",
                notificado: true
            }
        ];

        // ===== INICIALIZAR LA APLICACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ Iniciando aplicaci√≥n...");
            
            // Cargar datos iniciales
            robos = [...robosIniciales];
            
            // Inicializar EmailJS
            setTimeout(() => {
                if (inicializarEmailJS()) {
                    mostrarNotificacion('‚úÖ EmailJS listo', 'Los correos se enviar√°n autom√°ticamente');
                } else {
                    mostrarNotificacion('‚ÑπÔ∏è Modo manual', 'Los correos se abrir√°n en Gmail para que los env√≠es');
                }
            }, 2000);
            
            // Actualizar hora
            actualizarHora();
            
            // Iniciar geolocalizaci√≥n
            iniciarGeolocalizacion();
            
            // Cargar datos guardados
            cargarDesdeLocalStorage();
            
            console.log("‚úÖ Aplicaci√≥n iniciada correctamente");
        });

        // ===== FUNCI√ìN PARA REPORTAR NUEVO ROBO =====
        async function reportarNuevoRobo() {
            const direccion = document.getElementById('nueva-direccion').value;
            const municipio = document.getElementById('nuevo-municipio').value;
            const detalles = document.getElementById('nuevos-detalles').value;
            const prioridad = document.querySelector('input[name="prioridad"]:checked').value;
            const enviarCorreo = document.getElementById('enviar-correo').checked;
            const enviarWhatsApp = document.getElementById('enviar-whatsapp').checked;
            
            if (!direccion || !municipio || !detalles) {
                mostrarNotificacion('‚ö†Ô∏è Campos requeridos', 'Completa direcci√≥n, municipio y detalles');
                return;
            }
            
            // Coordenadas seg√∫n municipio
            const coordenadasPorMunicipio = {
                "C√ìRDOBA": { lat: 37.8882 + (Math.random() * 0.01 - 0.005), lng: -4.7794 + (Math.random() * 0.01 - 0.005) },
                "LUCENA": { lat: 37.4088 + (Math.random() * 0.01 - 0.005), lng: -4.4854 + (Math.random() * 0.01 - 0.005) },
                "PUENTE GENIL": { lat: 37.3894 + (Math.random() * 0.01 - 0.005), lng: -4.7669 + (Math.random() * 0.01 - 0.005) },
                "MONTILLA": { lat: 37.5867 + (Math.random() * 0.01 - 0.005), lng: -4.6383 + (Math.random() * 0.01 - 0.005) },
                "PRIEGO": { lat: 37.4381 + (Math.random() * 0.01 - 0.005), lng: -4.1950 + (Math.random() * 0.01 - 0.005) },
                "CABRA": { lat: 37.4725 + (Math.random() * 0.01 - 0.005), lng: -4.4421 + (Math.random() * 0.01 - 0.005) }
            };
            
            const coordenadas = coordenadasPorMunicipio[municipio] || { lat: 37.8882, lng: -4.7794 };
            const codigoPostal = municipio === "C√ìRDOBA" ? "14001" : 
                               municipio === "LUCENA" ? "14900" : 
                               municipio === "PUENTE GENIL" ? "14500" : "14000";
            
            // Crear nuevo robo
            const nuevoRobo = {
                id: Date.now(),
                direccion: direccion,
                municipio: municipio,
                zona: "Reportado por sistema",
                tipo: "Robo reportado",
                detalles: detalles,
                fecha: new Date(),
                prioridad: prioridad,
                coordenadas: coordenadas,
                codigoPostal: codigoPostal,
                notificado: false
            };
            
            // A√±adir a la lista
            robos.unshift(nuevoRobo);
            
            // Actualizar interfaz
            cargarUltimosRobos();
            cargarListaRobosCompleta();
            actualizarEstadisticas();
            
            // Enviar alertas si est√°n marcadas
            if (enviarCorreo) {
                await enviarAlertaCorreo(nuevoRobo);
            }
            
            if (enviarWhatsApp) {
                enviarAlertaWhatsApp(nuevoRobo);
            }
            
            // Limpiar formulario
            document.getElementById('nueva-direccion').value = '';
            document.getElementById('nuevo-municipio').value = '';
            document.getElementById('nuevos-detalles').value = '';
            
            // A√±adir marcador al mapa
            if (mapa) {
                agregarMarcadorRobo(nuevoRobo);
                mapa.setView([coordenadas.lat, coordenadas.lng], 15);
            }
            
            // Guardar en localStorage
            guardarEnLocalStorage();
            
            mostrarNotificacion('‚úÖ Robo reportado', `Incidente a√±adido en ${municipio}`);
        }

        // ===== FUNCIONES B√ÅSICAS =====
        function mostrarNotificacion(titulo, mensaje) {
            console.log(`üîî ${titulo}: ${mensaje}`);
            
            // Actualizar campanita
            const countElem = document.getElementById('notification-count');
            let count = parseInt(countElem.textContent) || 0;
            countElem.textContent = count + 1;
            
            // Mostrar notificaci√≥n flotante
            const notificacion = document.getElementById('notificacion');
            const tituloElem = document.getElementById('notificacion-titulo');
            const mensajeElem = document.getElementById('notificacion-mensaje');
            
            tituloElem.textContent = titulo;
            mensajeElem.textContent = mensaje;
            notificacion.style.display = 'block';
            
            // Sonido de notificaci√≥n
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ');
                audio.volume = 0.3;
                audio.play();
            } catch (e) {}
            
            // Ocultar despu√©s de 5 segundos
            setTimeout(() => {
                notificacion.style.display = 'none';
            }, 5000);
        }

        function actualizarHora() {
            const ahora = new Date();
            const hora = ahora.getHours().toString().padStart(2, '0');
            const minutos = ahora.getMinutes().toString().padStart(2, '0');
            
            document.getElementById('hora-actual').textContent = `${hora}:${minutos}`;
            setTimeout(actualizarHora, 60000);
        }

        function guardarEnLocalStorage() {
            try {
                localStorage.setItem('localizador_robos', JSON.stringify(robos));
                localStorage.setItem('configAlertas', JSON.stringify(configAlertas));
            } catch (e) {
                console.error('Error guardando:', e);
            }
        }

        function cargarDesdeLocalStorage() {
            try {
                const robosGuardados = localStorage.getItem('localizador_robos');
                const configGuardada = localStorage.getItem('configAlertas');
                
                if (robosGuardados) {
                    const parsed = JSON.parse(robosGuardados);
                    parsed.forEach(r => r.fecha = new Date(r.fecha));
                    robos = parsed;
                }
                
                if (configGuardada) {
                    configAlertas = JSON.parse(configGuardada);
                }
            } catch (e) {
                console.error('Error cargando:', e);
            }
        }

        // ===== FUNCIONES DEL MAPA =====
        function initMap() {
            // Centro en C√≥rdoba
            const cordobaCentro = [37.8882, -4.7794];
            
            // Crear mapa
            mapa = L.map('mapa-real').setView(cordobaCentro, 12);
            
            // A√±adir OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(mapa);
            
            // A√±adir marcadores iniciales
            agregarMarcadoresRobos();
            
            console.log("üó∫Ô∏è Mapa cargado correctamente");
        }

        function agregarMarcadoresRobos() {
            robos.forEach(robo => {
                if (robo.coordenadas) {
                    const color = robo.prioridad === 'alta' ? '#dc2626' : 
                                 robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
                    
                    const icono = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background:${color};width:20px;height:20px;border-radius:50%;border:2px solid white;box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>`,
                        iconSize: [20, 20]
                    });
                    
                    const marker = L.marker([robo.coordenadas.lat, robo.coordenadas.lng], { icon: icono })
                        .addTo(mapa)
                        .bindPopup(`
                            <div style="min-width:250px;">
                                <h3 style="color:${color};margin:0 0 10px 0;">üö® ${robo.tipo}</h3>
                                <p><strong>üìç</strong> ${robo.direccion}</p>
                                <p><strong>üèòÔ∏è</strong> ${robo.municipio}</p>
                                <p><strong>üéØ</strong> <span style="color:${color}">${robo.prioridad.toUpperCase()}</span></p>
                                <button onclick="mostrarQuickAlert(${robo.id})" style="background:${color};color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;margin-top:10px;width:100%;">
                                    üì¢ Enviar Alerta
                                </button>
                            </div>
                        `);
                    
                    marcadores.push(marker);
                }
            });
        }

        // ===== FUNCIONES DE LA INTERFAZ =====
        function mostrarSeccion(seccion) {
            // Ocultar todas las secciones
            document.querySelectorAll('.seccion').forEach(s => {
                s.style.display = 'none';
            });
            
            // Mostrar secci√≥n seleccionada
            document.getElementById(seccion).style.display = 'block';
            
            // Actualizar pesta√±as activas
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Inicializar mapa si es necesario
            if (seccion === 'mapa' && !mapa) {
                setTimeout(initMap, 500);
            }
        }

        function mostrarQuickAlert(roboId) {
            const panel = document.getElementById('quick-alert-panel');
            panel.dataset.roboId = roboId;
            panel.style.display = 'block';
        }

        function cerrarQuickAlert() {
            document.getElementById('quick-alert-panel').style.display = 'none';
        }

        function registrarAlertaEnviada(alerta) {
            alertasEnviadas.unshift(alerta);
            // Actualizar estad√≠sticas
            document.getElementById('alertas-enviadas').textContent = alertasEnviadas.length;
        }

        function actualizarEstadisticas() {
            document.getElementById('total-robos').textContent = robos.length;
            const robosRecientes = robos.filter(r => (new Date() - r.fecha) < 24 * 60 * 60 * 1000);
            document.getElementById('robos-activos').textContent = `üö® ${robosRecientes.length} robos activos`;
        }

        function cargarUltimosRobos() {
            const contenedor = document.getElementById('ultimos-robos');
            if (!contenedor) return;
            
            const ultimos = robos.slice(0, 3);
            let html = '';
            
            ultimos.forEach(robo => {
                const color = robo.prioridad === 'alta' ? '#dc2626' : 
                             robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
                
                html += `
                    <div class="robo-alert" onclick="mostrarQuickAlert(${robo.id})">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <h3 style="margin:0;color:${color};">üö® ${robo.tipo}</h3>
                            <span style="background:${color};color:white;padding:4px 10px;border-radius:12px;font-size:0.8rem;font-weight:600;">
                                ${robo.prioridad.toUpperCase()}
                            </span>
                        </div>
                        <p><strong>üìç ${robo.direccion}</strong></p>
                        <p><strong>üèòÔ∏è ${robo.municipio}</strong></p>
                        <button class="action-btn" onclick="event.stopPropagation();enviarAlertaCorreo(${JSON.stringify(robo).replace(/"/g, '&quot;')})">
                            üìß Enviar Alerta
                        </button>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html || '<p style="text-align:center;color:#6b7280;padding:20px;">No hay robos recientes</p>';
        }

        // ===== EXPORTAR FUNCIONES AL SCOPE GLOBAL =====
        window.initMap = initMap;
        window.mostrarSeccion = mostrarSeccion;
        window.mostrarQuickAlert = mostrarQuickAlert;
        window.cerrarQuickAlert = cerrarQuickAlert;
        window.enviarAlertaCompleta = enviarAlertaCompleta;
        window.reportarNuevoRobo = reportarNuevoRobo;
        window.obtenerUbicacionActual = function() {
            mostrarNotificacion('üìç Geolocalizaci√≥n', 'Funci√≥n activada');
        };
        window.cerrarNotificacion = function() {
            document.getElementById('notificacion').style.display = 'none';
        };
        window.mostrarModalNotificaciones = function() {
            document.getElementById('notifications-modal').style.display = 'flex';
        };
        window.cerrarModalNotificaciones = function() {
            document.getElementById('notifications-modal').style.display = 'none';
        };
        
        console.log("‚úÖ JavaScript cargado correctamente");
    </script>
    // ===== CONFIGURACI√ìN EMAILJS =====
// Configuraci√≥n ACTUALIZADA para EmailJS
const EMAILJS_CONFIG = {
    PUBLIC_KEY: 'user_xxxxxxxxxxxx', // REEMPLAZA con tu Public Key
    SERVICE_ID: 'service_xxxxxxxx', // REEMPLAZA con tu Service ID
    TEMPLATE_ID: 'template_xxxxxxx' // REEMPLAZA con tu Template ID
};

// Variables globales
let mapa;
let marcadores = [];
let robos = [];
let agenda = [];
let notas = [];
let notificaciones = [];
let alertasEnviadas = [];
let miUbicacionMarker;
let watchId;

// Configuraci√≥n de alertas
let configAlertas = {
    correo: "avisosderobos@gmail.com",
    whatsapp: "621284357",
    alertaRobo: true,
    alertaVisita: false,
    alertaOportunidad: true,
    alertaRecordatorio: false
};

// ===== INICIALIZACI√ìN EMAILJS =====
function inicializarEmailJS() {
    // Inicializar EmailJS con tu clave p√∫blica
    if (EMAILJS_CONFIG.PUBLIC_KEY && EMAILJS_CONFIG.PUBLIC_KEY !== 'user_xxxxxxxxxxxx') {
        emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
        console.log("‚úÖ EmailJS inicializado correctamente");
        return true;
    } else {
        console.log("‚ö†Ô∏è EmailJS no configurado. Usando m√©todo alternativo.");
        return false;
    }
}

// ===== FUNCI√ìN MEJORADA PARA ENVIAR CORREOS =====
async function enviarAlertaCorreoCompleta(robo) {
    try {
        // Verificar que EmailJS est√© configurado
        if (!EMAILJS_CONFIG.PUBLIC_KEY || EMAILJS_CONFIG.PUBLIC_KEY === 'user_xxxxxxxxxxxx') {
            mostrarNotificacion('‚ö†Ô∏è Configura EmailJS', 'Configura EmailJS para recibir correos autom√°ticos');
            enviarCorreoAlternativo(robo);
            return;
        }

        // Preparar los datos para la plantilla
        const templateParams = {
            to_email: configAlertas.correo,
            direccion: robo.direccion,
            municipio: robo.municipio,
            prioridad: robo.prioridad.toUpperCase(),
            fecha: new Date(robo.fecha).toLocaleString('es-ES'),
            coordenadas: `${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}`,
            lat: robo.coordenadas.lat,
            lng: robo.coordenadas.lng,
            detalles: robo.detalles,
            tipo: robo.tipo,
            zona: robo.zona,
            codigo_postal: robo.codigoPostal
        };

        console.log("üìß Enviando correo con datos:", templateParams);

        // Enviar correo usando EmailJS
        const response = await emailjs.send(
            EMAILJS_CONFIG.SERVICE_ID,
            EMAILJS_CONFIG.TEMPLATE_ID,
            templateParams
        );

        if (response.status === 200) {
            console.log('‚úÖ Correo enviado exitosamente:', response);
            
            // Registrar en historial
            registrarAlertaEnviada({
                tipo: 'correo',
                destinatario: configAlertas.correo,
                titulo: `üö® Alerta: ${robo.municipio}`,
                mensaje: robo.detalles,
                fecha: new Date(),
                estado: 'enviado'
            });

            mostrarNotificacion('üìß Correo enviado', 'La alerta se ha enviado correctamente a tu correo');
            return true;
        } else {
            throw new Error('Error en respuesta de EmailJS');
        }

    } catch (error) {
        console.error('‚ùå Error al enviar correo:', error);
        
        // Registrar error
        registrarAlertaEnviada({
            tipo: 'correo',
            destinatario: configAlertas.correo,
            titulo: `üö® Alerta: ${robo.municipio}`,
            mensaje: robo.detalles,
            fecha: new Date(),
            estado: 'error'
        });

        // Usar m√©todo alternativo
        enviarCorreoAlternativo(robo);
        return false;
    }
}

// ===== M√âTODO ALTERNATIVO (mailto:) =====
function enviarCorreoAlternativo(robo) {
    const asunto = `üö® ALERTA DE ROBO: ${robo.municipio}`;
    const cuerpo = `
SISTEMA DE ALERTAS DE ROBOS
============================

üìç DIRECCI√ìN: ${robo.direccion}
üèòÔ∏è MUNICIPIO: ${robo.municipio}
üéØ ZONA: ${robo.zona}
üî¥ PRIORIDAD: ${robo.prioridad.toUpperCase()}
üö® TIPO: ${robo.tipo}
üïí FECHA/HORA: ${new Date(robo.fecha).toLocaleString('es-ES')}
üìù DETALLES: ${robo.detalles}
üéØ COORDENADAS: ${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}
üìÆ C√ìDIGO POSTAL: ${robo.codigoPostal}

üó∫Ô∏è VER EN GOOGLE MAPS:
https://www.google.com/maps?q=${robo.coordenadas.lat},${robo.coordenadas.lng}

üì± WHATSAPP INMEDIATO:
https://wa.me/621284357?text=Alerta%20de%20robo%20en%20${encodeURIComponent(robo.municipio)}%20-%20${encodeURIComponent(robo.direccion)}

============================
Sistema Autom√°tico de Alertas
avisosderobos@gmail.com
`;

    const mailtoLink = `mailto:${configAlertas.correo}?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
    
    // Abrir cliente de correo
    window.open(mailtoLink, '_blank');
    
    mostrarNotificacion('üìß Correo listo', 'Se ha abierto tu cliente de correo con todos los datos');
}

// ===== FUNCI√ìN COMPLETA DE ALERTA =====
async function enviarAlertaCompleta(roboId) {
    const robo = robos.find(r => r.id == roboId);
    
    if (!robo) {
        mostrarNotificacion('‚ùå Error', 'No se encontr√≥ el robo para enviar alerta');
        return;
    }

    // Enviar por EmailJS (correo autom√°tico)
    const correoEnviado = await enviarAlertaCorreoCompleta(robo);
    
    // Enviar por WhatsApp
    enviarAlertaWhatsAppCompleta(robo);
    
    // Marcar como notificado
    robo.notificado = true;
    
    // Actualizar estad√≠sticas
    actualizarEstadisticas();
    
    if (correoEnviado) {
        mostrarNotificacion('‚úÖ Alertas enviadas', 'Correo y WhatsApp enviados correctamente');
    }
}

// ===== WHATSAPP COMPLETO =====
function enviarAlertaWhatsAppCompleta(robo) {
    const numero = configAlertas.whatsapp.replace(/\D/g, '');
    
    const mensaje = `üö® *ALERTA DE ROBO* üö®

üìç *Direcci√≥n:* ${robo.direccion}
üèòÔ∏è *Municipio:* ${robo.municipio}
üéØ *Zona:* ${robo.zona}
üî¥ *Prioridad:* ${robo.prioridad.toUpperCase()}
üö® *Tipo:* ${robo.tipo}
üïí *Fecha/Hora:* ${new Date(robo.fecha).toLocaleString('es-ES')}
üìù *Detalles:* ${robo.detalles}
üéØ *Coordenadas:* ${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}
üìÆ *C√≥digo Postal:* ${robo.codigoPostal}

üó∫Ô∏è *Google Maps:*
https://maps.google.com/?q=${robo.coordenadas.lat},${robo.coordenadas.lng}

‚ö†Ô∏è *ACCIONES INMEDIATAS:*
1. Verificar ubicaci√≥n en mapa
2. Contactar con afectados
3. Programar visita comercial
4. Ofrecer sistema de seguridad`;

    const mensajeCodificado = encodeURIComponent(mensaje);
    const whatsappLink = `https://wa.me/${numero}?text=${mensajeCodificado}`;
    
    window.open(whatsappLink, '_blank');
    
    registrarAlertaEnviada({
        tipo: 'whatsapp',
        destinatario: configAlertas.whatsapp,
        titulo: 'Alerta por WhatsApp',
        mensaje: robo.direccion,
        fecha: new Date(),
        estado: 'enviado'
    });
}
</body>
</html>
