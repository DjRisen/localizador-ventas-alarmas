<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOCALIZADOR PROFESIONAL DE ALARMAS</title>
    
    <!-- Google Maps API con Places y Geocoding -->
    <script src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY_AQU√ç&libraries=places,geocoding&callback=initMap" async defer></script>
    
    <style>
        /* ESTILOS GENERALES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            background: #0f172a; 
            color: white;
            overflow-x: hidden;
        }
        
        /* APP CONTAINER */
        .app-container { 
            max-width: 100%; 
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        
        /* HEADER */
        .header { 
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            color: white; 
            padding: 25px 20px; 
            text-align: center;
            border-bottom: 4px solid #3b82f6;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(59,130,246,0.1) 0%, transparent 70%);
            z-index: 0;
        }
        .logo { 
            font-size: 3.5rem; 
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        h1 { 
            font-size: 2rem; 
            margin-bottom: 10px; 
            font-weight: 800;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle { 
            color: #dbeafe; 
            font-size: 1rem;
            position: relative;
            z-index: 1;
        }
        
        /* NAVEGACI√ìN */
        .tabs {
            display: flex;
            background: white;
            overflow-x: auto;
            border-bottom: 3px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .tab {
            flex: 1;
            padding: 20px 15px;
            border: none;
            background: white;
            color: #4a5568;
            font-weight: 700;
            text-align: center;
            min-width: 120px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-right: 1px solid #f1f5f9;
        }
        .tab:last-child {
            border-right: none;
        }
        .tab:hover {
            background: #f8fafc;
            color: #1e40af;
            transform: translateY(-2px);
        }
        .tab.active {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            border-bottom: 3px solid #fbbf24;
            box-shadow: 0 4px 12px rgba(59,130,246,0.3);
        }
        
        /* CONTENIDO */
        .content { 
            padding: 25px; 
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* TARJETAS */
        .card {
            background: white;
            color: #1f2937;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            border: 1px solid #e5e7eb;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        }
        .card-title {
            color: #1e40af;
            margin-bottom: 25px;
            border-bottom: 3px solid #e5e7eb;
            padding-bottom: 15px;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
        }
        
        /* GOOGLE MAPS CONTAINER */
        .map-container {
            position: relative;
            height: 600px;
            width: 100%;
            border-radius: 12px;
            margin: 20px 0;
            border: 3px solid #e5e7eb;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        #mapa-real {
            height: 100%;
            width: 100%;
            border-radius: 10px;
        }
        
        /* CONTROLES DEL MAPA */
        .map-controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
        }
        .control-btn {
            padding: 14px 25px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(59,130,246,0.3);
        }
        .control-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(59,130,246,0.4);
        }
        .control-btn.secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .control-btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .control-btn.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        /* BUSCADOR DE DIRECCIONES */
        .address-search {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid #e5e7eb;
        }
        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .search-input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }
        .search-btn {
            padding: 16px 30px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(16,185,129,0.3);
        }
        .search-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
        }
        
        /* ALERTAS DE ROBOS CON GEOLOCALIZACI√ìN */
        .robo-alert {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 6px solid #dc2626;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .robo-alert:hover {
            transform: translateX(10px);
            box-shadow: 0 8px 25px rgba(220,38,38,0.15);
            border-color: #fca5a5;
        }
        .robo-alert .location-info {
            background: #dc2626;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin: 10px 0;
            font-weight: 600;
        }
        .robo-alert .coordinates {
            font-family: 'Courier New', monospace;
            background: #1f2937;
            color: #10b981;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            margin: 10px 0;
            display: inline-block;
        }
        .robo-alert .action-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .robo-alert .action-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        
        /* AGENDA DE CITAS */
        .agenda-container {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #bae6fd;
        }
        .cita-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #3b82f6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .cita-item:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        .cita-item .cita-fecha {
            background: #3b82f6;
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        /* BLOC DE NOTAS */
        .notes-container {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #fcd34d;
        }
        .note-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #f59e0b;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .note-item:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        .note-item .note-date {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* FORMULARIOS */
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 10px;
            color: #1f2937;
            font-weight: 600;
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        /* ESTAD√çSTICAS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(59,130,246,0.3);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .stat-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* NOTIFICACIONES */
        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            color: #1f2937;
            padding: 25px;
            border-radius: 14px;
            box-shadow: 0 10px 35px rgba(0,0,0,0.2);
            display: none;
            z-index: 2000;
            border-left: 7px solid #3b82f6;
            max-width: 400px;
            animation: slideInRight 0.4s ease;
            transform-origin: right bottom;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%) scale(0.8); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }
        
        /* PANEL DE INFORMACI√ìN DEL MAPA */
        .map-info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 350px;
            display: none;
            border: 2px solid #e5e7eb;
        }
        .map-info-panel h3 {
            color: #1e40af;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .content { padding: 20px; }
            .map-container { height: 500px; }
            .tab { min-width: 100px; padding: 18px 10px; }
        }
        
        @media (max-width: 768px) {
            .header { padding: 20px 15px; }
            .logo { font-size: 2.8rem; }
            h1 { font-size: 1.6rem; }
            .tab { 
                min-width: 90px; 
                padding: 16px 8px; 
                font-size: 0.85rem; 
            }
            .map-container { height: 400px; }
            .search-box { flex-direction: column; }
            .search-input { width: 100%; }
            .stats-grid { grid-template-columns: 1fr; }
            .control-btn { width: 100%; justify-content: center; }
            .notification { 
                bottom: 20px; 
                right: 20px; 
                left: 20px;
                max-width: none;
            }
        }
        
        @media (max-width: 480px) {
            .content { padding: 15px; }
            .card { padding: 20px; }
            .map-container { height: 350px; }
            .tab { min-width: 80px; padding: 14px 6px; font-size: 0.8rem; }
            .stat-number { font-size: 2.8rem; }
        }
        
        /* ANIMACIONES */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .shake {
            animation: shake 0.5s ease;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        /* SCROLLBAR PERSONALIZADA */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);
        }
    </style>
</head>
<body>
    <!-- APP CONTAINER -->
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo">üö®</div>
            <h1>LOCALIZADOR PROFESIONAL DE ALARMAS</h1>
            <p class="subtitle">Geolocalizaci√≥n en tiempo real - Agenda de visitas - Gesti√≥n profesional</p>
            <div style="margin-top: 20px; font-size: 1rem; position: relative; z-index: 1;">
                <span id="estado-conexion">‚úÖ Conectado</span> | 
                <span id="hora-actual">--:--</span> |
                <span id="gps-status">üìç GPS: Activado</span> |
                <span id="robos-activos">üö® 3 robos activos</span>
            </div>
        </div>
        
        <!-- NAVEGACI√ìN PRINCIPAL -->
        <div class="tabs">
            <button class="tab active" onclick="mostrarSeccion('inicio')">üè† Inicio</button>
            <button class="tab" onclick="mostrarSeccion('mapa')">üó∫Ô∏è Mapa & Geolocalizaci√≥n</button>
            <button class="tab" onclick="mostrarSeccion('robos')">üö® Robos en Tiempo Real</button>
            <button class="tab" onclick="mostrarSeccion('agenda')">üìÖ Agenda de Visitas</button>
            <button class="tab" onclick="mostrarSeccion('notas')">üìù Bloc de Notas</button>
            <button class="tab" onclick="mostrarSeccion('busqueda')">üîç B√∫squeda Avanzada</button>
            <button class="tab" onclick="mostrarSeccion('analisis')">üìä An√°lisis</button>
        </div>
        
        <!-- CONTENIDO PRINCIPAL -->
        <div class="content">
            
            <!-- SECCI√ìN INICIO -->
            <div id="inicio" class="seccion">
                <div class="card">
                    <h2 class="card-title">üö® SISTEMA DE GEOLOCALIZACI√ìN DE ALARMAS</h2>
                    <p>Sistema profesional para la gesti√≥n de ventas de alarmas con geolocalizaci√≥n en tiempo real, agenda de visitas y an√°lisis de oportunidades.</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-robos">8</div>
                            <div class="stat-label">Robos geolocalizados</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <div class="stat-number" id="total-visitas">12</div>
                            <div class="stat-label">Visitas programadas</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                            <div class="stat-number" id="municipios-activos">14</div>
                            <div class="stat-label">Municipios activos</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <div class="stat-number" id="oportunidades">47</div>
                            <div class="stat-label">Oportunidades</div>
                        </div>
                    </div>
                    
                    <div class="map-controls">
                        <button class="control-btn" onclick="mostrarSeccion('mapa')">
                            <span>üó∫Ô∏è</span> Ver Mapa Completo
                        </button>
                        <button class="control-btn secondary" onclick="mostrarSeccion('robos')">
                            <span>üö®</span> Ver √öltimos Robos
                        </button>
                        <button class="control-btn" onclick="mostrarSeccion('agenda')">
                            <span>üìÖ</span> Gestionar Agenda
                        </button>
                        <button class="control-btn warning" onclick="obtenerUbicacionActual()">
                            <span>üìç</span> Mi Ubicaci√≥n Actual
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="card-title">üìç √öLTIMOS ROBOS GEOLOCALIZADOS</h2>
                    <div id="ultimos-robos">
                        <!-- Los √∫ltimos robos se cargar√°n aqu√≠ -->
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN MAPA CON GEOLOCALIZACI√ìN -->
            <div id="mapa" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üó∫Ô∏è MAPA INTERACTIVO CON GEOLOCALIZACI√ìN</h2>
                    <p>Visualiza robos, agenda visitas y navega a ubicaciones exactas.</p>
                    
                    <!-- BUSCADOR DE DIRECCIONES -->
                    <div class="address-search">
                        <h3 style="color: #1e40af; margin-bottom: 20px;">üîç Buscar direcci√≥n exacta</h3>
                        <div class="search-box">
                            <input type="text" id="direccion-input" placeholder="Ej: Calle Claudio Marcelo 25, C√≥rdoba" class="search-input">
                            <button class="search-btn" onclick="buscarDireccion()">
                                <span>üîç</span> Buscar en Mapa
                            </button>
                        </div>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="control-btn secondary" onclick="buscarPorCoordenadas()">
                                <span>üìå</span> Buscar por Coordenadas
                            </button>
                            <button class="control-btn warning" onclick="obtenerUbicacionActual()">
                                <span>üìç</span> Mi Ubicaci√≥n
                            </button>
                            <button class="control-btn danger" onclick="limpiarMapa()">
                                <span>üóëÔ∏è</span> Limpiar Mapa
                            </button>
                        </div>
                    </div>
                    
                    <!-- CONTENEDOR DEL MAPA -->
                    <div class="map-container">
                        <div id="mapa-real"></div>
                        <!-- PANEL DE INFORMACI√ìN -->
                        <div class="map-info-panel" id="map-info-panel">
                            <h3>üìç Informaci√≥n del Punto</h3>
                            <div id="map-info-content">
                                Selecciona un marcador para ver informaci√≥n detallada
                            </div>
                            <button class="control-btn" onclick="cerrarPanelInfo()" style="margin-top: 15px; width: 100%;">
                                <span>‚ùå</span> Cerrar
                            </button>
                        </div>
                    </div>
                    
                    <!-- CONTROLES DEL MAPA -->
                    <div class="map-controls">
                        <button class="control-btn" onclick="mostrarTodosRobos()">
                            <span>üö®</span> Mostrar Todos los Robos
                        </button>
                        <button class="control-btn secondary" onclick="mostrarVisitasAgendadas()">
                            <span>üìÖ</span> Visitas Agendadas
                        </button>
                        <button class="control-btn" onclick="mostrarOportunidadesMapa()">
                            <span>üí∞</span> Zonas de Oportunidad
                        </button>
                        <button class="control-btn warning" onclick="calcularRuta()">
                            <span>üõ£Ô∏è</span> Calcular Ruta
                        </button>
                        <button class="control-btn" onclick="guardarUbicacion()">
                            <span>üíæ</span> Guardar Ubicaci√≥n
                        </button>
                    </div>
                    
                    <!-- INFORMACI√ìN DE GEOLOCALIZACI√ìN -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 20px;">
                        <h3 style="color: #1e40af; margin-bottom: 15px;">üì° Estado de Geolocalizaci√≥n</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <strong>üìç Mi ubicaci√≥n:</strong>
                                <div id="mi-ubicacion">Obteniendo...</div>
                            </div>
                            <div>
                                <strong>üéØ Precisi√≥n:</strong>
                                <div id="precision-gps">-- metros</div>
                            </div>
                            <div>
                                <strong>üì° Estado GPS:</strong>
                                <div id="estado-gps">Activando...</div>
                            </div>
                            <div>
                                <strong>üó∫Ô∏è Marcadores:</strong>
                                <div id="contador-marcadores">0 activos</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN ROBOS EN TIEMPO REAL -->
            <div id="robos" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üö® ROBOS GEOLOCALIZADOS EN TIEMPO REAL</h2>
                    <p>Incidentes reportados con ubicaci√≥n exacta para visitas inmediatas.</p>
                    
                    <!-- FILTROS DE B√öSQUEDA -->
                    <div class="search-box" style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <input type="text" id="filtro-robos" placeholder="Filtrar por municipio, calle o tipo..." class="search-input">
                        <select id="filtro-prioridad" class="search-input" style="max-width: 200px;">
                            <option value="">Todas las prioridades</option>
                            <option value="alta">Alta prioridad</option>
                            <option value="media">Media prioridad</option>
                            <option value="baja">Baja prioridad</option>
                        </select>
                        <button class="search-btn" onclick="filtrarRobos()">
                            <span>üîç</span> Filtrar
                        </button>
                    </div>
                    
                    <!-- LISTA DE ROBOS -->
                    <div id="lista-robos-completa">
                        <!-- Los robos se cargar√°n aqu√≠ -->
                    </div>
                    
                    <!-- FORMULARIO PARA REPORTAR NUEVO ROBO -->
                    <div style="background: #fef2f2; padding: 25px; border-radius: 12px; margin-top: 30px; border: 2px solid #fecaca;">
                        <h3 style="color: #dc2626; margin-bottom: 20px;">üìù Reportar Nuevo Robo</h3>
                        <div class="form-group">
                            <label class="form-label">üìç Direcci√≥n exacta</label>
                            <input type="text" id="nueva-direccion" placeholder="Calle, n√∫mero, municipio..." class="form-input">
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label">üèòÔ∏è Municipio</label>
                                <select id="nuevo-municipio" class="form-select">
                                    <option value="">Seleccionar municipio</option>
                                    <option value="C√ìRDOBA">C√ìRDOBA</option>
                                    <option value="LUCENA">LUCENA</option>
                                    <option value="PUENTE GENIL">PUENTE GENIL</option>
                                    <option value="MONTILLA">MONTILLA</option>
                                    <option value="PRIEGO">PRIEGO</option>
                                    <option value="CABRA">CABRA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üïí Hora del incidente</label>
                                <input type="datetime-local" id="nueva-hora" class="form-input">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üìù Detalles del robo</label>
                            <textarea id="nuevos-detalles" placeholder="Describe lo ocurrido..." class="form-textarea"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üéØ Prioridad</label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="prioridad" value="alta" checked> 
                                    <span style="color: #dc2626; font-weight: 600;">Alta</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="prioridad" value="media"> 
                                    <span style="color: #f59e0b; font-weight: 600;">Media</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="prioridad" value="baja"> 
                                    <span style="color: #10b981; font-weight: 600;">Baja</span>
                                </label>
                            </div>
                        </div>
                        <button class="control-btn danger" onclick="reportarNuevoRobo()" style="width: 100%; padding: 18px;">
                            <span>üö®</span> Reportar Nuevo Robo
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN AGENDA DE VISITAS -->
            <div id="agenda" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üìÖ AGENDA DE VISITAS PROFESIONAL</h2>
                    <p>Gestiona tus visitas comerciales con geolocalizaci√≥n y recordatorios.</p>
                    
                    <!-- AGENDA DEL D√çA -->
                    <div class="agenda-container">
                        <h3 style="color: #1e40af; margin-bottom: 20px;">üìÖ Visitas de Hoy</h3>
                        <div id="agenda-hoy">
                            <!-- Visitas de hoy se cargar√°n aqu√≠ -->
                        </div>
                    </div>
                    
                    <!-- TODAS LAS VISITAS -->
                    <div style="margin: 30px 0;">
                        <h3 style="color: #1e40af; margin-bottom: 20px;">üóìÔ∏è Todas las Visitas Programadas</h3>
                        <div id="lista-agenda-completa">
                            <!-- Todas las visitas se cargar√°n aqu√≠ -->
                        </div>
                    </div>
                    
                    <!-- FORMULARIO NUEVA VISITA -->
                    <div style="background: #f0f9ff; padding: 25px; border-radius: 12px; border: 2px solid #bae6fd;">
                        <h3 style="color: #1e40af; margin-bottom: 20px;">‚ûï Programar Nueva Visita</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label">üë§ Cliente/Negocio</label>
                                <input type="text" id="cliente-visita" placeholder="Nombre del cliente..." class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">üìç Direcci√≥n</label>
                                <input type="text" id="direccion-visita" placeholder="Direcci√≥n exacta..." class="form-input">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label">üìÖ Fecha</label>
                                <input type="date" id="fecha-visita" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">üïí Hora</label>
                                <input type="time" id="hora-visita" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">üèòÔ∏è Municipio</label>
                                <select id="municipio-visita" class="form-select">
                                    <option value="">Seleccionar</option>
                                    <option value="C√ìRDOBA">C√ìRDOBA</option>
                                    <option value="LUCENA">LUCENA</option>
                                    <option value="PUENTE GENIL">PUENTE GENIL</option>
                                    <option value="MONTILLA">MONTILLA</option>
                                    <option value="PRIEGO">PRIEGO</option>
                                    <option value="CABRA">CABRA</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üìù Motivo de la visita</label>
                            <textarea id="motivo-visita" placeholder="Presentaci√≥n, instalaci√≥n, mantenimiento..." class="form-textarea"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üìû Tel√©fono de contacto</label>
                            <input type="tel" id="telefono-visita" placeholder="N√∫mero de tel√©fono..." class="form-input">
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 25px;">
                            <button class="control-btn secondary" onclick="agregarVisita()" style="flex: 1; padding: 18px;">
                                <span>‚úÖ</span> Agregar Visita
                            </button>
                            <button class="control-btn" onclick="limpiarFormularioVisita()" style="flex: 1; padding: 18px;">
                                <span>üóëÔ∏è</span> Limpiar Formulario
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN BLOC DE NOTAS -->
            <div id="notas" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üìù BLOC DE NOTAS PROFESIONAL</h2>
                    <p>Guarda notas, ideas y recordatorios importantes para tu trabajo.</p>
                    
                    <!-- NOTAS RECIENTES -->
                    <div class="notes-container">
                        <h3 style="color: #d97706; margin-bottom: 20px;">üìù Notas Recientes</h3>
                        <div id="notas-recientes">
                            <!-- Notas recientes se cargar√°n aqu√≠ -->
                        </div>
                    </div>
                    
                    <!-- TODAS LAS NOTAS -->
                    <div style="margin: 30px 0;">
                        <h3 style="color: #d97706; margin-bottom: 20px;">üóÇÔ∏è Todas las Notas</h3>
                        <div id="lista-notas-completa">
                            <!-- Todas las notas se cargar√°n aqu√≠ -->
                        </div>
                    </div>
                    
                    <!-- FORMULARIO NUEVA NOTA -->
                    <div style="background: #fef3c7; padding: 25px; border-radius: 12px; border: 2px solid #fcd34d;">
                        <h3 style="color: #d97706; margin-bottom: 20px;">‚ûï Crear Nueva Nota</h3>
                        
                        <div class="form-group">
                            <label class="form-label">üìå T√≠tulo de la nota</label>
                            <input type="text" id="titulo-nota" placeholder="T√≠tulo descriptivo..." class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üìù Contenido</label>
                            <textarea id="contenido-nota" placeholder="Escribe tu nota aqu√≠..." class="form-textarea" rows="6"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üè∑Ô∏è Categor√≠a</label>
                            <select id="categoria-nota" class="form-select">
                                <option value="general">General</option>
                                <option value="clientes">Clientes</option>
                                <option value="visitas">Visitas</option>
                                <option value="oportunidades">Oportunidades</option>
                                <option value="recordatorio">Recordatorio</option>
                                <option value="idea">Idea</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 25px;">
                            <button class="control-btn warning" onclick="agregarNota()" style="flex: 1; padding: 18px;">
                                <span>üíæ</span> Guardar Nota
                            </button>
                            <button class="control-btn" onclick="limpiarFormularioNota()" style="flex: 1; padding: 18px;">
                                <span>üóëÔ∏è</span> Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN B√öSQUEDA AVANZADA -->
            <div id="busqueda" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üîç B√öSQUEDA AVANZADA</h2>
                    <p>Busca robos, visitas y oportunidades por m√∫ltiples criterios.</p>
                    
                    <!-- FORMULARIO DE B√öSQUEDA -->
                    <div style="background: #f8fafc; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                        <h3 style="color: #1e40af; margin-bottom: 25px;">üéØ Criterios de B√∫squeda</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 25px;">
                            <div class="form-group">
                                <label class="form-label">üî§ Palabra clave</label>
                                <input type="text" id="busqueda-keyword" placeholder="Calle, cliente, municipio..." class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">üèòÔ∏è Municipio</label>
                                <select id="busqueda-municipio" class="form-select">
                                    <option value="">Todos los municipios</option>
                                    <option value="C√ìRDOBA">C√ìRDOBA</option>
                                    <option value="LUCENA">LUCENA</option>
                                    <option value="PUENTE GENIL">PUENTE GENIL</option>
                                    <option value="MONTILLA">MONTILLA</option>
                                    <option value="PRIEGO">PRIEGO</option>
                                    <option value="CABRA">CABRA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üìÖ Fecha desde</label>
                                <input type="date" id="busqueda-fecha-desde" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">üìÖ Fecha hasta</label>
                                <input type="date" id="busqueda-fecha-hasta" class="form-input">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
                            <div class="form-group">
                                <label class="form-label">üéØ Tipo</label>
                                <select id="busqueda-tipo" class="form-select">
                                    <option value="">Todos los tipos</option>
                                    <option value="robo">Robo</option>
                                    <option value="visita">Visita</option>
                                    <option value="nota">Nota</option>
                                    <option value="oportunidad">Oportunidad</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üìä Prioridad</label>
                                <select id="busqueda-prioridad" class="form-select">
                                    <option value="">Todas las prioridades</option>
                                    <option value="alta">Alta</option>
                                    <option value="media">Media</option>
                                    <option value="baja">Baja</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üìç C√≥digo postal</label>
                                <input type="text" id="busqueda-cp" placeholder="Ej: 14001" class="form-input">
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="control-btn" onclick="ejecutarBusqueda()" style="padding: 18px 30px;">
                                <span>üîç</span> Ejecutar B√∫squeda
                            </button>
                            <button class="control-btn secondary" onclick="limpiarBusqueda()" style="padding: 18px 30px;">
                                <span>üóëÔ∏è</span> Limpiar Filtros
                            </button>
                            <button class="control-btn warning" onclick="exportarResultados()" style="padding: 18px 30px;">
                                <span>üì§</span> Exportar Resultados
                            </button>
                        </div>
                    </div>
                    
                    <!-- RESULTADOS DE B√öSQUEDA -->
                    <div id="resultados-busqueda">
                        <h3 style="color: #1e40af; margin-bottom: 20px;">üìã Resultados de la B√∫squeda</h3>
                        <div style="text-align: center; padding: 50px; color: #6b7280; background: #f8fafc; border-radius: 12px;">
                            <p style="font-size: 1.2rem;">Introduce criterios de b√∫squeda y haz clic en "Ejecutar B√∫squeda"</p>
                            <p style="margin-top: 10px; font-size: 0.9rem;">Puedes buscar por municipio, fecha, tipo, prioridad o palabra clave</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN AN√ÅLISIS -->
            <div id="analisis" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üìä AN√ÅLISIS Y ESTAD√çSTICAS</h2>
                    <p>Estad√≠sticas detalladas y an√°lisis de oportunidades de venta.</p>
                    
                    <!-- ESTAD√çSTICAS DETALLADAS -->
                    <div class="stats-grid">
                        <div class="stat-card" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);">
                            <div class="stat-number" id="robos-totales">24</div>
                            <div class="stat-label">Robos este mes</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                            <div class="stat-number" id="visitas-totales">48</div>
                            <div class="stat-label">Visitas programadas</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);">
                            <div class="stat-number" id="conversion-rate">68%</div>
                            <div class="stat-label">Tasa de conversi√≥n</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);">
                            <div class="stat-number" id="ingresos-estimados">‚Ç¨12.4K</div>
                            <div class="stat-label">Ingresos estimados</div>
                        </div>
                    </div>
                    
                    <!-- AN√ÅLISIS POR MUNICIPIO -->
                    <div style="margin: 40px 0;">
                        <h3 style="color: #1e40af; margin-bottom: 25px;">üìà An√°lisis por Municipio</h3>
                        <div id="analisis-municipios" style="background: #f8fafc; padding: 25px; border-radius: 12px;">
                            <!-- An√°lisis se cargar√° aqu√≠ -->
                        </div>
                    </div>
                    
                    <!-- GR√ÅFICO DE TENDENCIAS -->
                    <div style="background: white; padding: 30px; border-radius: 12px; border: 2px solid #e5e7eb; margin-top: 30px;">
                        <h3 style="color: #1e40af; margin-bottom: 25px;">üìä Tendencia de Robos por Semana</h3>
                        <div style="height: 300px; display: flex; align-items: flex-end; gap: 20px; padding: 20px; background: #f8fafc; border-radius: 10px;">
                            <div style="flex: 1; text-align: center;">
                                <div style="height: 250px; display: flex; align-items: flex-end; justify-content: center;">
                                    <div style="width: 40px; background: linear-gradient(to top, #dc2626, #ef4444); height: 200px; border-radius: 8px 8px 0 0;"></div>
                                </div>
                                <div style="margin-top: 10px; font-weight: 600;">Sem 1</div>
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <div style="height: 250px; display: flex; align-items: flex-end; justify-content: center;">
                                    <div style="width: 40px; background: linear-gradient(to top, #dc2626, #ef4444); height: 180px; border-radius: 8px 8px 0 0;"></div>
                                </div>
                                <div style="margin-top: 10px; font-weight: 600;">Sem 2</div>
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <div style="height: 250px; display: flex; align-items: flex-end; justify-content: center;">
                                    <div style="width: 40px; background: linear-gradient(to top, #dc2626, #ef4444); height: 220px; border-radius: 8px 8px 0 0;"></div>
                                </div>
                                <div style="margin-top: 10px; font-weight: 600;">Sem 3</div>
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <div style="height: 250px; display: flex; align-items: flex-end; justify-content: center;">
                                    <div style="width: 40px; background: linear-gradient(to top, #dc2626, #ef4444); height: 190px; border-radius: 8px 8px 0 0;"></div>
                                </div>
                                <div style="margin-top: 10px; font-weight: 600;">Sem 4</div>
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <div style="height: 250px; display: flex; align-items: flex-end; justify-content: center;">
                                    <div style="width: 40px; background: linear-gradient(to top, #dc2626, #ef4444); height: 240px; border-radius: 8px 8px 0 0;"></div>
                                </div>
                                <div style="margin-top: 10px; font-weight: 600;">Esta Sem</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RECOMENDACIONES -->
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 30px; border-radius: 12px; margin-top: 30px; border: 2px solid #93c5fd;">
                        <h3 style="color: #1e40af; margin-bottom: 20px;">üí° Recomendaciones Inteligentes</h3>
                        <div id="recomendaciones-lista">
                            <!-- Recomendaciones se cargar√°n aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FOOTER -->
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: #cbd5e1; padding: 30px; text-align: center; margin-top: 40px; border-top: 3px solid #3b82f6;">
            <p style="font-size: 1.2rem; font-weight: 700; margin-bottom: 15px;">LOCALIZADOR PROFESIONAL DE ALARMAS ¬© 2024</p>
            <p style="margin-bottom: 15px; max-width: 800px; margin-left: auto; margin-right: auto;">
                Sistema avanzado con geolocalizaci√≥n en tiempo real, agenda de visitas y an√°lisis inteligente para la provincia de C√≥rdoba
            </p>
            <p style="font-size: 0.9rem; color: #94a3b8;">
                <span id="ultima-actualizacion">√öltima actualizaci√≥n: --:--</span> | 
                <span id="version-sistema">v2.0 Professional</span> | 
                <span id="estado-sistema">‚úÖ Sistema activo</span>
            </p>
            <p style="font-size: 0.8rem; color: #64748b; margin-top: 20px;">
                üí° Consejo del d√≠a: Usa la geolocalizaci√≥n para planificar rutas eficientes entre visitas
            </p>
        </div>
        
        <!-- NOTIFICACI√ìN -->
        <div class="notification" id="notificacion">
            <strong id="notificacion-titulo" style="font-size: 1.1rem; color: #1e40af; display: block; margin-bottom: 10px;">Nueva alerta</strong>
            <p id="notificacion-mensaje" style="margin-bottom: 15px;">Mensaje de notificaci√≥n</p>
            <button onclick="cerrarNotificacion()" style="
                background: #3b82f6;
                color: white;
                border: none;
                padding: 8px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                width: 100%;
            ">
                ‚úÖ Entendido
            </button>
        </div>
    </div>

    <!-- JAVASCRIPT COMPLETO -->
    <script>
        // ===== CONFIGURACI√ìN INICIAL =====
        // üîë REEMPLAZA CON TU API KEY DE GOOGLE MAPS
        const GOOGLE_MAPS_API_KEY = 'TU_API_KEY_AQU√ç';
        
        // Variables globales
        let mapa;
        let marcadores = [];
        let robos = [];
        let agenda = [];
        let notas = [];
        let geocoder;
        let direccionesService;
        let miUbicacionMarker;
        let watchId;
        
        // Datos iniciales de robos con coordenadas reales
        const robosIniciales = [
            {
                id: 1,
                direccion: "Calle Claudio Marcelo, 25",
                municipio: "C√ìRDOBA",
                zona: "Centro Hist√≥rico",
                tipo: "Robo en vivienda",
                detalles: "Robo con fuerza. Se llevaron electr√≥nica y joyas.",
                fecha: new Date(Date.now() - 2 * 60 * 60 * 1000), // Hace 2 horas
                prioridad: "alta",
                coordenadas: { lat: 37.8882, lng: -4.7794 },
                codigoPostal: "14001"
            },
            {
                id: 2,
                direccion: "Calle Industria, 12",
                municipio: "LUCENA",
                zona: "Pol√≠gono Industrial",
                tipo: "Intento de robo",
                detalles: "Intento fallido. Detectado por sistema de seguridad.",
                fecha: new Date(Date.now() - 4 * 60 * 60 * 1000), // Hace 4 horas
                prioridad: "media",
                coordenadas: { lat: 37.4088, lng: -4.4854 },
                codigoPostal: "14900"
            },
            {
                id: 3,
                direccion: "Avenida de Andaluc√≠a, 8",
                municipio: "PUENTE GENIL",
                zona: "Centro Comercial",
                tipo: "Robo en comercio",
                detalles: "Robo en joyer√≠a. P√©rdidas considerables.",
                fecha: new Date(Date.now() - 6 * 60 * 60 * 1000), // Hace 6 horas
                prioridad: "alta",
                coordenadas: { lat: 37.3894, lng: -4.7669 },
                codigoPostal: "14500"
            },
            {
                id: 4,
                direccion: "Calle Ancha, 15",
                municipio: "MONTILLA",
                zona: "Centro",
                tipo: "Allanamiento",
                detalles: "Forzaron puerta trasera. Alarma no activada.",
                fecha: new Date(Date.now() - 8 * 60 * 60 * 1000), // Hace 8 horas
                prioridad: "media",
                coordenadas: { lat: 37.5867, lng: -4.6383 },
                codigoPostal: "14550"
            },
            {
                id: 5,
                direccion: "Plaza de la Constituci√≥n, 3",
                municipio: "PRIEGO",
                zona: "Centro Hist√≥rico",
                tipo: "Vandalismo",
                detalles: "Da√±os en fachada y ventanas rotas.",
                fecha: new Date(Date.now() - 10 * 60 * 60 * 1000), // Hace 10 horas
                prioridad: "baja",
                coordenadas: { lat: 37.4381, lng: -4.1950 },
                codigoPostal: "14800"
            }
        ];
        
        // Datos iniciales de agenda
        const agendaInicial = [
            {
                id: 1,
                cliente: "Restaurante La Alhambra",
                direccion: "Calle Torrijos, 8, C√≥rdoba",
                municipio: "C√ìRDOBA",
                fecha: new Date(new Date().setHours(10, 0, 0, 0)),
                motivo: "Presentaci√≥n presupuesto sistema completo",
                telefono: "957 123 456",
                prioridad: "alta",
                coordenadas: { lat: 37.8842, lng: -4.7790 }
            },
            {
                id: 2,
                cliente: "Ferreter√≠a L√≥pez",
                direccion: "Calle San Pedro, 25, Lucena",
                municipio: "LUCENA",
                fecha: new Date(new Date().setHours(12, 30, 0, 0)),
                motivo: "Instalaci√≥n b√°sica + mantenimiento anual",
                telefono: "957 654 321",
                prioridad: "media",
                coordenadas: { lat: 37.4080, lng: -4.4850 }
            },
            {
                id: 3,
                cliente: "Comunidad de vecinos Santa Rosa",
                direccion: "Avenida Cervantes, 12, Puente Genil",
                municipio: "PUENTE GENIL",
                fecha: new Date(new Date().setDate(new Date().getDate() + 1)),
                motivo: "Reuni√≥n para sistema comunitario de seguridad",
                telefono: "957 789 012",
                prioridad: "alta",
                coordenadas: { lat: 37.3890, lng: -4.7670 }
            }
        ];
        
        // Datos iniciales de notas
        const notasIniciales = [
            {
                id: 1,
                titulo: "Recordatorio importante",
                contenido: "Ofrecer mantenimiento anual a todos los clientes nuevos con un 20% de descuento el primer a√±o.",
                fecha: new Date(),
                categoria: "recordatorio",
                prioridad: "alta"
            },
            {
                id: 2,
                titulo: "Ideas para mejorar",
                contenido: "Crear paquete especial para comunidades de vecinos con descuento por volumen y monitorizaci√≥n centralizada.",
                fecha: new Date(Date.now() - 24 * 60 * 60 * 1000),
                categoria: "idea",
                prioridad: "media"
            },
            {
                id: 3,
                titulo: "Clientes potenciales",
                contenido: "Contactar con asociaci√≥n de comerciantes de C√≥rdoba centro la pr√≥xima semana.",
                fecha: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
                categoria: "clientes",
                prioridad: "alta"
            }
        ];
        
        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            iniciarAplicacion();
            actualizarHora();
            iniciarGeolocalizacion();
            mostrarNotificacion('‚úÖ Sistema activo', 'Geolocalizaci√≥n y agenda cargadas correctamente');
        });
        
        function iniciarAplicacion() {
            // Cargar datos iniciales
            robos = [...robosIniciales];
            agenda = [...agendaInicial];
            notas = [...notasIniciales];
            
            // Actualizar interfaces
            cargarUltimosRobos();
            cargarListaRobosCompleta();
            cargarAgendaHoy();
            cargarListaAgendaCompleta();
            cargarNotasRecientes();
            cargarListaNotasCompleta();
            cargarAnalisisMunicipios();
            cargarRecomendaciones();
            actualizarEstadisticas();
            
            // Configurar fechas en formularios
            configurarFechasFormularios();
            
            // Inicializar mapa si Google Maps est√° disponible
            if (typeof google !== 'undefined') {
                setTimeout(initMap, 1000);
            }
        }
        
        // ===== GOOGLE MAPS Y GEOLOCALIZACI√ìN =====
        function initMap() {
            // Centro inicial: C√≥rdoba capital
            const cordobaCentro = { lat: 37.8882, lng: -4.7794 };
            
            // Crear mapa
            mapa = new google.maps.Map(document.getElementById('mapa-real'), {
                zoom: 12,
                center: cordobaCentro,
                mapTypeId: 'roadmap',
                styles: [
                    {
                        "featureType": "administrative",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#444444"}]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "all",
                        "stylers": [{"color": "#f2f2f2"}]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "all",
                        "stylers": [{"saturation": -100}, {"lightness": 45}]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "all",
                        "stylers": [{"visibility": "simplified"}]
                    },
                    {
                        "featureType": "road.arterial",
                        "elementType": "labels.icon",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "all",
                        "stylers": [{"color": "#4a90e2"}, {"visibility": "on"}]
                    }
                ],
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true,
                zoomControl: true
            });
            
            // Inicializar servicios de Google
            geocoder = new google.maps.Geocoder();
            direccionesService = new google.maps.DirectionsService();
            
            // A√±adir marcadores de robos iniciales
            agregarMarcadoresRobos();
            
            // Configurar buscador de direcciones
            configurarAutocompletado();
            
            // A√±adir evento para cerrar panel de informaci√≥n
            mapa.addListener('click', function() {
                document.getElementById('map-info-panel').style.display = 'none';
            });
        }
        
        function configurarAutocompletado() {
            const input = document.getElementById('direccion-input');
            const autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo('bounds', mapa);
            
            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                if (!place.geometry) {
                    mostrarNotificacion('‚ö†Ô∏è Direcci√≥n no encontrada', 'No se pudo encontrar la ubicaci√≥n especificada');
                    return;
                }
                
                // Centrar mapa en la ubicaci√≥n
                mapa.setCenter(place.geometry.location);
                mapa.setZoom(17);
                
                // A√±adir marcador
                const marker = new google.maps.Marker({
                    map: mapa,
                    position: place.geometry.location,
                    title: place.name,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    }
                });
                
                // Guardar marcador
                marcadores.push(marker);
                
                // Mostrar informaci√≥n
                mostrarInfoMarcador(marker, {
                    titulo: place.name,
                    direccion: place.formatted_address,
                    tipo: 'Direcci√≥n buscada'
                });
                
                actualizarContadorMarcadores();
                mostrarNotificacion('üìç Ubicaci√≥n encontrada', `Centrado en ${place.name}`);
            });
        }
        
        function buscarDireccion() {
            const direccion = document.getElementById('direccion-input').value;
            if (!direccion.trim()) {
                mostrarNotificacion('‚ö†Ô∏è Campo vac√≠o', 'Por favor, introduce una direcci√≥n');
                return;
            }
            
            geocoder.geocode({ address: direccion + ', C√≥rdoba, Espa√±a' }, function(results, status) {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    
                    mapa.setCenter(location);
                    mapa.setZoom(17);
                    
                    const marker = new google.maps.Marker({
                        map: mapa,
                        position: location,
                        title: direccion,
                        icon: {
                            url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                        }
                    });
                    
                    marcadores.push(marker);
                    
                    mostrarInfoMarcador(marker, {
                        titulo: 'Direcci√≥n encontrada',
                        direccion: results[0].formatted_address,
                        tipo: 'B√∫squeda manual'
                    });
                    
                    actualizarContadorMarcadores();
                    mostrarNotificacion('‚úÖ Direcci√≥n encontrada', results[0].formatted_address);
                } else {
                    mostrarNotificacion('‚ùå Error', 'No se pudo encontrar la direcci√≥n: ' + status);
                }
            });
        }
        
        function buscarPorCoordenadas() {
            const coordenadas = prompt("Introduce coordenadas (lat,lng):\nEj: 37.8882,-4.7794");
            if (!coordenadas) return;
            
            const partes = coordenadas.split(',');
            if (partes.length !== 2) {
                mostrarNotificacion('‚ùå Formato incorrecto', 'Usa: latitud,longitud');
                return;
            }
            
            const lat = parseFloat(partes[0].trim());
            const lng = parseFloat(partes[1].trim());
            
            if (isNaN(lat) || isNaN(lng)) {
                mostrarNotificacion('‚ùå Coordenadas inv√°lidas', 'Introduce n√∫meros v√°lidos');
                return;
            }
            
            const location = { lat: lat, lng: lng };
            
            mapa.setCenter(location);
            mapa.setZoom(17);
            
            // Obtener direcci√≥n desde coordenadas
            geocoder.geocode({ location: location }, function(results, status) {
                let direccion = 'Coordenadas: ' + lat.toFixed(6) + ', ' + lng.toFixed(6);
                if (status === 'OK' && results[0]) {
                    direccion = results[0].formatted_address;
                }
                
                const marker = new google.maps.Marker({
                    map: mapa,
                    position: location,
                    title: 'Coordenadas personalizadas',
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                    }
                });
                
                marcadores.push(marker);
                
                mostrarInfoMarcador(marker, {
                    titulo: 'Coordenadas personalizadas',
                    direccion: direccion,
                    coordenadas: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                    tipo: 'Coordenadas manuales'
                });
                
                actualizarContadorMarcadores();
                mostrarNotificacion('üìç Coordenadas cargadas', direccion);
            });
        }
        
        function agregarMarcadoresRobos() {
            robos.forEach(robo => {
                if (robo.coordenadas) {
                    const color = robo.prioridad === 'alta' ? '#dc2626' : 
                                 robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
                    
                    const marker = new google.maps.Marker({
                        position: robo.coordenadas,
                        map: mapa,
                        title: `Robo en ${robo.municipio}`,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: color,
                            fillOpacity: 0.9,
                            strokeColor: '#ffffff',
                            strokeWeight: 2,
                            scale: 12
                        },
                        animation: google.maps.Animation.DROP
                    });
                    
                    // InfoWindow para el marcador
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 15px; min-width: 250px;">
                                <h3 style="margin: 0 0 10px 0; color: ${color}; font-size: 1.1rem;">üö® ${robo.tipo}</h3>
                                <p><strong>üìç Ubicaci√≥n:</strong> ${robo.direccion}</p>
                                <p><strong>üèòÔ∏è Municipio:</strong> ${robo.municipio}</p>
                                <p><strong>üéØ Prioridad:</strong> <span style="color: ${color}; font-weight: bold;">${robo.prioridad.toUpperCase()}</span></p>
                                <p><strong>üïí Hora:</strong> ${formatearTiempoRelativo(robo.fecha)}</p>
                                <p><strong>üìù Detalles:</strong> ${robo.detalles}</p>
                                <p><strong>üìå Coordenadas:</strong> ${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}</p>
                                <div style="margin-top: 15px;">
                                    <button onclick="navegarAUbicacion(${robo.coordenadas.lat}, ${robo.coordenadas.lng})" style="
                                        background: ${color};
                                        color: white;
                                        border: none;
                                        padding: 8px 15px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-weight: bold;
                                        margin-right: 10px;
                                    ">
                                        üó∫Ô∏è Navegar aqu√≠
                                    </button>
                                    <button onclick="agendarVisitaUbicacion(${robo.coordenadas.lat}, ${robo.coordenadas.lng}, '${robo.direccion}')" style="
                                        background: #3b82f6;
                                        color: white;
                                        border: none;
                                        padding: 8px 15px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-weight: bold;
                                    ">
                                        üìÖ Agendar visita
                                    </button>
                                </div>
                            </div>
                        `
                    });
                    
                    marker.addListener('click', () => {
                        infoWindow.open(mapa, marker);
                        mostrarPanelInfoRobo(robo);
                    });
                    
                    marcadores.push(marker);
                }
            });
            
            actualizarContadorMarcadores();
        }
        
        function mostrarPanelInfoRobo(robo) {
            const panel = document.getElementById('map-info-panel');
            const contenido = document.getElementById('map-info-content');
            
            const color = robo.prioridad === 'alta' ? '#dc2626' : 
                         robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
            
            contenido.innerHTML = `
                <div style="color: ${color}; font-weight: bold; margin-bottom: 10px;">üö® ${robo.tipo}</div>
                <p><strong>üìç Direcci√≥n:</strong><br>${robo.direccion}</p>
                <p><strong>üèòÔ∏è Municipio:</strong> ${robo.municipio}</p>
                <p><strong>üìå Coordenadas:</strong><br>${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}</p>
                <p><strong>üïí Hora:</strong> ${formatearTiempoRelativo(robo.fecha)}</p>
                <p><strong>üìù Detalles:</strong> ${robo.detalles}</p>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button onclick="navegarAUbicacion(${robo.coordenadas.lat}, ${robo.coordenadas.lng})" style="
                        flex: 1;
                        background: ${color};
                        color: white;
                        border: none;
                        padding: 8px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: bold;
                    ">
                        üó∫Ô∏è Navegar
                    </button>
                    <button onclick="agendarVisitaUbicacion(${robo.coordenadas.lat}, ${robo.coordenadas.lng}, '${robo.direccion}')" style="
                        flex: 1;
                        background: #3b82f6;
                        color: white;
                        border: none;
                        padding: 8px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: bold;
                    ">
                        üìÖ Agendar
                    </button>
                </div>
            `;
            
            panel.style.display = 'block';
        }
        
        function mostrarInfoMarcador(marker, info) {
            const panel = document.getElementById('map-info-panel');
            const contenido = document.getElementById('map-info-content');
            
            contenido.innerHTML = `
                <div style="color: #3b82f6; font-weight: bold; margin-bottom: 10px;">üìç ${info.titulo}</div>
                <p><strong>üìå Direcci√≥n:</strong><br>${info.direccion}</p>
                ${info.coordenadas ? `<p><strong>üéØ Coordenadas:</strong><br>${info.coordenadas}</p>` : ''}
                <p><strong>üìã Tipo:</strong> ${info.tipo}</p>
                <div style="margin-top: 15px;">
                    <button onclick="guardarUbicacionComoFavorita(${marker.getPosition().lat()}, ${marker.getPosition().lng()}, '${info.direccion}')" style="
                        width: 100%;
                        background: #10b981;
                        color: white;
                        border: none;
                        padding: 10px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: bold;
                    ">
                        üíæ Guardar ubicaci√≥n
                    </button>
                </div>
            `;
            
            panel.style.display = 'block';
        }
        
        function cerrarPanelInfo() {
            document.getElementById('map-info-panel').style.display = 'none';
        }
        
        // ===== GEOLOCALIZACI√ìN DEL USUARIO =====
        function iniciarGeolocalizacion() {
            if (navigator.geolocation) {
                document.getElementById('estado-gps').textContent = 'Activando...';
                document.getElementById('estado-gps').style.color = '#f59e0b';
                
                // Obtener ubicaci√≥n actual
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const precision = position.coords.accuracy;
                        
                        document.getElementById('mi-ubicacion').textContent = 
                            `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        document.getElementById('precision-gps').textContent = 
                            `${Math.round(precision)} metros`;
                        document.getElementById('estado-gps').textContent = '‚úÖ Activo';
                        document.getElementById('estado-gps').style.color = '#10b981';
                        document.getElementById('gps-status').textContent = 'üìç GPS: Activo';
                        
                        // Obtener direcci√≥n
                        geocoder.geocode({ location: { lat, lng } }, function(results, status) {
                            if (status === 'OK' && results[0]) {
                                document.getElementById('mi-ubicacion').textContent = results[0].formatted_address;
                            }
                        });
                        
                        // A√±adir marcador de ubicaci√≥n actual si el mapa est√° inicializado
                        if (mapa) {
                            agregarMarcadorUbicacionActual(lat, lng);
                        }
                    },
                    function(error) {
                        console.error('Error en geolocalizaci√≥n:', error);
                        document.getElementById('estado-gps').textContent = '‚ùå Error';
                        document.getElementById('estado-gps').style.color = '#dc2626';
                        document.getElementById('gps-status').textContent = 'üìç GPS: Error';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                mostrarNotificacion('‚ùå GPS no permitido', 'Permite el acceso a la ubicaci√≥n para usar todas las funciones');
                                break;
                            case error.POSITION_UNAVAILABLE:
                                mostrarNotificacion('‚ö†Ô∏è GPS no disponible', 'La informaci√≥n de ubicaci√≥n no est√° disponible');
                                break;
                            case error.TIMEOUT:
                                mostrarNotificacion('‚è±Ô∏è Timeout GPS', 'La solicitud de ubicaci√≥n ha expirado');
                                break;
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
                
                // Seguir la ubicaci√≥n
                watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Actualizar marcador si existe
                        if (miUbicacionMarker && mapa) {
                            miUbicacionMarker.setPosition({ lat, lng });
                        }
                    },
                    function(error) {
                        console.error('Error en watchPosition:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 30000
                    }
                );
            } else {
                document.getElementById('estado-gps').textContent = '‚ùå No soportado';
                document.getElementById('estado-gps').style.color = '#dc2626';
                mostrarNotificacion('‚ùå Geolocalizaci√≥n no soportada', 'Tu navegador no soporta geolocalizaci√≥n');
            }
        }
        
        function obtenerUbicacionActual() {
            if (!navigator.geolocation) {
                mostrarNotificacion('‚ùå No soportado', 'Geolocalizaci√≥n no disponible en este navegador');
                return;
            }
            
            mostrarNotificacion('üìç Obteniendo ubicaci√≥n', 'Buscando tu posici√≥n actual...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    if (mapa) {
                        // Centrar mapa en ubicaci√≥n actual
                        const ubicacion = new google.maps.LatLng(lat, lng);
                        mapa.setCenter(ubicacion);
                        mapa.setZoom(16);
                        
                        // A√±adir o actualizar marcador
                        agregarMarcadorUbicacionActual(lat, lng);
                        
                        mostrarNotificacion('üìç Ubicaci√≥n encontrada', `Centrado en tu posici√≥n actual`);
                    }
                },
                function(error) {
                    mostrarNotificacion('‚ùå Error de ubicaci√≥n', 'No se pudo obtener tu ubicaci√≥n');
                }
            );
        }
        
        function agregarMarcadorUbicacionActual(lat, lng) {
            // Eliminar marcador anterior si existe
            if (miUbicacionMarker) {
                miUbicacionMarker.setMap(null);
            }
            
            // Crear nuevo marcador
            miUbicacionMarker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: mapa,
                title: 'Mi ubicaci√≥n actual',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                    scaledSize: new google.maps.Size(40, 40)
                },
                animation: google.maps.Animation.BOUNCE
            });
            
            // Detener animaci√≥n despu√©s de 2 segundos
            setTimeout(() => {
                if (miUbicacionMarker) {
                    miUbicacionMarker.setAnimation(null);
                }
            }, 2000);
            
            // A√±adir a la lista de marcadores
            marcadores.push(miUbicacionMarker);
            actualizarContadorMarcadores();
        }
        
        function actualizarContadorMarcadores() {
            const activos = marcadores.filter(m => m.getMap() !== null).length;
            document.getElementById('contador-marcadores').textContent = `${activos} activos`;
        }
        
        // ===== FUNCIONALIDADES DEL MAPA =====
        function mostrarTodosRobos() {
            if (!mapa || robos.length === 0) return;
            
            const bounds = new google.maps.LatLngBounds();
            robos.forEach(robo => {
                if (robo.coordenadas) {
                    bounds.extend(new google.maps.LatLng(robo.coordenadas.lat, robo.coordenadas.lng));
                }
            });
            
            mapa.fitBounds(bounds);
            mostrarNotificacion('üö® Todos los robos', `Mostrando ${robos.length} incidentes en el mapa`);
        }
        
        function mostrarVisitasAgendadas() {
            if (!mapa || agenda.length === 0) return;
            
            // Limpiar marcadores anteriores (excepto ubicaci√≥n actual)
            marcadores.forEach(marker => {
                if (marker !== miUbicacionMarker) {
                    marker.setMap(null);
                }
            });
            marcadores = miUbicacionMarker ? [miUbicacionMarker] : [];
            
            // A√±adir marcadores de visitas
            const bounds = new google.maps.LatLngBounds();
            agenda.forEach(visita => {
                if (visita.coordenadas) {
                    const marker = new google.maps.Marker({
                        position: visita.coordenadas,
                        map: mapa,
                        title: `Visita: ${visita.cliente}`,
                        icon: {
                            url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                        }
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 15px; min-width: 250px;">
                                <h3 style="margin: 0 0 10px 0; color: #10b981;">üìÖ ${visita.cliente}</h3>
                                <p><strong>üìç Direcci√≥n:</strong> ${visita.direccion}</p>
                                <p><strong>üèòÔ∏è Municipio:</strong> ${visita.municipio}</p>
                                <p><strong>üïí Fecha/Hora:</strong> ${formatearFechaHora(visita.fecha)}</p>
                                <p><strong>üìû Tel√©fono:</strong> ${visita.telefono}</p>
                                <p><strong>üìù Motivo:</strong> ${visita.motivo}</p>
                                <div style="margin-top: 15px;">
                                    <button onclick="iniciarNavegacionAVisita(${visita.coordenadas.lat}, ${visita.coordenadas.lng})" style="
                                        background: #10b981;
                                        color: white;
                                        border: none;
                                        padding: 8px 15px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-weight: bold;
                                    ">
                                        üó∫Ô∏è Navegar a visita
                                    </button>
                                </div>
                            </div>
                        `
                    });
                    
                    marker.addListener('click', () => {
                        infoWindow.open(mapa, marker);
                    });
                    
                    marcadores.push(marker);
                    bounds.extend(new google.maps.LatLng(visita.coordenadas.lat, visita.coordenadas.lng));
                }
            });
            
            if (!bounds.isEmpty()) {
                mapa.fitBounds(bounds);
            }
            
            actualizarContadorMarcadores();
            mostrarNotificacion('üìÖ Visitas agendadas', `Mostrando ${agenda.length} visitas en el mapa`);
        }
        
        function mostrarOportunidadesMapa() {
            if (!mapa) return;
            
            // Coordenadas de municipios con oportunidades
            const oportunidades = [
                { nombre: "C√ìRDOBA", lat: 37.8882, lng: -4.7794, oportunidades: 25 },
                { nombre: "LUCENA", lat: 37.4088, lng: -4.4854, oportunidades: 18 },
                { nombre: "PUENTE GENIL", lat: 37.3894, lng: -4.7669, oportunidades: 14 },
                { nombre: "MONTILLA", lat: 37.5867, lng: -4.6383, oportunidades: 12 }
            ];
            
            // Limpiar marcadores anteriores
            marcadores.forEach(marker => marker.setMap(null));
            marcadores = [];
            
            const bounds = new google.maps.LatLngBounds();
            oportunidades.forEach(op => {
                const marker = new google.maps.Marker({
                    position: { lat: op.lat, lng: op.lng },
                    map: mapa,
                    title: `Oportunidades en ${op.nombre}`,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png'
                    }
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 15px; min-width: 250px;">
                            <h3 style="margin: 0 0 10px 0; color: #f59e0b;">üí∞ ${op.nombre}</h3>
                            <p><strong>üéØ Oportunidades detectadas:</strong> ${op.oportunidades}</p>
                            <p><strong>üìà Prioridad:</strong> <span style="color: #f59e0b; font-weight: bold;">ALTA</span></p>
                            <p><strong>üí° Recomendaci√≥n:</strong> Visita prioritaria esta semana</p>
                            <div style="margin-top: 15px;">
                                <button onclick="mostrarSeccion('agenda')" style="
                                    background: #f59e0b;
                                    color: white;
                                    border: none;
                                    padding: 8px 15px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-weight: bold;
                                ">
                                    üìÖ Agendar visita
                                </button>
                            </div>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    infoWindow.open(mapa, marker);
                });
                
                marcadores.push(marker);
                bounds.extend(new google.maps.LatLng(op.lat, op.lng));
            });
            
            if (!bounds.isEmpty()) {
                mapa.fitBounds(bounds);
            }
            
            actualizarContadorMarcadores();
            mostrarNotificacion('üí∞ Zonas de oportunidad', 'Mostrando municipios con alta demanda de seguridad');
        }
        
        function calcularRuta() {
            if (!mapa) {
                mostrarNotificacion('‚ö†Ô∏è Mapa no disponible', 'Espera a que se cargue el mapa');
                return;
            }
            
            const origen = prompt("Introduce direcci√≥n de origen (o deja vac√≠o para usar tu ubicaci√≥n):");
            const destino = prompt("Introduce direcci√≥n de destino:");
            
            if (!destino) {
                mostrarNotificacion('‚ö†Ô∏è Direcci√≥n requerida', 'Introduce una direcci√≥n de destino');
                return;
            }
            
            const request = {
                origin: origen || 'C√≥rdoba, Espa√±a',
                destination: destino + ', C√≥rdoba, Espa√±a',
                travelMode: google.maps.TravelMode.DRIVING
            };
            
            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({
                map: mapa,
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#3b82f6',
                    strokeOpacity: 0.8,
                    strokeWeight: 6
                }
            });
            
            directionsService.route(request, function(result, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    
                    mostrarNotificacion('üõ£Ô∏è Ruta calculada', 
                        `${leg.distance.text} ‚Ä¢ ${leg.duration.text}\nDe: ${leg.start_address}\nA: ${leg.end_address}`);
                } else {
                    mostrarNotificacion('‚ùå Error en ruta', 'No se pudo calcular la ruta: ' + status);
                }
            });
        }
        
        function guardarUbicacion() {
            const centro = mapa.getCenter();
            const lat = centro.lat();
            const lng = centro.lng();
            
            const nombre = prompt("Nombre para esta ubicaci√≥n (ej: Cliente importante, Punto de reuni√≥n):");
            if (!nombre) return;
            
            // Obtener direcci√≥n desde coordenadas
            geocoder.geocode({ location: centro }, function(results, status) {
                let direccion = 'Coordenadas: ' + lat.toFixed(6) + ', ' + lng.toFixed(6);
                if (status === 'OK' && results[0]) {
                    direccion = results[0].formatted_address;
                }
                
                // A√±adir a notas
                const nuevaNota = {
                    id: Date.now(),
                    titulo: `üìç Ubicaci√≥n guardada: ${nombre}`,
                    contenido: `Direcci√≥n: ${direccion}\nCoordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}\nGuardado el: ${new Date().toLocaleString()}`,
                    fecha: new Date(),
                    categoria: 'recordatorio',
                    prioridad: 'media'
                };
                
                notas.unshift(nuevaNota);
                guardarEnLocalStorage();
                cargarNotasRecientes();
                cargarListaNotasCompleta();
                
                mostrarNotificacion('üíæ Ubicaci√≥n guardada', `"${nombre}" guardado en el bloc de notas`);
            });
        }
        
        function guardarUbicacionComoFavorita(lat, lng, direccion) {
            const nombre = prompt("Nombre para esta ubicaci√≥n favorita:");
            if (!nombre) return;
            
            const nuevaNota = {
                id: Date.now(),
                titulo: `‚≠ê Favorito: ${nombre}`,
                contenido: `üìç ${direccion}\nüéØ Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}\nüíæ Guardado el: ${new Date().toLocaleString()}`,
                fecha: new Date(),
                categoria: 'recordatorio',
                prioridad: 'alta'
            };
            
            notas.unshift(nuevaNota);
            guardarEnLocalStorage();
            cargarNotasRecientes();
            cargarListaNotasCompleta();
            
            cerrarPanelInfo();
            mostrarNotificacion('‚≠ê Ubicaci√≥n favorita', `"${nombre}" guardado en notas`);
        }
        
        function limpiarMapa() {
            // Limpiar todos los marcadores excepto la ubicaci√≥n actual
            marcadores.forEach(marker => {
                if (marker !== miUbicacionMarker) {
                    marker.setMap(null);
                }
            });
            
            // Mantener solo el marcador de ubicaci√≥n actual
            marcadores = miUbicacionMarker ? [miUbicacionMarker] : [];
            
            actualizarContadorMarcadores();
            mostrarNotificacion('üóëÔ∏è Mapa limpiado', 'Todos los marcadores han sido eliminados');
        }
        
        // ===== FUNCIONES DE NAVEGACI√ìN =====
        function navegarAUbicacion(lat, lng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
            window.open(url, '_blank');
            mostrarNotificacion('üó∫Ô∏è Navegaci√≥n iniciada', 'Abriendo Google Maps con la ruta');
        }
        
        function iniciarNavegacionAVisita(lat, lng) {
            navegarAUbicacion(lat, lng);
        }
        
        function agendarVisitaUbicacion(lat, lng, direccion) {
            mostrarSeccion('agenda');
            
            // Rellenar formulario con la direcci√≥n
            document.getElementById('direccion-visita').value = direccion;
            document.getElementById('cliente-visita').value = `Visita por robo en ${direccion.split(',')[0]}`;
            
            // Buscar municipio basado en coordenadas
            geocoder.geocode({ location: { lat, lng } }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    const addressComponents = results[0].address_components;
                    const municipioComponent = addressComponents.find(comp => 
                        comp.types.includes('locality') || comp.types.includes('administrative_area_level_3')
                    );
                    
                    if (municipioComponent) {
                        const select = document.getElementById('municipio-visita');
                        for (let i = 0; i < select.options.length; i++) {
                            if (select.options[i].value === municipioComponent.long_name.toUpperCase()) {
                                select.selectedIndex = i;
                                break;
                            }
                        }
                    }
                }
            });
            
            mostrarNotificacion('üìÖ Visita sugerida', 'Formulario de visita pre-llenado con la ubicaci√≥n del robo');
        }
        
        // ===== GESTI√ìN DE ROBOS =====
        function cargarUltimosRobos() {
            const contenedor = document.getElementById('ultimos-robos');
            if (!contenedor) return;
            
            const ultimosRobos = robos.slice(0, 3); // Mostrar solo los 3 m√°s recientes
            
            if (ultimosRobos.length === 0) {
                contenedor.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No hay robos recientes</p>';
                return;
            }
            
            let html = '';
            ultimosRobos.forEach(robo => {
                const color = robo.prioridad === 'alta' ? '#dc2626' : 
                             robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
                
                html += `
                    <div class="robo-alert" onclick="mostrarRoboEnMapa(${robo.id})">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0; color: ${color};">üö® ${robo.tipo}</h3>
                            <span style="background: ${color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                ${robo.prioridad.toUpperCase()}
                            </span>
                        </div>
                        <p><strong>üìç ${robo.direccion}</strong></p>
                        <p><strong>üèòÔ∏è ${robo.municipio}</strong> ‚Ä¢ ${robo.zona}</p>
                        <div class="location-info">${formatearTiempoRelativo(robo.fecha)}</div>
                        <p style="margin: 10px 0;">${robo.detalles}</p>
                        <div class="coordinates">üéØ ${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}</div>
                        <button class="action-btn" onclick="event.stopPropagation(); navegarAUbicacion(${robo.coordenadas.lat}, ${robo.coordenadas.lng})">
                            <span>üó∫Ô∏è</span> Navegar al lugar
                        </button>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function cargarListaRobosCompleta() {
            const contenedor = document.getElementById('lista-robos-completa');
            if (!contenedor) return;
            
            if (robos.length === 0) {
                contenedor.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No hay robos reportados</p>';
                return;
            }
            
            // Ordenar por fecha (m√°s recientes primero)
            const robosOrdenados = [...robos].sort((a, b) => b.fecha - a.fecha);
            
            let html = '';
            robosOrdenados.forEach(robo => {
                const color = robo.prioridad === 'alta' ? '#dc2626' : 
                             robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
                
                html += `
                    <div class="robo-alert" onclick="mostrarRoboEnMapa(${robo.id})">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <h3 style="margin: 0 0 5px 0; color: ${color};">üö® ${robo.tipo}</h3>
                                <p style="margin: 0; font-size: 0.9rem; color: #6b7280;">${robo.municipio} ‚Ä¢ ${robo.zona}</p>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: ${color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                    ${robo.prioridad.toUpperCase()}
                                </span>
                                <div style="font-size: 0.8rem; color: #6b7280; margin-top: 5px;">${formatearTiempoRelativo(robo.fecha)}</div>
                            </div>
                        </div>
                        <p><strong>üìç Direcci√≥n:</strong> ${robo.direccion}</p>
                        <p><strong>üìù Detalles:</strong> ${robo.detalles}</p>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="action-btn" onclick="event.stopPropagation(); navegarAUbicacion(${robo.coordenadas.lat}, ${robo.coordenadas.lng})">
                                <span>üó∫Ô∏è</span> Navegar
                            </button>
                            <button class="action-btn" onclick="event.stopPropagation(); agendarVisitaRobo(${robo.id})" style="background: #3b82f6;">
                                <span>üìÖ</span> Agendar visita
                            </button>
                            <button class="action-btn" onclick="event.stopPropagation(); verDetallesRobo(${robo.id})" style="background: #6b7280;">
                                <span>üìã</span> Detalles
                            </button>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function filtrarRobos() {
            const filtro = document.getElementById('filtro-robos').value.toLowerCase();
            const prioridad = document.getElementById('filtro-prioridad').value;
            
            let robosFiltrados = robos;
            
            if (filtro) {
                robosFiltrados = robosFiltrados.filter(robo => 
                    robo.direccion.toLowerCase().includes(filtro) ||
                    robo.municipio.toLowerCase().includes(filtro) ||
                    robo.zona.toLowerCase().includes(filtro) ||
                    robo.tipo.toLowerCase().includes(filtro) ||
                    robo.detalles.toLowerCase().includes(filtro)
                );
            }
            
            if (prioridad) {
                robosFiltrados = robosFiltrados.filter(robo => robo.prioridad === prioridad);
            }
            
            // Actualizar la lista
            const contenedor = document.getElementById('lista-robos-completa');
            
            if (robosFiltrados.length === 0) {
                contenedor.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No se encontraron robos con esos filtros</p>';
                return;
            }
            
            let html = '';
            robosFiltrados.forEach(robo => {
                const color = robo.prioridad === 'alta' ? '#dc2626' : 
                             robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
                
                html += `
                    <div class="robo-alert" onclick="mostrarRoboEnMapa(${robo.id})">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <h3 style="margin: 0 0 5px 0; color: ${color};">üö® ${robo.tipo}</h3>
                                <p style="margin: 0; font-size: 0.9rem; color: #6b7280;">${robo.municipio} ‚Ä¢ ${robo.zona}</p>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: ${color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                    ${robo.prioridad.toUpperCase()}
                                </span>
                                <div style="font-size: 0.8rem; color: #6b7280; margin-top: 5px;">${formatearTiempoRelativo(robo.fecha)}</div>
                            </div>
                        </div>
                        <p><strong>üìç Direcci√≥n:</strong> ${robo.direccion}</p>
                        <p style="margin: 10px 0;">${robo.detalles}</p>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="action-btn" onclick="event.stopPropagation(); navegarAUbicacion(${robo.coordenadas.lat}, ${robo.coordenadas.lng})">
                                <span>üó∫Ô∏è</span> Navegar
                            </button>
                            <button class="action-btn" onclick="event.stopPropagation(); agendarVisitaRobo(${robo.id})" style="background: #3b82f6;">
                                <span>üìÖ</span> Agendar visita
                            </button>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function reportarNuevoRobo() {
            const direccion = document.getElementById('nueva-direccion').value;
            const municipio = document.getElementById('nuevo-municipio').value;
            const hora = document.getElementById('nueva-hora').value;
            const detalles = document.getElementById('nuevos-detalles').value;
            const prioridad = document.querySelector('input[name="prioridad"]:checked').value;
            
            if (!direccion || !municipio || !detalles) {
                mostrarNotificacion('‚ö†Ô∏è Campos requeridos', 'Completa todos los campos obligatorios');
                return;
            }
            
            // Obtener coordenadas de la direcci√≥n
            geocoder.geocode({ address: direccion + ', ' + municipio + ', C√≥rdoba, Espa√±a' }, function(results, status) {
                if (status !== 'OK' || !results[0]) {
                    mostrarNotificacion('‚ùå Error de geocodificaci√≥n', 'No se pudo encontrar la direcci√≥n. Usa coordenadas manuales.');
                    return;
                }
                
                const location = results[0].geometry.location;
                const coordenadas = { lat: location.lat(), lng: location.lng() };
                
                // Crear nuevo robo
                const nuevoRobo = {
                    id: Date.now(),
                    direccion: direccion,
                    municipio: municipio,
                    zona: "Por determinar",
                    tipo: "Robo reportado",
                    detalles: detalles,
                    fecha: hora ? new Date(hora) : new Date(),
                    prioridad: prioridad,
                    coordenadas: coordenadas,
                    codigoPostal: "14000"
                };
                
                // A√±adir a la lista
                robos.unshift(nuevoRobo);
                
                // Actualizar interfaces
                cargarUltimosRobos();
                cargarListaRobosCompleta();
                actualizarEstadisticas();
                
                // A√±adir marcador al mapa si est√° inicializado
                if (mapa) {
                    agregarMarcadorRobo(nuevoRobo);
                }
                
                // Guardar en localStorage
                guardarEnLocalStorage();
                
                // Limpiar formulario
                document.getElementById('nueva-direccion').value = '';
                document.getElementById('nuevo-municipio').value = '';
                document.getElementById('nueva-hora').value = '';
                document.getElementById('nuevos-detalles').value = '';
                
                mostrarNotificacion('üö® Robo reportado', `Nuevo incidente a√±adido en ${municipio}`);
            });
        }
        
        function agregarMarcadorRobo(robo) {
            if (!mapa || !robo.coordenadas) return;
            
            const color = robo.prioridad === 'alta' ? '#dc2626' : 
                         robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
            
            const marker = new google.maps.Marker({
                position: robo.coordenadas,
                map: mapa,
                title: `Robo en ${robo.municipio}`,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: color,
                    fillOpacity: 0.9,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                    scale: 12
                },
                animation: google.maps.Animation.DROP
            });
            
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding: 15px; min-width: 250px;">
                        <h3 style="margin: 0 0 10px 0; color: ${color};">üö® ${robo.tipo}</h3>
                        <p><strong>üìç Ubicaci√≥n:</strong> ${robo.direccion}</p>
                        <p><strong>üèòÔ∏è Municipio:</strong> ${robo.municipio}</p>
                        <p><strong>üéØ Prioridad:</strong> <span style="color: ${color}; font-weight: bold;">${robo.prioridad.toUpperCase()}</span></p>
                        <p><strong>üìù Detalles:</strong> ${robo.detalles}</p>
                        <div style="margin-top: 15px;">
                            <button onclick="navegarAUbicacion(${robo.coordenadas.lat}, ${robo.coordenadas.lng})" style="
                                background: ${color};
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">
                                üó∫Ô∏è Navegar aqu√≠
                            </button>
                        </div>
                    </div>
                `
            });
            
            marker.addListener('click', () => {
                infoWindow.open(mapa, marker);
            });
            
            marcadores.push(marker);
            actualizarContadorMarcadores();
            
            // Centrar en el nuevo marcador
            mapa.setCenter(robo.coordenadas);
            mapa.setZoom(15);
        }
        
        function mostrarRoboEnMapa(id) {
            const robo = robos.find(r => r.id === id);
            if (!robo || !robo.coordenadas || !mapa) return;
            
            mostrarSeccion('mapa');
            
            // Centrar mapa en el robo
            mapa.setCenter(robo.coordenadas);
            mapa.setZoom(16);
            
            // Encontrar y resaltar el marcador
            marcadores.forEach(marker => {
                const position = marker.getPosition();
                if (position && 
                    Math.abs(position.lat() - robo.coordenadas.lat) < 0.0001 &&
                    Math.abs(position.lng() - robo.coordenadas.lng) < 0.0001) {
                    marker.setAnimation(google.maps.Animation.BOUNCE);
                    setTimeout(() => marker.setAnimation(null), 1500);
                }
            });
            
            mostrarPanelInfoRobo(robo);
        }
        
        function agendarVisitaRobo(id) {
            const robo = robos.find(r => r.id === id);
            if (!robo) return;
            
            agendarVisitaUbicacion(robo.coordenadas.lat, robo.coordenadas.lng, robo.direccion);
        }
        
        function verDetallesRobo(id) {
            const robo = robos.find(r => r.id === id);
            if (!robo) return;
            
            const color = robo.prioridad === 'alta' ? '#dc2626' : 
                         robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
            
            alert(
                `üö® DETALLES COMPLETOS DEL ROBO\n\n` +
                `üìç Direcci√≥n: ${robo.direccion}\n` +
                `üèòÔ∏è Municipio: ${robo.municipio}\n` +
                `üìå Zona: ${robo.zona}\n` +
                `üö® Tipo: ${robo.tipo}\n` +
                `üéØ Prioridad: ${robo.prioridad.toUpperCase()}\n` +
                `üïí Fecha/Hora: ${robo.fecha.toLocaleString()}\n` +
                `üìû C√≥digo postal: ${robo.codigoPostal}\n` +
                `üéØ Coordenadas: ${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}\n\n` +
                `üìù Detalles:\n${robo.detalles}\n\n` +
                `üí° Acciones recomendadas:\n` +
                `1. Visitar la ubicaci√≥n lo antes posible\n` +
                `2. Contactar con los afectados\n` +
                `3. Ofrecer sistema de seguridad adecuado\n` +
                `4. Seguimiento en 48 horas`
            );
        }
        
        // ===== AGENDA DE VISITAS =====
        function cargarAgendaHoy() {
            const contenedor = document.getElementById('agenda-hoy');
            if (!contenedor) return;
            
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const manana = new Date(hoy);
            manana.setDate(manana.getDate() + 1);
            
            const visitasHoy = agenda.filter(visita => {
                const fechaVisita = new Date(visita.fecha);
                fechaVisita.setHours(0, 0, 0, 0);
                return fechaVisita.getTime() === hoy.getTime();
            });
            
            if (visitasHoy.length === 0) {
                contenedor.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No hay visitas programadas para hoy</p>';
                return;
            }
            
            let html = '';
            visitasHoy.forEach(visita => {
                const hora = visita.fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                html += `
                    <div class="cita-item">
                        <div class="cita-fecha">üïí ${hora}</div>
                        <h3 style="margin: 0 0 10px 0; color: #1e40af;">${visita.cliente}</h3>
                        <p><strong>üìç Direcci√≥n:</strong> ${visita.direccion}</p>
                        <p><strong>üèòÔ∏è Municipio:</strong> ${visita.municipio}</p>
                        <p><strong>üìû Tel√©fono:</strong> ${visita.telefono}</p>
                        <p><strong>üìù Motivo:</strong> ${visita.motivo}</p>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="navegarAVisita(${visita.id})" style="
                                background: #10b981;
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">
                                üó∫Ô∏è Navegar
                            </button>
                            <button onclick="editarVisita(${visita.id})" style="
                                background: #f59e0b;
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="eliminarVisita(${visita.id})" style="
                                background: #dc2626;
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function cargarListaAgendaCompleta() {
            const contenedor = document.getElementById('lista-agenda-completa');
            if (!contenedor) return;
            
            // Ordenar por fecha
            const agendaOrdenada = [...agenda].sort((a, b) => a.fecha - b.fecha);
            
            if (agendaOrdenada.length === 0) {
                contenedor.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No hay visitas programadas</p>';
                return;
            }
            
            let html = '';
            agendaOrdenada.forEach(visita => {
                const fechaFormateada = visita.fecha.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div class="cita-item">
                        <div class="cita-fecha">üìÖ ${fechaFormateada}</div>
                        <h3 style="margin: 0 0 10px 0; color: #1e40af;">${visita.cliente}</h3>
                        <p><strong>üìç Direcci√≥n:</strong> ${visita.direccion}</p>
                        <p><strong>üèòÔ∏è Municipio:</strong> ${visita.municipio}</p>
                        <p><strong>üìû Tel√©fono:</strong> ${visita.telefono}</p>
                        <p><strong>üìù Motivo:</strong> ${visita.motivo}</p>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="navegarAVisita(${visita.id})" style="
                                background: #10b981;
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">
                                üó∫Ô∏è Navegar
                            </button>
                            <button onclick="editarVisita(${visita.id})" style="
                                background: #f59e0b;
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="eliminarVisita(${visita.id})" style="
                                background: #dc2626;
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function agregarVisita() {
            const cliente = document.getElementById('cliente-visita').value;
            const direccion = document.getElementById('direccion-visita').value;
            const municipio = document.getElementById('municipio-visita').value;
            const fecha = document.getElementById('fecha-visita').value;
            const hora = document.getElementById('hora-visita').value;
            const motivo = document.getElementById('motivo-visita').value;
            const telefono = document.getElementById('telefono-visita').value;
            
            if (!cliente || !direccion || !municipio || !fecha || !hora || !motivo) {
                mostrarNotificacion('‚ö†Ô∏è Campos requeridos', 'Completa todos los campos obligatorios');
                return;
            }
            
            // Combinar fecha y hora
            const fechaHora = new Date(fecha + 'T' + hora);
            
            // Obtener coordenadas de la direcci√≥n
            geocoder.geocode({ address: direccion + ', ' + municipio + ', C√≥rdoba, Espa√±a' }, function(results, status) {
                let coordenadas = null;
                
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    coordenadas = { lat: location.lat(), lng: location.lng() };
                }
                
                // Crear nueva visita
                const nuevaVisita = {
                    id: Date.now(),
                    cliente: cliente,
                    direccion: direccion,
                    municipio: municipio,
                    fecha: fechaHora,
                    motivo: motivo,
                    telefono: telefono,
                    prioridad: 'media',
                    coordenadas: coordenadas
                };
                
                // A√±adir a la agenda
                agenda.push(nuevaVisita);
                
                // Ordenar por fecha
                agenda.sort((a, b) => a.fecha - b.fecha);
                
                // Actualizar interfaces
                cargarAgendaHoy();
                cargarListaAgendaCompleta();
                actualizarEstadisticas();
                
                // Guardar en localStorage
                guardarEnLocalStorage();
                
                // Limpiar formulario
                limpiarFormularioVisita();
                
                mostrarNotificacion('‚úÖ Visita agendada', `${cliente} a√±adido a la agenda para ${fechaHora.toLocaleDateString()}`);
            });
        }
        
        function limpiarFormularioVisita() {
            document.getElementById('cliente-visita').value = '';
            document.getElementById('direccion-visita').value = '';
            document.getElementById('municipio-visita').value = '';
            document.getElementById('fecha-visita').value = '';
            document.getElementById('hora-visita').value = '';
            document.getElementById('motivo-visita').value = '';
            document.getElementById('telefono-visita').value = '';
        }
        
        function navegarAVisita(id) {
            const visita = agenda.find(v => v.id === id);
            if (!visita || !visita.coordenadas) {
                mostrarNotificacion('‚ö†Ô∏è Ubicaci√≥n no disponible', 'No hay coordenadas para esta visita');
                return;
            }
            
            navegarAUbicacion(visita.coordenadas.lat, visita.coordenadas.lng);
        }
        
        function editarVisita(id) {
            const visita = agenda.find(v => v.id === id);
            if (!visita) return;
            
            // Rellenar formulario con datos de la visita
            document.getElementById('cliente-visita').value = visita.cliente;
            document.getElementById('direccion-visita').value = visita.direccion;
            document.getElementById('municipio-visita').value = visita.municipio;
            document.getElementById('fecha-visita').value = visita.fecha.toISOString().split('T')[0];
            document.getElementById('hora-visita').value = visita.fecha.toTimeString().slice(0,5);
            document.getElementById('motivo-visita').value = visita.motivo;
            document.getElementById('telefono-visita').value = visita.telefono;
            
            // Eliminar la visita antigua
            eliminarVisita(id, false);
            
            // Desplazar a la secci√≥n de agenda
            mostrarSeccion('agenda');
            
            mostrarNotificacion('‚úèÔ∏è Editar visita', 'Modifica los datos y haz clic en "Agregar Visita"');
        }
        
        function eliminarVisita(id, mostrarConfirmacion = true) {
            if (mostrarConfirmacion && !confirm('¬øEst√°s seguro de eliminar esta visita?')) {
                return;
            }
            
            const index = agenda.findIndex(v => v.id === id);
            if (index !== -1) {
                agenda.splice(index, 1);
                
                // Actualizar interfaces
                cargarAgendaHoy();
                cargarListaAgendaCompleta();
                actualizarEstadisticas();
                
                // Guardar en localStorage
                guardarEnLocalStorage();
                
                if (mostrarConfirmacion) {
                    mostrarNotificacion('üóëÔ∏è Visita eliminada', 'La visita ha sido eliminada de la agenda');
                }
            }
        }
        
        // ===== BLOC DE NOTAS =====
        function cargarNotasRecientes() {
            const contenedor = document.getElementById('notas-recientes');
            if (!contenedor) return;
            
            const notasRecientes = [...notas].sort((a, b) => b.fecha - a.fecha).slice(0, 3);
            
            if (notasRecientes.length === 0) {
                contenedor.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No hay notas recientes</p>';
                return;
            }
            
            let html = '';
            notasRecientes.forEach(nota => {
                const colorCategoria = getColorCategoria(nota.categoria);
                
                html += `
                    <div class="note-item">
                        <div class="note-date">
                            <span>üìÖ</span> ${nota.fecha.toLocaleDateString()} ‚Ä¢ 
                            <span style="background: ${colorCategoria}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">
                                ${nota.categoria.toUpperCase()}
                            </span>
                        </div>
                        <h3 style="margin: 0 0 10px 0; color: #d97706;">${nota.titulo}</h3>
                        <p style="white-space: pre-line;">${nota.contenido}</p>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="editarNota(${nota.id})" style="
                                background: #f59e0b;
                                color: white;
                                border: none;
                                padding: 6px 12px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                                font-size: 0.9rem;
                            ">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="eliminarNota(${nota.id})" style="
                                background: #dc2626;
                                color: white;
                                border: none;
                                padding: 6px 12px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                                font-size: 0.9rem;
                            ">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function cargarListaNotasCompleta() {
            const contenedor = document.getElementById('lista-notas-completa');
            if (!contenedor) return;
            
            // Ordenar por fecha (m√°s recientes primero)
            const notasOrdenadas = [...notas].sort((a, b) => b.fecha - a.fecha);
            
            if (notasOrdenadas.length === 0) {
                contenedor.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No hay notas guardadas</p>';
                return;
            }
            
            let html = '';
            notasOrdenadas.forEach(nota => {
                const colorCategoria = getColorCategoria(nota.categoria);
                
                html += `
                    <div class="note-item">
                        <div class="note-date">
                            <span>üìÖ</span> ${nota.fecha.toLocaleDateString('es-ES', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })} ‚Ä¢ 
                            <span style="background: ${colorCategoria}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">
                                ${nota.categoria.toUpperCase()}
                            </span>
                        </div>
                        <h3 style="margin: 0 0 10px 0; color: #d97706;">${nota.titulo}</h3>
                        <p style="white-space: pre-line;">${nota.contenido}</p>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="editarNota(${nota.id})" style="
                                background: #f59e0b;
                                color: white;
                                border: none;
                                padding: 6px 12px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                                font-size: 0.9rem;
                            ">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="eliminarNota(${nota.id})" style="
                                background: #dc2626;
                                color: white;
                                border: none;
                                padding: 6px 12px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                                font-size: 0.9rem;
                            ">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function getColorCategoria(categoria) {
            switch(categoria) {
                case 'clientes': return '#3b82f6';
                case 'visitas': return '#10b981';
                case 'oportunidades': return '#8b5cf6';
                case 'recordatorio': return '#f59e0b';
                case 'idea': return '#ec4899';
                default: return '#6b7280';
            }
        }
        
        function agregarNota() {
            const titulo = document.getElementById('titulo-nota').value;
            const contenido = document.getElementById('contenido-nota').value;
            const categoria = document.getElementById('categoria-nota').value;
            
            if (!titulo || !contenido) {
                mostrarNotificacion('‚ö†Ô∏è Campos requeridos', 'Completa t√≠tulo y contenido');
                return;
            }
            
            // Crear nueva nota
            const nuevaNota = {
                id: Date.now(),
                titulo: titulo,
                contenido: contenido,
                fecha: new Date(),
                categoria: categoria,
                prioridad: 'media'
            };
            
            // A√±adir a las notas
            notas.unshift(nuevaNota);
            
            // Actualizar interfaces
            cargarNotasRecientes();
            cargarListaNotasCompleta();
            
            // Guardar en localStorage
            guardarEnLocalStorage();
            
            // Limpiar formulario
            limpiarFormularioNota();
            
            mostrarNotificacion('üìù Nota guardada', 'Tu nota se ha guardado correctamente');
        }
        
        function limpiarFormularioNota() {
            document.getElementById('titulo-nota').value = '';
            document.getElementById('contenido-nota').value = '';
            document.getElementById('categoria-nota').value = 'general';
        }
        
        function editarNota(id) {
            const nota = notas.find(n => n.id === id);
            if (!nota) return;
            
            // Rellenar formulario con datos de la nota
            document.getElementById('titulo-nota').value = nota.titulo;
            document.getElementById('contenido-nota').value = nota.contenido;
            document.getElementById('categoria-nota').value = nota.categoria;
            
            // Eliminar la nota antigua
            eliminarNota(id, false);
            
            // Desplazar a la secci√≥n de notas
            mostrarSeccion('notas');
            
            mostrarNotificacion('‚úèÔ∏è Editar nota', 'Modifica los datos y haz clic en "Guardar Nota"');
        }
        
        function eliminarNota(id, mostrarConfirmacion = true) {
            if (mostrarConfirmacion && !confirm('¬øEst√°s seguro de eliminar esta nota?')) {
                return;
            }
            
            const index = notas.findIndex(n => n.id === id);
            if (index !== -1) {
                notas.splice(index, 1);
                
                // Actualizar interfaces
                cargarNotasRecientes();
                cargarListaNotasCompleta();
                
                // Guardar en localStorage
                guardarEnLocalStorage();
                
                if (mostrarConfirmacion) {
                    mostrarNotificacion('üóëÔ∏è Nota eliminada', 'La nota ha sido eliminada');
                }
            }
        }
        
        // ===== B√öSQUEDA AVANZADA =====
        function ejecutarBusqueda() {
            const keyword = document.getElementById('busqueda-keyword').value.toLowerCase();
            const municipio = document.getElementById('busqueda-municipio').value;
            const fechaDesde = document.getElementById('busqueda-fecha-desde').value;
            const fechaHasta = document.getElementById('busqueda-fecha-hasta').value;
            const tipo = document.getElementById('busqueda-tipo').value;
            const prioridad = document.getElementById('busqueda-prioridad').value;
            const codigoPostal = document.getElementById('busqueda-cp').value;
            
            let resultados = [];
            
            // Buscar en robos
            if (!tipo || tipo === 'robo') {
                robos.forEach(robo => {
                    if (cumpleCriteriosRobo(robo, keyword, municipio, fechaDesde, fechaHasta, prioridad, codigoPostal)) {
                        resultados.push({
                            tipo: 'robo',
                            objeto: robo,
                            fecha: robo.fecha,
                            relevancia: calcularRelevanciaRobo(robo, keyword)
                        });
                    }
                });
            }
            
            // Buscar en visitas
            if (!tipo || tipo === 'visita') {
                agenda.forEach(visita => {
                    if (cumpleCriteriosVisita(visita, keyword, municipio, fechaDesde, fechaHasta, prioridad)) {
                        resultados.push({
                            tipo: 'visita',
                            objeto: visita,
                            fecha: visita.fecha,
                            relevancia: calcularRelevanciaVisita(visita, keyword)
                        });
                    }
                });
            }
            
            // Buscar en notas
            if (!tipo || tipo === 'nota') {
                notas.forEach(nota => {
                    if (cumpleCriteriosNota(nota, keyword, fechaDesde, fechaHasta, prioridad)) {
                        resultados.push({
                            tipo: 'nota',
                            objeto: nota,
                            fecha: nota.fecha,
                            relevancia: calcularRelevanciaNota(nota, keyword)
                        });
                    }
                });
            }
            
            // Ordenar por relevancia y fecha
            resultados.sort((a, b) => {
                if (b.relevancia !== a.relevancia) {
                    return b.relevancia - a.relevancia;
                }
                return b.fecha - a.fecha;
            });
            
            mostrarResultadosBusquedaAvanzada(resultados);
        }
        
        function cumpleCriteriosRobo(robo, keyword, municipio, fechaDesde, fechaHasta, prioridad, codigoPostal) {
            // Filtro por palabra clave
            if (keyword && !(
                robo.direccion.toLowerCase().includes(keyword) ||
                robo.municipio.toLowerCase().includes(keyword) ||
                robo.zona.toLowerCase().includes(keyword) ||
                robo.tipo.toLowerCase().includes(keyword) ||
                robo.detalles.toLowerCase().includes(keyword)
            )) {
                return false;
            }
            
            // Filtro por municipio
            if (municipio && robo.municipio !== municipio) {
                return false;
            }
            
            // Filtro por fechas
            if (fechaDesde && new Date(robo.fecha) < new Date(fechaDesde)) {
                return false;
            }
            if (fechaHasta && new Date(robo.fecha) > new Date(fechaHasta + 'T23:59:59')) {
                return false;
            }
            
            // Filtro por prioridad
            if (prioridad && robo.prioridad !== prioridad) {
                return false;
            }
            
            // Filtro por c√≥digo postal
            if (codigoPostal && (!robo.codigoPostal || !robo.codigoPostal.includes(codigoPostal))) {
                return false;
            }
            
            return true;
        }
        
        function calcularRelevanciaRobo(robo, keyword) {
            if (!keyword) return 1;
            
            let relevancia = 0;
            const keywordLower = keyword.toLowerCase();
            
            if (robo.direccion.toLowerCase().includes(keywordLower)) relevancia += 3;
            if (robo.municipio.toLowerCase().includes(keywordLower)) relevancia += 2;
            if (robo.tipo.toLowerCase().includes(keywordLower)) relevancia += 2;
            if (robo.detalles.toLowerCase().includes(keywordLower)) relevancia += 1;
            if (robo.zona.toLowerCase().includes(keywordLower)) relevancia += 1;
            
            return relevancia;
        }
        
        function mostrarResultadosBusquedaAvanzada(resultados) {
            const contenedor = document.getElementById('resultados-busqueda');
            
            if (resultados.length === 0) {
                contenedor.innerHTML = `
                    <h3 style="color: #1e40af; margin-bottom: 20px;">üîç Resultados de la B√∫squeda</h3>
                    <div style="text-align: center; padding: 50px; color: #6b7280; background: #f8fafc; border-radius: 12px;">
                        <p style="font-size: 1.2rem;">No se encontraron resultados</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">Prueba con otros criterios de b√∫squeda</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <h3 style="color: #1e40af; margin-bottom: 20px;">üîç Resultados de la B√∫squeda (${resultados.length} encontrados)</h3>
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="control-btn" onclick="filtrarResultadosPorTipo('todos')">
                        Todos (${resultados.length})
                    </button>
                    <button class="control-btn secondary" onclick="filtrarResultadosPorTipo('robo')">
                        Robos (${resultados.filter(r => r.tipo === 'robo').length})
                    </button>
                    <button class="control-btn" onclick="filtrarResultadosPorTipo('visita')">
                        Visitas (${resultados.filter(r => r.tipo === 'visita').length})
                    </button>
                    <button class="control-btn warning" onclick="filtrarResultadosPorTipo('nota')">
                        Notas (${resultados.filter(r => r.tipo === 'nota').length})
                    </button>
                </div>
            `;
            
            resultados.forEach((resultado, index) => {
                if (resultado.tipo === 'robo') {
                    const robo = resultado.objeto;
                    const color = robo.prioridad === 'alta' ? '#dc2626' : 
                                 robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
                    
                    html += `
                        <div class="robo-alert" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="background: ${color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                    üö® ROBO
                                </span>
                                <span style="color: #6b7280; font-size: 0.9rem;">${formatearTiempoRelativo(robo.fecha)}</span>
                            </div>
                            <h3 style="margin: 0 0 10px 0; color: ${color};">${robo.tipo}</h3>
                            <p><strong>üìç ${robo.direccion}</strong></p>
                            <p><strong>üèòÔ∏è ${robo.municipio}</strong> ‚Ä¢ ${robo.zona}</p>
                            <p style="margin: 10px 0;">${robo.detalles}</p>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="action-btn" onclick="mostrarRoboEnMapa(${robo.id})">
                                    üó∫Ô∏è Ver en mapa
                                </button>
                                <button class="action-btn" onclick="navegarAUbicacion(${robo.coordenadas.lat}, ${robo.coordenadas.lng})" style="background: #10b981;">
                                    üöó Navegar
                                </button>
                            </div>
                        </div>
                    `;
                } else if (resultado.tipo === 'visita') {
                    const visita = resultado.objeto;
                    
                    html += `
                        <div class="cita-item" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                    üìÖ VISITA
                                </span>
                                <span style="color: #6b7280; font-size: 0.9rem;">${formatearFechaHora(visita.fecha)}</span>
                            </div>
                            <h3 style="margin: 0 0 10px 0; color: #1e40af;">${visita.cliente}</h3>
                            <p><strong>üìç Direcci√≥n:</strong> ${visita.direccion}</p>
                            <p><strong>üèòÔ∏è Municipio:</strong> ${visita.municipio}</p>
                            <p><strong>üìù Motivo:</strong> ${visita.motivo}</p>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button onclick="navegarAVisita(${visita.id})" style="
                                    background: #10b981;
                                    color: white;
                                    border: none;
                                    padding: 8px 15px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-weight: bold;
                                ">
                                    üó∫Ô∏è Navegar
                                </button>
                                <button onclick="editarVisita(${visita.id})" style="
                                    background: #f59e0b;
                                    color: white;
                                    border: none;
                                    padding: 8px 15px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-weight: bold;
                                ">
                                    ‚úèÔ∏è Editar
                                </button>
                            </div>
                        </div>
                    `;
                } else if (resultado.tipo === 'nota') {
                    const nota = resultado.objeto;
                    const colorCategoria = getColorCategoria(nota.categoria);
                    
                    html += `
                        <div class="note-item" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="background: ${colorCategoria}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                    üìù NOTA
                                </span>
                                <span style="color: #6b7280; font-size: 0.9rem;">${nota.fecha.toLocaleDateString()}</span>
                            </div>
                            <h3 style="margin: 0 0 10px 0; color: #d97706;">${nota.titulo}</h3>
                            <p style="white-space: pre-line;">${nota.contenido}</p>
                            <div style="margin-top: 15px;">
                                <button onclick="editarNota(${nota.id})" style="
                                    background: #f59e0b;
                                    color: white;
                                    border: none;
                                    padding: 6px 12px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-weight: bold;
                                ">
                                    ‚úèÔ∏è Editar
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
            
            contenedor.innerHTML = html;
        }
        
        function filtrarResultadosPorTipo(tipo) {
            // Esta funci√≥n se implementar√≠a para filtrar los resultados mostrados
            mostrarNotificacion('üîç Filtro aplicado', `Mostrando solo resultados de tipo: ${tipo}`);
        }
        
        function limpiarBusqueda() {
            document.getElementById('busqueda-keyword').value = '';
            document.getElementById('busqueda-municipio').value = '';
            document.getElementById('busqueda-fecha-desde').value = '';
            document.getElementById('busqueda-fecha-hasta').value = '';
            document.getElementById('busqueda-tipo').value = '';
            document.getElementById('busqueda-prioridad').value = '';
            document.getElementById('busqueda-cp').value = '';
            
            document.getElementById('resultados-busqueda').innerHTML = `
                <h3 style="color: #1e40af; margin-bottom: 20px;">üìã Resultados de la B√∫squeda</h3>
                <div style="text-align: center; padding: 50px; color: #6b7280; background: #f8fafc; border-radius: 12px;">
                    <p style="font-size: 1.2rem;">Introduce criterios de b√∫squeda y haz clic en "Ejecutar B√∫squeda"</p>
                    <p style="margin-top: 10px; font-size: 0.9rem;">Puedes buscar por municipio, fecha, tipo, prioridad o palabra clave</p>
                </div>
            `;
            
            mostrarNotificacion('üóëÔ∏è B√∫squeda limpiada', 'Todos los filtros han sido restablecidos');
        }
        
        function exportarResultados() {
            const datos = {
                robos: robos,
                agenda: agenda,
                notas: notas,
                fechaExportacion: new Date().toISOString(),
                totalResultados: robos.length + agenda.length + notas.length
            };
            
            const datosStr = JSON.stringify(datos, null, 2);
            const blob = new Blob([datosStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `localizador-alarmas-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacion('üì§ Datos exportados', 'Todos los datos han sido descargados en formato JSON');
        }
        
        // ===== AN√ÅLISIS Y ESTAD√çSTICAS =====
        function cargarAnalisisMunicipios() {
            const contenedor = document.getElementById('analisis-municipios');
            if (!contenedor) return;
            
            // Agrupar robos por municipio
            const robosPorMunicipio = {};
            robos.forEach(robo => {
                if (!robosPorMunicipio[robo.municipio]) {
                    robosPorMunicipio[robo.municipio] = {
                        total: 0,
                        alta: 0,
                        media: 0,
                        baja: 0
                    };
                }
                robosPorMunicipio[robo.municipio].total++;
                robosPorMunicipio[robo.municipio][robo.prioridad]++;
            });
            
            // Agrupar visitas por municipio
            const visitasPorMunicipio = {};
            agenda.forEach(visita => {
                if (!visitasPorMunicipio[visita.municipio]) {
                    visitasPorMunicipio[visita.municipio] = 0;
                }
                visitasPorMunicipio[visita.municipio]++;
            });
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            
            // Municipios principales
            const municipiosPrincipales = ['C√ìRDOBA', 'LUCENA', 'PUENTE GENIL', 'MONTILLA', 'PRIEGO', 'CABRA'];
            
            municipiosPrincipales.forEach(municipio => {
                const robosData = robosPorMunicipio[municipio] || { total: 0, alta: 0, media: 0, baja: 0 };
                const visitasData = visitasPorMunicipio[municipio] || 0;
                
                // Calcular prioridad basada en robos
                let prioridad = 'baja';
                if (robosData.alta >= 2 || robosData.total >= 5) prioridad = 'alta';
                else if (robosData.total >= 2) prioridad = 'media';
                
                const color = prioridad === 'alta' ? '#dc2626' : 
                             prioridad === 'media' ? '#f59e0b' : '#10b981';
                
                html += `
                    <div style="background: white; padding: 20px; border-radius: 10px; border-left: 5px solid ${color};">
                        <h4 style="margin: 0 0 15px 0; color: ${color};">${municipio}</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #dc2626;">${robosData.total}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">Robos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #10b981;">${visitasData}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">Visitas</div>
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 10px;">
                            <div>üî¥ Alta: ${robosData.alta} ‚Ä¢ üü° Media: ${robosData.media} ‚Ä¢ üü¢ Baja: ${robosData.baja}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="background: ${color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                ${prioridad.toUpperCase()}
                            </span>
                            <button onclick="mostrarEnMapa('${municipio}')" style="
                                background: #3b82f6;
                                color: white;
                                border: none;
                                padding: 6px 12px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                                font-size: 0.8rem;
                            ">
                                üó∫Ô∏è Ver mapa
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contenedor.innerHTML = html;
        }
        
        function cargarRecomendaciones() {
            const contenedor = document.getElementById('recomendaciones-lista');
            if (!contenedor) return;
            
            // Analizar datos para generar recomendaciones
            const recomendaciones = [];
            
            // Recomendaci√≥n basada en robos recientes
            const robosRecientes = robos.filter(r => 
                (new Date() - r.fecha) < 24 * 60 * 60 * 1000 // √öltimas 24 horas
            );
            
            if (robosRecientes.length >= 3) {
                const municipioMasAfectado = robosRecientes.reduce((acc, robo) => {
                    acc[robo.municipio] = (acc[robo.municipio] || 0) + 1;
                    return acc;
                }, {});
                
                const municipio = Object.keys(municipioMasAfectado).reduce((a, b) => 
                    municipioMasAfectado[a] > municipioMasAfectado[b] ? a : b
                );
                
                recomendaciones.push({
                    tipo: 'urgente',
                    texto: `üö® <strong>URGENTE:</strong> ${municipio} tiene ${robosRecientes.length} robos en las √∫ltimas 24 horas. Prioriza visitas en esta zona.`
                });
            }
            
            // Recomendaci√≥n basada en visitas pr√≥ximas
            const visitasHoy = agenda.filter(v => {
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                const fechaVisita = new Date(v.fecha);
                fechaVisita.setHours(0, 0, 0, 0);
                return fechaVisita.getTime() === hoy.getTime();
            });
            
            if (visitasHoy.length > 0) {
                recomendaciones.push({
                    tipo: 'recordatorio',
                    texto: `üìÖ <strong>RECORDATORIO:</strong> Tienes ${visitasHoy.length} visitas programadas para hoy. Revisa la agenda.`
                });
            }
            
            // Recomendaci√≥n basada en oportunidades
            const municipiosConRobos = [...new Set(robos.map(r => r.municipio))];
            if (municipiosConRobos.length > 0) {
                recomendaciones.push({
                    tipo: 'oportunidad',
                    texto: `üí∞ <strong>OPORTUNIDAD:</strong> ${municipiosConRobos.length} municipios tienen robos recientes. Enfoca esfuerzos comerciales en estas zonas.`
                });
            }
            
            // Recomendaci√≥n general
            recomendaciones.push({
                tipo: 'sugerencia',
                texto: `üí° <strong>SUGERENCIA:</strong> Usa la funci√≥n de navegaci√≥n para optimizar rutas entre visitas y ahorrar tiempo.`
            });
            
            let html = '';
            recomendaciones.forEach(rec => {
                const color = rec.tipo === 'urgente' ? '#dc2626' : 
                             rec.tipo === 'recordatorio' ? '#f59e0b' : 
                             rec.tipo === 'oportunidad' ? '#10b981' : '#3b82f6';
                
                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${color};">
                        <div style="color: ${color}; font-weight: bold; margin-bottom: 5px;">${rec.tipo.toUpperCase()}</div>
                        <div>${rec.texto}</div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function actualizarEstadisticas() {
            // Actualizar contadores
            document.getElementById('total-robos').textContent = robos.length;
            document.getElementById('total-visitas').textContent = agenda.length;
            document.getElementById('municipios-activos').textContent = [...new Set(robos.map(r => r.municipio))].length;
            document.getElementById('oportunidades').textContent = Math.floor(robos.length * 1.5); // Estimaci√≥n
            
            // Estad√≠sticas detalladas
            document.getElementById('robos-totales').textContent = robos.length;
            document.getElementById('visitas-totales').textContent = agenda.length;
            
            // Calcular tasa de conversi√≥n (estimada)
            const tasaConversion = agenda.length > 0 ? Math.min(100, Math.floor((robos.length / agenda.length) * 100)) : 0;
            document.getElementById('conversion-rate').textContent = `${tasaConversion}%`;
            
            // Calcular ingresos estimados
            const ingresosEstimados = agenda.length * 500; // 500‚Ç¨ por visita estimada
            document.getElementById('ingresos-estimados').textContent = `‚Ç¨${(ingresosEstimados/1000).toFixed(1)}K`;
            
            // Actualizar contador de robos activos
            const robosRecientes = robos.filter(r => (new Date() - r.fecha) < 24 * 60 * 60 * 1000);
            document.getElementById('robos-activos').textContent = `üö® ${robosRecientes.length} robos activos`;
        }
        
        // ===== FUNCIONES UTILITARIAS =====
        function mostrarSeccion(seccion) {
            // Ocultar todas las secciones
            document.querySelectorAll('.seccion').forEach(s => {
                s.style.display = 'none';
            });
            
            // Remover active de todas las pesta√±as
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
            });
            
            // Mostrar secci√≥n seleccionada
            document.getElementById(seccion).style.display = 'block';
            
            // Marcar pesta√±a como activa
            event.target.classList.add('active');
            
            // Inicializar mapa si es necesario
            if (seccion === 'mapa' && typeof google !== 'undefined' && !mapa) {
                setTimeout(initMap, 500);
            }
            
            // Actualizar datos espec√≠ficos de la secci√≥n
            if (seccion === 'robos') {
                cargarListaRobosCompleta();
            } else if (seccion === 'agenda') {
                cargarAgendaHoy();
                cargarListaAgendaCompleta();
            } else if (seccion === 'notas') {
                cargarNotasRecientes();
                cargarListaNotasCompleta();
            } else if (seccion === 'analisis') {
                cargarAnalisisMunicipios();
                cargarRecomendaciones();
                actualizarEstadisticas();
            }
        }
        
        function formatearTiempoRelativo(fecha) {
            const ahora = new Date();
            const diferencia = ahora - new Date(fecha);
            
            const segundos = Math.floor(diferencia / 1000);
            const minutos = Math.floor(segundos / 60);
            const horas = Math.floor(minutos / 60);
            const dias = Math.floor(horas / 24);
            
            if (dias > 0) {
                return `Hace ${dias} ${dias === 1 ? 'd√≠a' : 'd√≠as'}`;
            } else if (horas > 0) {
                return `Hace ${horas} ${horas === 1 ? 'hora' : 'horas'}`;
            } else if (minutos > 0) {
                return `Hace ${minutos} ${minutos === 1 ? 'minuto' : 'minutos'}`;
            } else {
                return 'Ahora mismo';
            }
        }
        
        function formatearFechaHora(fecha) {
            return new Date(fecha).toLocaleDateString('es-ES', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function configurarFechasFormularios() {
            const hoy = new Date().toISOString().split('T')[0];
            const manana = new Date();
            manana.setDate(manana.getDate() + 1);
            const mananaStr = manana.toISOString().split('T')[0];
            
            // Fecha m√≠nima para formularios
            const fechaInputs = document.querySelectorAll('input[type="date"]');
            fechaInputs.forEach(input => {
                input.min = hoy;
                if (!input.value) {
                    input.value = hoy;
                }
            });
            
            // Configurar fecha de visita por defecto a ma√±ana
            const fechaVisita = document.getElementById('fecha-visita');
            if (fechaVisita && !fechaVisita.value) {
                fechaVisita.value = mananaStr;
            }
        }
        
        function actualizarHora() {
            const ahora = new Date();
            const hora = ahora.getHours().toString().padStart(2, '0');
            const minutos = ahora.getMinutes().toString().padStart(2, '0');
            
            document.getElementById('hora-actual').textContent = `${hora}:${minutos}`;
            document.getElementById('ultima-actualizacion').textContent = 
                `√öltima actualizaci√≥n: ${hora}:${minutos}`;
            
            setTimeout(actualizarHora, 60000);
        }
        
        function guardarEnLocalStorage() {
            try {
                localStorage.setItem('localizador_robos', JSON.stringify(robos));
                localStorage.setItem('localizador_agenda', JSON.stringify(agenda));
                localStorage.setItem('localizador_notas', JSON.stringify(notas));
            } catch (e) {
                console.error('Error guardando en localStorage:', e);
            }
        }
        
        function cargarDesdeLocalStorage() {
            try {
                const robosGuardados = localStorage.getItem('localizador_robos');
                const agendaGuardada = localStorage.getItem('localizador_agenda');
                const notasGuardadas = localStorage.getItem('localizador_notas');
                
                if (robosGuardados) {
                    const parsed = JSON.parse(robosGuardados);
                    parsed.forEach(r => r.fecha = new Date(r.fecha));
                    robos = parsed;
                }
                
                if (agendaGuardada) {
                    const parsed = JSON.parse(agendaGuardada);
                    parsed.forEach(a => a.fecha = new Date(a.fecha));
                    agenda = parsed;
                }
                
                if (notasGuardadas) {
                    const parsed = JSON.parse(notasGuardadas);
                    parsed.forEach(n => n.fecha = new Date(n.fecha));
                    notas = parsed;
                }
            } catch (e) {
                console.error('Error cargando desde localStorage:', e);
            }
        }
        
        // ===== NOTIFICACIONES =====
        function mostrarNotificacion(titulo, mensaje) {
            const notificacion = document.getElementById('notificacion');
            const tituloElem = document.getElementById('notificacion-titulo');
            const mensajeElem = document.getElementById('notificacion-mensaje');
            
            tituloElem.textContent = titulo;
            mensajeElem.textContent = mensaje;
            notificacion.style.display = 'block';
            
            // Reproducir sonido de notificaci√≥n
            reproducirSonidoNotificacion();
            
            // Vibrar si est√° disponible
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            // Ocultar autom√°ticamente despu√©s de 5 segundos
            setTimeout(cerrarNotificacion, 5000);
        }
        
        function cerrarNotificacion() {
            document.getElementById('notificacion').style.display = 'none';
        }
        
        function reproducirSonidoNotificacion() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                // Sonido no disponible
            }
        }
        
        // ===== MANEJO DE CONEXI√ìN =====
        window.addEventListener('online', () => {
            document.getElementById('estado-conexion').textContent = '‚úÖ Conectado';
            document.getElementById('estado-sistema').textContent = '‚úÖ Sistema activo';
            mostrarNotificacion('üåê Conexi√≥n restablecida', 'Sistema sincronizado');
        });
        
        window.addEventListener('offline', () => {
            document.getElementById('estado-conexion').textContent = '‚ö†Ô∏è Offline';
            document.getElementById('estado-sistema').textContent = '‚ö†Ô∏è Modo offline';
            mostrarNotificacion('‚ö†Ô∏è Sin conexi√≥n', 'Trabajando con datos locales');
        });
        
        // Cargar datos guardados al iniciar
        cargarDesdeLocalStorage();
        
        // Inicializar cuando se carga la API de Google Maps
        window.initMap = initMap;
    </script>
    // ===== CONFIGURACI√ìN EMAILJS =====
// Configuraci√≥n ACTUALIZADA para EmailJS
const EMAILJS_CONFIG = {
    PUBLIC_KEY: 'user_xxxxxxxxxxxx', // REEMPLAZA con tu Public Key
    SERVICE_ID: 'service_xxxxxxxx', // REEMPLAZA con tu Service ID
    TEMPLATE_ID: 'template_xxxxxxx' // REEMPLAZA con tu Template ID
};

// Variables globales
let mapa;
let marcadores = [];
let robos = [];
let agenda = [];
let notas = [];
let notificaciones = [];
let alertasEnviadas = [];
let miUbicacionMarker;
let watchId;

// Configuraci√≥n de alertas
let configAlertas = {
    correo: "avisosderobos@gmail.com",
    whatsapp: "621284357",
    alertaRobo: true,
    alertaVisita: false,
    alertaOportunidad: true,
    alertaRecordatorio: false
};

// ===== INICIALIZACI√ìN EMAILJS =====
function inicializarEmailJS() {
    // Inicializar EmailJS con tu clave p√∫blica
    if (EMAILJS_CONFIG.PUBLIC_KEY && EMAILJS_CONFIG.PUBLIC_KEY !== 'user_xxxxxxxxxxxx') {
        emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
        console.log("‚úÖ EmailJS inicializado correctamente");
        return true;
    } else {
        console.log("‚ö†Ô∏è EmailJS no configurado. Usando m√©todo alternativo.");
        return false;
    }
}

// ===== FUNCI√ìN MEJORADA PARA ENVIAR CORREOS =====
async function enviarAlertaCorreoCompleta(robo) {
    try {
        // Verificar que EmailJS est√© configurado
        if (!EMAILJS_CONFIG.PUBLIC_KEY || EMAILJS_CONFIG.PUBLIC_KEY === 'user_xxxxxxxxxxxx') {
            mostrarNotificacion('‚ö†Ô∏è Configura EmailJS', 'Configura EmailJS para recibir correos autom√°ticos');
            enviarCorreoAlternativo(robo);
            return;
        }

        // Preparar los datos para la plantilla
        const templateParams = {
            to_email: configAlertas.correo,
            direccion: robo.direccion,
            municipio: robo.municipio,
            prioridad: robo.prioridad.toUpperCase(),
            fecha: new Date(robo.fecha).toLocaleString('es-ES'),
            coordenadas: `${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}`,
            lat: robo.coordenadas.lat,
            lng: robo.coordenadas.lng,
            detalles: robo.detalles,
            tipo: robo.tipo,
            zona: robo.zona,
            codigo_postal: robo.codigoPostal
        };

        console.log("üìß Enviando correo con datos:", templateParams);

        // Enviar correo usando EmailJS
        const response = await emailjs.send(
            EMAILJS_CONFIG.SERVICE_ID,
            EMAILJS_CONFIG.TEMPLATE_ID,
            templateParams
        );

        if (response.status === 200) {
            console.log('‚úÖ Correo enviado exitosamente:', response);
            
            // Registrar en historial
            registrarAlertaEnviada({
                tipo: 'correo',
                destinatario: configAlertas.correo,
                titulo: `üö® Alerta: ${robo.municipio}`,
                mensaje: robo.detalles,
                fecha: new Date(),
                estado: 'enviado'
            });

            mostrarNotificacion('üìß Correo enviado', 'La alerta se ha enviado correctamente a tu correo');
            return true;
        } else {
            throw new Error('Error en respuesta de EmailJS');
        }

    } catch (error) {
        console.error('‚ùå Error al enviar correo:', error);
        
        // Registrar error
        registrarAlertaEnviada({
            tipo: 'correo',
            destinatario: configAlertas.correo,
            titulo: `üö® Alerta: ${robo.municipio}`,
            mensaje: robo.detalles,
            fecha: new Date(),
            estado: 'error'
        });

        // Usar m√©todo alternativo
        enviarCorreoAlternativo(robo);
        return false;
    }
}

// ===== M√âTODO ALTERNATIVO (mailto:) =====
function enviarCorreoAlternativo(robo) {
    const asunto = `üö® ALERTA DE ROBO: ${robo.municipio}`;
    const cuerpo = `
SISTEMA DE ALERTAS DE ROBOS
============================

üìç DIRECCI√ìN: ${robo.direccion}
üèòÔ∏è MUNICIPIO: ${robo.municipio}
üéØ ZONA: ${robo.zona}
üî¥ PRIORIDAD: ${robo.prioridad.toUpperCase()}
üö® TIPO: ${robo.tipo}
üïí FECHA/HORA: ${new Date(robo.fecha).toLocaleString('es-ES')}
üìù DETALLES: ${robo.detalles}
üéØ COORDENADAS: ${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}
üìÆ C√ìDIGO POSTAL: ${robo.codigoPostal}

üó∫Ô∏è VER EN GOOGLE MAPS:
https://www.google.com/maps?q=${robo.coordenadas.lat},${robo.coordenadas.lng}

üì± WHATSAPP INMEDIATO:
https://wa.me/621284357?text=Alerta%20de%20robo%20en%20${encodeURIComponent(robo.municipio)}%20-%20${encodeURIComponent(robo.direccion)}

============================
Sistema Autom√°tico de Alertas
avisosderobos@gmail.com
`;

    const mailtoLink = `mailto:${configAlertas.correo}?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
    
    // Abrir cliente de correo
    window.open(mailtoLink, '_blank');
    
    mostrarNotificacion('üìß Correo listo', 'Se ha abierto tu cliente de correo con todos los datos');
}

// ===== FUNCI√ìN COMPLETA DE ALERTA =====
async function enviarAlertaCompleta(roboId) {
    const robo = robos.find(r => r.id == roboId);
    
    if (!robo) {
        mostrarNotificacion('‚ùå Error', 'No se encontr√≥ el robo para enviar alerta');
        return;
    }

    // Enviar por EmailJS (correo autom√°tico)
    const correoEnviado = await enviarAlertaCorreoCompleta(robo);
    
    // Enviar por WhatsApp
    enviarAlertaWhatsAppCompleta(robo);
    
    // Marcar como notificado
    robo.notificado = true;
    
    // Actualizar estad√≠sticas
    actualizarEstadisticas();
    
    if (correoEnviado) {
        mostrarNotificacion('‚úÖ Alertas enviadas', 'Correo y WhatsApp enviados correctamente');
    }
}

// ===== WHATSAPP COMPLETO =====
function enviarAlertaWhatsAppCompleta(robo) {
    const numero = configAlertas.whatsapp.replace(/\D/g, '');
    
    const mensaje = `üö® *ALERTA DE ROBO* üö®

üìç *Direcci√≥n:* ${robo.direccion}
üèòÔ∏è *Municipio:* ${robo.municipio}
üéØ *Zona:* ${robo.zona}
üî¥ *Prioridad:* ${robo.prioridad.toUpperCase()}
üö® *Tipo:* ${robo.tipo}
üïí *Fecha/Hora:* ${new Date(robo.fecha).toLocaleString('es-ES')}
üìù *Detalles:* ${robo.detalles}
üéØ *Coordenadas:* ${robo.coordenadas.lat.toFixed(6)}, ${robo.coordenadas.lng.toFixed(6)}
üìÆ *C√≥digo Postal:* ${robo.codigoPostal}

üó∫Ô∏è *Google Maps:*
https://maps.google.com/?q=${robo.coordenadas.lat},${robo.coordenadas.lng}

‚ö†Ô∏è *ACCIONES INMEDIATAS:*
1. Verificar ubicaci√≥n en mapa
2. Contactar con afectados
3. Programar visita comercial
4. Ofrecer sistema de seguridad`;

    const mensajeCodificado = encodeURIComponent(mensaje);
    const whatsappLink = `https://wa.me/${numero}?text=${mensajeCodificado}`;
    
    window.open(whatsappLink, '_blank');
    
    registrarAlertaEnviada({
        tipo: 'whatsapp',
        destinatario: configAlertas.whatsapp,
        titulo: 'Alerta por WhatsApp',
        mensaje: robo.direccion,
        fecha: new Date(),
        estado: 'enviado'
    });
}
</body>
</html>
