<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOCALIZADOR DE ALARMAS - VERSI√ìN GRATIS</title>
    
    <!-- Leaflet CSS y JS (GRATIS) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Leaflet plugins gratuitos -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <style>
        /* [MANTENGO LOS MISMOS ESTILOS QUE ANTES] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f172a; color: white; }
        .app-container { max-width: 100%; min-height: 100vh; }
        
        .header { 
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            color: white; padding: 25px 20px; text-align: center;
            border-bottom: 4px solid #3b82f6;
        }
        .logo { font-size: 3.5rem; margin-bottom: 15px; }
        h1 { font-size: 2rem; margin-bottom: 10px; font-weight: 800; }
        
        /* TABS Y NAVEGACI√ìN */
        .tabs {
            display: flex; background: white; overflow-x: auto;
            border-bottom: 3px solid #e2e8f0; position: sticky; top: 0; z-index: 1000;
        }
        .tab {
            flex: 1; padding: 20px 15px; border: none; background: white;
            color: #4a5568; font-weight: bold; text-align: center;
            min-width: 120px; cursor: pointer; transition: all 0.3s ease;
        }
        .tab.active {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white; border-bottom: 3px solid #fbbf24;
        }
        
        /* MAPA LEAFLET */
        #mapa-leaflet {
            height: 600px; width: 100%; border-radius: 12px;
            margin: 20px 0; border: 3px solid #e5e7eb;
            z-index: 1;
        }
        
        /* MARCAS PERSONALIZADAS */
        .robo-marker {
            background: #dc2626; width: 30px; height: 30px;
            border-radius: 50% 50% 50% 0; transform: rotate(-45deg);
            border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .robo-marker::after {
            content: '!'; color: white; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg);
            font-weight: bold; font-size: 14px;
        }
        
        .visita-marker {
            background: #10b981; width: 25px; height: 25px;
            border-radius: 50%; border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .mi-ubicacion-marker {
            background: #3b82f6; width: 20px; height: 20px;
            border-radius: 50%; border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* CONTROLES DEL MAPA */
        .map-controls {
            display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap;
        }
        .control-btn {
            padding: 14px 25px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white; border: none; border-radius: 10px; cursor: pointer;
            font-weight: bold; transition: all 0.3s; display: flex; align-items: center; gap: 10px;
        }
        .control-btn:hover { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); }
        
        /* CONTENIDO */
        .content { padding: 25px; max-width: 1400px; margin: 0 auto; }
        .card {
            background: white; color: #1f2937; border-radius: 16px;
            padding: 30px; margin-bottom: 25px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }
        
        /* ALERTAS DE ROBOS */
        .robo-alert {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 6px solid #dc2626; padding: 25px; margin-bottom: 20px;
            border-radius: 12px; transition: all 0.3s; cursor: pointer;
        }
        .robo-alert:hover { transform: translateX(10px); }
        
        /* AGENDA */
        .cita-item {
            background: white; padding: 20px; border-radius: 10px;
            margin-bottom: 15px; border-left: 5px solid #3b82f6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        /* NOTAS */
        .note-item {
            background: white; padding: 20px; border-radius: 10px;
            margin-bottom: 15px; border-left: 5px solid #f59e0b;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        /* BUSCADOR */
        .search-box { display: flex; gap: 15px; margin-bottom: 20px; }
        .search-input { flex: 1; padding: 16px 20px; border: 2px solid #e5e7eb; border-radius: 10px; }
        
        /* ESTAD√çSTICAS */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px; margin: 30px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white; padding: 30px; border-radius: 16px; text-align: center;
        }
        .stat-number { font-size: 3.5rem; font-weight: 800; margin-bottom: 15px; }
        
        /* NOTIFICACIONES */
        .notification {
            position: fixed; bottom: 30px; right: 30px; background: white;
            color: #1f2937; padding: 25px; border-radius: 14px;
            box-shadow: 0 10px 35px rgba(0,0,0,0.2); display: none;
            z-index: 2000; border-left: 7px solid #3b82f6; max-width: 400px;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header { padding: 20px 15px; }
            .tab { min-width: 90px; padding: 16px 8px; font-size: 0.85rem; }
            #mapa-leaflet { height: 400px; }
            .search-box { flex-direction: column; }
        }
        
        @media (max-width: 480px) {
            #mapa-leaflet { height: 350px; }
            .tab { min-width: 80px; padding: 14px 6px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <!-- APP CONTAINER -->
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo">üö®</div>
            <h1>LOCALIZADOR DE ALARMAS - VERSI√ìN GRATIS</h1>
            <p class="subtitle">Leaflet.js + OpenStreetMap | Sin l√≠mites de uso | 100% Gratis</p>
            <div style="margin-top: 20px; font-size: 1rem;">
                <span id="estado-conexion">‚úÖ Conectado</span> | 
                <span id="hora-actual">--:--</span> |
                <span id="gps-status">üìç GPS: Activado</span>
            </div>
        </div>
        
        <!-- NAVEGACI√ìN -->
        <div class="tabs">
            <button class="tab active" onclick="mostrarSeccion('inicio')">üè† Inicio</button>
            <button class="tab" onclick="mostrarSeccion('mapa')">üó∫Ô∏è Mapa Gratis</button>
            <button class="tab" onclick="mostrarSeccion('robos')">üö® Robos</button>
            <button class="tab" onclick="mostrarSeccion('agenda')">üìÖ Agenda</button>
            <button class="tab" onclick="mostrarSeccion('notas')">üìù Notas</button>
            <button class="tab" onclick="mostrarSeccion('analisis')">üìä An√°lisis</button>
        </div>
        
        <!-- CONTENIDO -->
        <div class="content">
            <!-- SECCI√ìN INICIO -->
            <div id="inicio" class="seccion">
                <div class="card">
                    <h2 class="card-title">üö® SISTEMA COMPLETO GRATUITO</h2>
                    <p>Usando Leaflet.js con OpenStreetMap - Sin l√≠mites de uso - 100% Gratis para siempre</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-robos">8</div>
                            <div class="stat-label">Robos geolocalizados</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <div class="stat-number" id="total-visitas">12</div>
                            <div class="stat-label">Visitas programadas</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                            <div class="stat-number" id="municipios-activos">14</div>
                            <div class="stat-label">Municipios activos</div>
                        </div>
                    </div>
                    
                    <div class="map-controls">
                        <button class="control-btn" onclick="mostrarSeccion('mapa')">
                            <span>üó∫Ô∏è</span> Ver Mapa Gratis
                        </button>
                        <button class="control-btn secondary" onclick="obtenerUbicacionActual()">
                            <span>üìç</span> Mi Ubicaci√≥n Actual
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN MAPA LEAFLET -->
            <div id="mapa" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üó∫Ô∏è MAPA GRATUITO CON LEAFLET</h2>
                    <p>OpenStreetMap - B√∫squeda de direcciones - Geolocalizaci√≥n - Sin l√≠mites</p>
                    
                    <!-- BUSCADOR -->
                    <div class="search-box">
                        <input type="text" id="direccion-input" placeholder="Busca cualquier direcci√≥n..." class="search-input">
                        <button class="control-btn" onclick="buscarDireccionLeaflet()">
                            <span>üîç</span> Buscar
                        </button>
                    </div>
                    
                    <!-- MAPA LEAFLET -->
                    <div id="mapa-leaflet"></div>
                    
                    <!-- CONTROLES -->
                    <div class="map-controls">
                        <button class="control-btn" onclick="mostrarTodosRobosEnMapa()">
                            <span>üö®</span> Mostrar Robos
                        </button>
                        <button class="control-btn secondary" onclick="mostrarVisitasEnMapa()">
                            <span>üìÖ</span> Mostrar Visitas
                        </button>
                        <button class="control-btn" onclick="obtenerUbicacionActual()">
                            <span>üìç</span> Mi Ubicaci√≥n
                        </button>
                        <button class="control-btn warning" onclick="limpiarMapaLeaflet()">
                            <span>üóëÔ∏è</span> Limpiar Mapa
                        </button>
                    </div>
                    
                    <!-- INFO GEOLOCALIZACI√ìN -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 20px;">
                        <h3 style="color: #1e40af; margin-bottom: 15px;">üì° Estado de Geolocalizaci√≥n</h3>
                        <div id="info-geolocalizacion">
                            <p><strong>üìç Mi ubicaci√≥n:</strong> <span id="mi-ubicacion">Haz clic en "Mi Ubicaci√≥n"</span></p>
                            <p><strong>üéØ Precisi√≥n:</strong> <span id="precision-gps">-- metros</span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN ROBOS -->
            <div id="robos" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üö® ROBOS GEOLOCALIZADOS</h2>
                    <p>Incidentes reportados con ubicaci√≥n exacta</p>
                    
                    <div id="lista-robos">
                        <!-- Los robos se cargar√°n aqu√≠ -->
                    </div>
                    
                    <!-- FORMULARIO NUEVO ROBO -->
                    <div style="background: #fef2f2; padding: 25px; border-radius: 12px; margin-top: 30px;">
                        <h3 style="color: #dc2626;">üìù Reportar Nuevo Robo</h3>
                        <div class="search-box">
                            <input type="text" id="nueva-direccion-robo" placeholder="Direcci√≥n exacta..." class="search-input">
                            <button class="control-btn danger" onclick="reportarNuevoRoboLeaflet()">
                                <span>üö®</span> Reportar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN AGENDA -->
            <div id="agenda" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üìÖ AGENDA DE VISITAS</h2>
                    
                    <div id="lista-agenda">
                        <!-- Las visitas se cargar√°n aqu√≠ -->
                    </div>
                    
                    <!-- FORMULARIO NUEVA VISITA -->
                    <div style="background: #f0f9ff; padding: 25px; border-radius: 12px; margin-top: 30px;">
                        <h3 style="color: #1e40af;">‚ûï Nueva Visita</h3>
                        <div style="display: grid; gap: 15px; margin-top: 20px;">
                            <input type="text" id="cliente-visita" placeholder="Cliente..." class="search-input">
                            <input type="text" id="direccion-visita" placeholder="Direcci√≥n..." class="search-input">
                            <button class="control-btn secondary" onclick="agregarVisitaLeaflet()">
                                <span>‚úÖ</span> Agregar Visita
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN NOTAS -->
            <div id="notas" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üìù BLOC DE NOTAS</h2>
                    
                    <div id="lista-notas">
                        <!-- Las notas se cargar√°n aqu√≠ -->
                    </div>
                    
                    <!-- FORMULARIO NUEVA NOTA -->
                    <div style="background: #fef3c7; padding: 25px; border-radius: 12px; margin-top: 30px;">
                        <h3 style="color: #d97706;">‚ûï Nueva Nota</h3>
                        <div style="display: grid; gap: 15px; margin-top: 20px;">
                            <input type="text" id="titulo-nota" placeholder="T√≠tulo..." class="search-input">
                            <textarea id="contenido-nota" placeholder="Contenido..." rows="4" class="search-input"></textarea>
                            <button class="control-btn warning" onclick="agregarNotaLeaflet()">
                                <span>üíæ</span> Guardar Nota
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCI√ìN AN√ÅLISIS -->
            <div id="analisis" class="seccion" style="display: none;">
                <div class="card">
                    <h2 class="card-title">üìä AN√ÅLISIS Y ESTAD√çSTICAS</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);">
                            <div class="stat-number" id="robos-totales">24</div>
                            <div class="stat-label">Robos este mes</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                            <div class="stat-number" id="visitas-totales">48</div>
                            <div class="stat-label">Visitas programadas</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);">
                            <div class="stat-number" id="conversion-rate">68%</div>
                            <div class="stat-label">Tasa de conversi√≥n</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FOOTER -->
        <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: #cbd5e1; padding: 30px; text-align: center; margin-top: 40px;">
            <p style="font-size: 1.2rem; font-weight: 700; margin-bottom: 15px;">LOCALIZADOR GRATUITO DE ALARMAS</p>
            <p>Leaflet.js + OpenStreetMap | Sin costes | Uso ilimitado</p>
        </div>
        
        <!-- NOTIFICACI√ìN -->
        <div class="notification" id="notificacion">
            <strong id="notificacion-titulo">Notificaci√≥n</strong>
            <p id="notificacion-mensaje">Mensaje</p>
            <button onclick="cerrarNotificacion()" style="width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 8px; margin-top: 10px;">
                ‚úÖ Cerrar
            </button>
        </div>
    </div>

    <!-- JAVASCRIPT COMPLETO CON LEAFLET -->
    <script>
        // ===== VARIABLES GLOBALES =====
        let mapaLeaflet;
        let marcadores = [];
        let miUbicacionMarker;
        let geocoder;
        
        // Datos de ejemplo
        let robos = [
            {
                id: 1,
                direccion: "Calle Claudio Marcelo, 25, C√≥rdoba",
                municipio: "C√ìRDOBA",
                tipo: "Robo en vivienda",
                detalles: "Robo con fuerza. Se llevaron electr√≥nica.",
                fecha: new Date(Date.now() - 2 * 60 * 60 * 1000),
                prioridad: "alta",
                coordenadas: [37.8882, -4.7794]
            },
            {
                id: 2,
                direccion: "Calle Industria, 12, Lucena",
                municipio: "LUCENA",
                tipo: "Intento de robo",
                detalles: "Intento fallido. Detectado por vecinos.",
                fecha: new Date(Date.now() - 4 * 60 * 60 * 1000),
                prioridad: "media",
                coordenadas: [37.4088, -4.4854]
            }
        ];
        
        let agenda = [
            {
                id: 1,
                cliente: "Restaurante La Alhambra",
                direccion: "Calle Torrijos, 8, C√≥rdoba",
                municipio: "C√ìRDOBA",
                fecha: new Date(new Date().setHours(10, 0, 0, 0)),
                motivo: "Presentaci√≥n presupuesto",
                coordenadas: [37.8842, -4.7790]
            }
        ];
        
        let notas = [
            {
                id: 1,
                titulo: "Recordatorio importante",
                contenido: "Ofrecer mantenimiento anual a clientes nuevos",
                fecha: new Date()
            }
        ];
        
        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            iniciarAplicacion();
            actualizarHora();
            cargarDatos();
            mostrarNotificacion('‚úÖ Sistema listo', 'Leaflet.js cargado correctamente');
        });
        
        function iniciarAplicacion() {
            // Cargar datos en las listas
            cargarListaRobos();
            cargarListaAgenda();
            cargarListaNotas();
            actualizarEstadisticas();
        }
        
        // ===== LEAFLET MAP FUNCTIONS =====
        function inicializarMapaLeaflet() {
            // Si el mapa ya existe, solo mostrarlo
            if (mapaLeaflet) {
                mostrarSeccion('mapa');
                return;
            }
            
            // Crear mapa centrado en C√≥rdoba
            mapaLeaflet = L.map('mapa-leaflet').setView([37.8882, -4.7794], 12);
            
            // A√±adir capa de OpenStreetMap (GRATIS)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(mapaLeaflet);
            
            // Inicializar geocoder para b√∫squeda de direcciones
            geocoder = L.Control.geocoder({
                defaultMarkGeocode: false,
                position: 'topleft',
                placeholder: 'Buscar direcci√≥n...',
                errorMessage: 'Direcci√≥n no encontrada'
            }).addTo(mapaLeaflet);
            
            // Configurar eventos del geocoder
            geocoder.on('markgeocode', function(e) {
                const latlng = e.geocode.center;
                mapaLeaflet.setView(latlng, 16);
                
                // A√±adir marcador
                const marker = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'robo-marker',
                        html: '<div style="background: #3b82f6; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white;"></div>',
                        iconSize: [30, 30]
                    })
                }).addTo(mapaLeaflet)
                .bindPopup(`<b>üìç Direcci√≥n encontrada</b><br>${e.geocode.name}`)
                .openPopup();
                
                marcadores.push(marker);
                
                mostrarNotificacion('üìç Direcci√≥n encontrada', e.geocode.name);
            });
            
            // A√±adir controles b√°sicos
            L.control.scale().addTo(mapaLeaflet);
            L.control.locate({
                position: 'topright',
                strings: {
                    title: "Mostrar mi ubicaci√≥n"
                }
            }).addTo(mapaLeaflet);
            
            // Mostrar robos iniciales en el mapa
            agregarRobosAlMapa();
            
            mostrarNotificacion('üó∫Ô∏è Mapa cargado', 'OpenStreetMap listo para usar');
        }
        
        function buscarDireccionLeaflet() {
            const direccion = document.getElementById('direccion-input').value;
            if (!direccion.trim()) {
                mostrarNotificacion('‚ö†Ô∏è Campo vac√≠o', 'Escribe una direcci√≥n');
                return;
            }
            
            // Usar el geocoder de Leaflet
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion + ', C√≥rdoba, Espa√±a')}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const resultado = data[0];
                        const lat = parseFloat(resultado.lat);
                        const lon = parseFloat(resultado.lon);
                        
                        // Centrar mapa
                        mapaLeaflet.setView([lat, lon], 16);
                        
                        // A√±adir marcador
                        const marker = L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: '<div style="background: #3b82f6; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">üìç</div>',
                                iconSize: [30, 30]
                            })
                        }).addTo(mapaLeaflet)
                        .bindPopup(`<b>üìç ${direccion}</b><br>Lat: ${lat.toFixed(6)}<br>Lon: ${lon.toFixed(6)}`)
                        .openPopup();
                        
                        marcadores.push(marker);
                        
                        // Actualizar informaci√≥n
                        document.getElementById('mi-ubicacion').textContent = direccion;
                        
                        mostrarNotificacion('‚úÖ Direcci√≥n encontrada', resultado.display_name);
                    } else {
                        mostrarNotificacion('‚ùå No encontrado', 'Direcci√≥n no encontrada');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarNotificacion('‚ùå Error', 'No se pudo buscar la direcci√≥n');
                });
        }
        
        function agregarRobosAlMapa() {
            robos.forEach(robo => {
                if (robo.coordenadas && robo.coordenadas.length === 2) {
                    const color = robo.prioridad === 'alta' ? '#dc2626' : 
                                 robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
                    
                    const marker = L.marker(robo.coordenadas, {
                        icon: L.divIcon({
                            className: 'robo-marker',
                            html: `<div style="background: ${color}; width: 30px; height: 30px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; position: relative;">
                                     <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg); color: white; font-weight: bold;">!</span>
                                   </div>`,
                            iconSize: [30, 30]
                        })
                    }).addTo(mapaLeaflet)
                    .bindPopup(`
                        <div style="min-width: 250px;">
                            <h3 style="margin: 0 0 10px 0; color: ${color};">üö® ${robo.tipo}</h3>
                            <p><strong>üìç ${robo.direccion}</strong></p>
                            <p><strong>üèòÔ∏è ${robo.municipio}</strong></p>
                            <p><strong>üìù ${robo.detalles}</strong></p>
                            <p><strong>üïí ${formatearTiempoRelativo(robo.fecha)}</strong></p>
                            <button onclick="navegarAUbicacion(${robo.coordenadas[0]}, ${robo.coordenadas[1]})" style="
                                background: ${color};
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                                width: 100%;
                                margin-top: 10px;
                            ">
                                üó∫Ô∏è Navegar aqu√≠
                            </button>
                        </div>
                    `);
                    
                    marcadores.push(marker);
                }
            });
        }
        
        function mostrarTodosRobosEnMapa() {
            if (!mapaLeaflet) {
                inicializarMapaLeaflet();
                return;
            }
            
            // Limpiar marcadores existentes
            limpiarMarcadores();
            
            // A√±adir robos
            agregarRobosAlMapa();
            
            // Ajustar vista para mostrar todos los robos
            const grupo = L.featureGroup(marcadores);
            mapaLeaflet.fitBounds(grupo.getBounds().pad(0.1));
            
            mostrarNotificacion('üö® Mostrando robos', `${robos.length} robos en el mapa`);
        }
        
        function mostrarVisitasEnMapa() {
            if (!mapaLeaflet) {
                inicializarMapaLeaflet();
                return;
            }
            
            // Limpiar marcadores existentes
            limpiarMarcadores();
            
            // A√±adir visitas
            agenda.forEach(visita => {
                if (visita.coordenadas && visita.coordenadas.length === 2) {
                    const marker = L.marker(visita.coordenadas, {
                        icon: L.divIcon({
                            className: 'visita-marker',
                            html: '<div style="background: #10b981; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">üìÖ</div>',
                            iconSize: [25, 25]
                        })
                    }).addTo(mapaLeaflet)
                    .bindPopup(`
                        <div style="min-width: 250px;">
                            <h3 style="margin: 0 0 10px 0; color: #10b981;">üìÖ ${visita.cliente}</h3>
                            <p><strong>üìç ${visita.direccion}</strong></p>
                            <p><strong>üèòÔ∏è ${visita.municipio}</strong></p>
                            <p><strong>üìù ${visita.motivo}</strong></p>
                            <button onclick="navegarAUbicacion(${visita.coordenadas[0]}, ${visita.coordenadas[1]})" style="
                                background: #10b981;
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                                width: 100%;
                                margin-top: 10px;
                            ">
                                üó∫Ô∏è Navegar a visita
                            </button>
                        </div>
                    `);
                    
                    marcadores.push(marker);
                }
            });
            
            // Ajustar vista
            if (marcadores.length > 0) {
                const grupo = L.featureGroup(marcadores);
                mapaLeaflet.fitBounds(grupo.getBounds().pad(0.1));
            }
            
            mostrarNotificacion('üìÖ Mostrando visitas', `${agenda.length} visitas en el mapa`);
        }
        
        function obtenerUbicacionActual() {
            if (!navigator.geolocation) {
                mostrarNotificacion('‚ùå No soportado', 'Tu navegador no soporta geolocalizaci√≥n');
                return;
            }
            
            mostrarNotificacion('üìç Buscando ubicaci√≥n', 'Obteniendo tu posici√≥n...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const precision = position.coords.accuracy;
                    
                    // Inicializar mapa si no existe
                    if (!mapaLeaflet) {
                        inicializarMapaLeaflet();
                    }
                    
                    // Centrar mapa en la ubicaci√≥n
                    mapaLeaflet.setView([lat, lng], 16);
                    
                    // Eliminar marcador anterior si existe
                    if (miUbicacionMarker) {
                        mapaLeaflet.removeLayer(miUbicacionMarker);
                    }
                    
                    // Crear nuevo marcador
                    miUbicacionMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'mi-ubicacion-marker',
                            html: '<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>',
                            iconSize: [20, 20]
                        })
                    }).addTo(mapaLeaflet)
                    .bindPopup(`<b>üìç Mi ubicaci√≥n actual</b><br>Precisi√≥n: ${Math.round(precision)} metros`)
                    .openPopup();
                    
                    // Obtener direcci√≥n desde coordenadas
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                        .then(response => response.json())
                        .then(data => {
                            const direccion = data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                            document.getElementById('mi-ubicacion').textContent = direccion;
                            document.getElementById('precision-gps').textContent = `${Math.round(precision)} metros`;
                            
                            miUbicacionMarker.bindPopup(`<b>üìç Mi ubicaci√≥n actual</b><br>${direccion}<br>Precisi√≥n: ${Math.round(precision)} metros`).openPopup();
                            
                            mostrarNotificacion('‚úÖ Ubicaci√≥n encontrada', direccion);
                        });
                },
                function(error) {
                    console.error('Error:', error);
                    mostrarNotificacion('‚ùå Error', 'No se pudo obtener tu ubicaci√≥n');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        function limpiarMapaLeaflet() {
            // Eliminar todos los marcadores
            marcadores.forEach(marker => {
                mapaLeaflet.removeLayer(marker);
            });
            marcadores = [];
            
            // Eliminar marcador de ubicaci√≥n
            if (miUbicacionMarker) {
                mapaLeaflet.removeLayer(miUbicacionMarker);
                miUbicacionMarker = null;
            }
            
            mostrarNotificacion('üóëÔ∏è Mapa limpiado', 'Todos los marcadores eliminados');
        }
        
        function limpiarMarcadores() {
            marcadores.forEach(marker => {
                mapaLeaflet.removeLayer(marker);
            });
            marcadores = [];
        }
        
        // ===== FUNCIONES DE NAVEGACI√ìN =====
        function navegarAUbicacion(lat, lng) {
            // Abrir Google Maps con la ubicaci√≥n
            const url = `https://www.google.com/maps?q=${lat},${lng}`;
            window.open(url, '_blank');
            mostrarNotificacion('üó∫Ô∏è Navegaci√≥n', 'Abriendo Google Maps...');
        }
        
        // ===== GESTI√ìN DE DATOS =====
        function cargarDatos() {
            // Cargar desde localStorage si existe
            try {
                const robosGuardados = localStorage.getItem('localizador_robos');
                const agendaGuardada = localStorage.getItem('localizador_agenda');
                const notasGuardadas = localStorage.getItem('localizador_notas');
                
                if (robosGuardados) {
                    robos = JSON.parse(robosGuardados);
                    robos.forEach(r => r.fecha = new Date(r.fecha));
                }
                
                if (agendaGuardada) {
                    agenda = JSON.parse(agendaGuardada);
                    agenda.forEach(a => a.fecha = new Date(a.fecha));
                }
                
                if (notasGuardadas) {
                    notas = JSON.parse(notasGuardadas);
                    notas.forEach(n => n.fecha = new Date(n.fecha));
                }
            } catch (e) {
                console.error('Error cargando datos:', e);
            }
        }
        
        function guardarDatos() {
            try {
                localStorage.setItem('localizador_robos', JSON.stringify(robos));
                localStorage.setItem('localizador_agenda', JSON.stringify(agenda));
                localStorage.setItem('localizador_notas', JSON.stringify(notas));
            } catch (e) {
                console.error('Error guardando datos:', e);
            }
        }
        
        // ===== FUNCIONES DE INTERFAZ =====
        function mostrarSeccion(seccion) {
            // Ocultar todas las secciones
            document.querySelectorAll('.seccion').forEach(s => {
                s.style.display = 'none';
            });
            
            // Remover active de todas las pesta√±as
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
            });
            
            // Mostrar secci√≥n seleccionada
            document.getElementById(seccion).style.display = 'block';
            
            // Marcar pesta√±a como activa
            event.target.classList.add('active');
            
            // Inicializar mapa si es necesario
            if (seccion === 'mapa') {
                setTimeout(inicializarMapaLeaflet, 100);
            }
            
            // Actualizar datos espec√≠ficos
            if (seccion === 'robos') {
                cargarListaRobos();
            } else if (seccion === 'agenda') {
                cargarListaAgenda();
            } else if (seccion === 'notas') {
                cargarListaNotas();
            } else if (seccion === 'analisis') {
                actualizarEstadisticas();
            }
        }
        
        function cargarListaRobos() {
            const contenedor = document.getElementById('lista-robos');
            if (!contenedor) return;
            
            if (robos.length === 0) {
                contenedor.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No hay robos reportados</p>';
                return;
            }
            
            let html = '';
            robos.forEach(robo => {
                const color = robo.prioridad === 'alta' ? '#dc2626' : 
                             robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
                
                html += `
                    <div class="robo-alert" onclick="mostrarRoboEnMapa(${robo.id})">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0; color: ${color};">üö® ${robo.tipo}</h3>
                            <span style="background: ${color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                ${robo.prioridad.toUpperCase()}
                            </span>
                        </div>
                        <p><strong>üìç ${robo.direccion}</strong></p>
                        <p><strong>üèòÔ∏è ${robo.municipio}</strong></p>
                        <div style="margin: 10px 0;">${robo.detalles}</div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button onclick="event.stopPropagation(); navegarAUbicacion(${robo.coordenadas[0]}, ${robo.coordenadas[1]})" style="
                                background: ${color};
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">
                                üó∫Ô∏è Navegar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function cargarListaAgenda() {
            const contenedor = document.getElementById('lista-agenda');
            if (!contenedor) return;
            
            if (agenda.length === 0) {
                contenedor.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No hay visitas programadas</p>';
                return;
            }
            
            let html = '';
            agenda.forEach(visita => {
                html += `
                    <div class="cita-item">
                        <h3 style="margin: 0 0 10px 0; color: #1e40af;">${visita.cliente}</h3>
                        <p><strong>üìç ${visita.direccion}</strong></p>
                        <p><strong>üèòÔ∏è ${visita.municipio}</strong></p>
                        <p><strong>üìù ${visita.motivo}</strong></p>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button onclick="navegarAUbicacion(${visita.coordenadas[0]}, ${visita.coordenadas[1]})" style="
                                background: #10b981;
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">
                                üó∫Ô∏è Navegar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function cargarListaNotas() {
            const contenedor = document.getElementById('lista-notas');
            if (!contenedor) return;
            
            if (notas.length === 0) {
                contenedor.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">No hay notas</p>';
                return;
            }
            
            let html = '';
            notas.forEach(nota => {
                html += `
                    <div class="note-item">
                        <h3 style="margin: 0 0 10px 0; color: #d97706;">${nota.titulo}</h3>
                        <div style="white-space: pre-line;">${nota.contenido}</div>
                        <div style="color: #6b7280; font-size: 0.9rem; margin-top: 10px;">
                            ${nota.fecha.toLocaleDateString()}
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        function reportarNuevoRoboLeaflet() {
            const direccion = document.getElementById('nueva-direccion-robo').value;
            if (!direccion.trim()) {
                mostrarNotificacion('‚ö†Ô∏è Campo vac√≠o', 'Escribe una direcci√≥n');
                return;
            }
            
            // Geocodificar la direcci√≥n
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion + ', C√≥rdoba, Espa√±a')}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const resultado = data[0];
                        const lat = parseFloat(resultado.lat);
                        const lon = parseFloat(resultado.lon);
                        
                        // Crear nuevo robo
                        const nuevoRobo = {
                            id: Date.now(),
                            direccion: direccion,
                            municipio: "C√ìRDOBA",
                            tipo: "Robo reportado",
                            detalles: "Incidente reportado por usuario",
                            fecha: new Date(),
                            prioridad: "media",
                            coordenadas: [lat, lon]
                        };
                        
                        // A√±adir a la lista
                        robos.unshift(nuevoRobo);
                        
                        // Actualizar interfaz
                        cargarListaRobos();
                        actualizarEstadisticas();
                        
                        // A√±adir al mapa si est√° activo
                        if (mapaLeaflet) {
                            agregarRoboAlMapa(nuevoRobo);
                        }
                        
                        // Guardar datos
                        guardarDatos();
                        
                        // Limpiar formulario
                        document.getElementById('nueva-direccion-robo').value = '';
                        
                        mostrarNotificacion('üö® Robo reportado', 'Nuevo incidente a√±adido');
                    } else {
                        mostrarNotificacion('‚ùå No encontrado', 'Direcci√≥n no v√°lida');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarNotificacion('‚ùå Error', 'No se pudo procesar la direcci√≥n');
                });
        }
        
        function agregarRoboAlMapa(robo) {
            if (!mapaLeaflet || !robo.coordenadas) return;
            
            const color = robo.prioridad === 'alta' ? '#dc2626' : 
                         robo.prioridad === 'media' ? '#f59e0b' : '#10b981';
            
            const marker = L.marker(robo.coordenadas, {
                icon: L.divIcon({
                    className: 'robo-marker',
                    html: `<div style="background: ${color}; width: 30px; height: 30px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; position: relative;">
                             <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg); color: white; font-weight: bold;">!</span>
                           </div>`,
                    iconSize: [30, 30]
                })
            }).addTo(mapaLeaflet)
            .bindPopup(`
                <div style="min-width: 250px;">
                    <h3 style="margin: 0 0 10px 0; color: ${color};">üö® ${robo.tipo}</h3>
                    <p><strong>üìç ${robo.direccion}</strong></p>
                    <button onclick="navegarAUbicacion(${robo.coordenadas[0]}, ${robo.coordenadas[1]})" style="
                        background: ${color};
                        color: white;
                        border: none;
                        padding: 8px 15px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: bold;
                        width: 100%;
                        margin-top: 10px;
                    ">
                        üó∫Ô∏è Navegar aqu√≠
                    </button>
                </div>
            `);
            
            marcadores.push(marker);
        }
        
        function agregarVisitaLeaflet() {
            const cliente = document.getElementById('cliente-visita').value;
            const direccion = document.getElementById('direccion-visita').value;
            
            if (!cliente || !direccion) {
                mostrarNotificacion('‚ö†Ô∏è Campos vac√≠os', 'Completa todos los campos');
                return;
            }
            
            // Geocodificar la direcci√≥n
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion + ', C√≥rdoba, Espa√±a')}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const resultado = data[0];
                        const lat = parseFloat(resultado.lat);
                        const lon = parseFloat(resultado.lon);
                        
                        // Crear nueva visita
                        const nuevaVisita = {
                            id: Date.now(),
                            cliente: cliente,
                            direccion: direccion,
                            municipio: "C√ìRDOBA",
                            fecha: new Date(),
                            motivo: "Visita programada",
                            coordenadas: [lat, lon]
                        };
                        
                        // A√±adir a la lista
                        agenda.unshift(nuevaVisita);
                        
                        // Actualizar interfaz
                        cargarListaAgenda();
                        actualizarEstadisticas();
                        
                        // Guardar datos
                        guardarDatos();
                        
                        // Limpiar formulario
                        document.getElementById('cliente-visita').value = '';
                        document.getElementById('direccion-visita').value = '';
                        
                        mostrarNotificacion('‚úÖ Visita a√±adida', 'Nueva visita programada');
                    } else {
                        mostrarNotificacion('‚ùå No encontrado', 'Direcci√≥n no v√°lida');
                    }
                });
        }
        
        function agregarNotaLeaflet() {
            const titulo = document.getElementById('titulo-nota').value;
            const contenido = document.getElementById('contenido-nota').value;
            
            if (!titulo || !contenido) {
                mostrarNotificacion('‚ö†Ô∏è Campos vac√≠os', 'Completa t√≠tulo y contenido');
                return;
            }
            
            // Crear nueva nota
            const nuevaNota = {
                id: Date.now(),
                titulo: titulo,
                contenido: contenido,
                fecha: new Date()
            };
            
            // A√±adir a la lista
            notas.unshift(nuevaNota);
            
            // Actualizar interfaz
            cargarListaNotas();
            
            // Guardar datos
            guardarDatos();
            
            // Limpiar formulario
            document.getElementById('titulo-nota').value = '';
            document.getElementById('contenido-nota').value = '';
            
            mostrarNotificacion('üìù Nota guardada', 'Nueva nota a√±adida');
        }
        
        function mostrarRoboEnMapa(id) {
            const robo = robos.find(r => r.id === id);
            if (!robo || !robo.coordenadas) return;
            
            // Mostrar secci√≥n de mapa
            mostrarSeccion('mapa');
            
            // Inicializar mapa si no est√°
            if (!mapaLeaflet) {
                inicializarMapaLeaflet();
            }
            
            // Centrar en el robo
            setTimeout(() => {
                mapaLeaflet.setView(robo.coordenadas, 16);
                
                // Encontrar y abrir el popup del marcador
                marcadores.forEach(marker => {
                    const pos = marker.getLatLng();
                    if (Math.abs(pos.lat - robo.coordenadas[0]) < 0.0001 &&
                        Math.abs(pos.lng - robo.coordenadas[1]) < 0.0001) {
                        marker.openPopup();
                    }
                });
            }, 500);
        }
        
        function actualizarEstadisticas() {
            document.getElementById('total-robos').textContent = robos.length;
            document.getElementById('total-visitas').textContent = agenda.length;
            document.getElementById('municipios-activos').textContent = [...new Set(robos.map(r => r.municipio))].length;
            document.getElementById('robos-totales').textContent = robos.length;
            document.getElementById('visitas-totales').textContent = agenda.length;
        }
        
        // ===== FUNCIONES UTILITARIAS =====
        function formatearTiempoRelativo(fecha) {
            const ahora = new Date();
            const diferencia = ahora - new Date(fecha);
            
            const segundos = Math.floor(diferencia / 1000);
            const minutos = Math.floor(segundos / 60);
            const horas = Math.floor(minutos / 60);
            const dias = Math.floor(horas / 24);
            
            if (dias > 0) return `Hace ${dias} d√≠a${dias === 1 ? '' : 's'}`;
            if (horas > 0) return `Hace ${horas} hora${horas === 1 ? '' : 's'}`;
            if (minutos > 0) return `Hace ${minutos} minuto${minutos === 1 ? '' : 's'}`;
            return 'Ahora mismo';
        }
        
        function actualizarHora() {
            const ahora = new Date();
            const hora = ahora.getHours().toString().padStart(2, '0');
            const minutos = ahora.getMinutes().toString().padStart(2, '0');
            document.getElementById('hora-actual').textContent = `${hora}:${minutos}`;
            setTimeout(actualizarHora, 60000);
        }
        
        function mostrarNotificacion(titulo, mensaje) {
            const notificacion = document.getElementById('notificacion');
            const tituloElem = document.getElementById('notificacion-titulo');
            const mensajeElem = document.getElementById('notificacion-mensaje');
            
            tituloElem.textContent = titulo;
            mensajeElem.textContent = mensaje;
            notificacion.style.display = 'block';
            
            setTimeout(cerrarNotificacion, 5000);
        }
        
        function cerrarNotificacion() {
            document.getElementById('notificacion').style.display = 'none';
        }
    </script>
</body>
</html>
